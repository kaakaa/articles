---
title: "[Mattermost Integrations] REST API"
date: 2020-12-10T00:00:00+09:00
emoji: "ğŸ“†"
type: "tech"
topics: ["Mattermost"]
published: true
aliases: "/post/mattermost/advent-calendar-2020/day10-rest-api"
---

Mattermost è¨˜äº‹ã¾ã¨ã‚: https://blog.kaakaa.dev/tags/mattermost/

## æœ¬è¨˜äº‹ã«ã¤ã„ã¦

[Mattermost ã®çµ±åˆæ©Ÿèƒ½ã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼](https://qiita.com/advent-calendar/2020/mattermost-integrations)ã®ç¬¬ 10 æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚

æœ¬è¨˜äº‹ã§ã¯ã€Mattermost ã® REST API ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã™ã€‚

## REST API ã®æ¦‚è¦

Mattermost ã«ã¯çµ±åˆæ©Ÿèƒ½ã‚’ä½œæˆã™ã‚‹ãŸã‚ã®æ§˜ã€…ãªæ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ãŒã€ä¸€èˆ¬çš„ãª REST API ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
Mattermost ã§åˆ©ç”¨å¯èƒ½ãª REST API ã¯ã€ä¸‹è¨˜ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¾ã¨ã¾ã£ã¦ã„ã¾ã™ã€‚

https://api.mattermost.com/

## Access Token (Personal Access Token)

REST API ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€API å®Ÿè¡Œæ¨©é™ã‚’ä¿æŒã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¤ºã™ãŸã‚ã® Token ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚Mattermost ã§ã¯ã„ãã¤ã‹ Token ã‚’å–å¾—ã™ã‚‹æ–¹æ³•ãŒã‚ã‚Šã¾ã™ãŒã€ã“ã“ã§ã¯æœ€ã‚‚æ‰‹è»½ã«ä½¿ãˆã‚‹ Personal Access Token ã‚’ç”Ÿæˆã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã™ã€‚

Personal Access Token ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ã€**ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ³ã‚½ãƒ¼ãƒ« > çµ±åˆæ©Ÿèƒ½ > çµ±åˆæ©Ÿèƒ½ç®¡ç† > ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹**ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

![config pat](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day10/config-pat.png)

### Personal Access Token ç”Ÿæˆ

**ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ > ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®è¨­å®š > ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ > ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ > ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆã™ã‚‹**ã‚’å®Ÿè¡Œã—ã€ç”Ÿæˆã™ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã®èª¬æ˜ã‚’å…¥åŠ›ã™ã‚‹ã“ã¨ã§ Personal Access Token ã‚’ç”Ÿæˆã§ãã¾ã™ã€‚

![create pat](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day10/create-pat.png)

Personal Access Token ã®ç”Ÿæˆã«æˆåŠŸã™ã‚‹ã¨ã€ç”»é¢ã«ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã“ã“ã§**ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³**ã¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹æ–‡å­—åˆ—ã‚’ä½¿ã£ã¦ REST API ã®å‘¼ã³å‡ºã—ã‚’è¡Œã„ã¾ã™ã€‚(**ãƒˆãƒ¼ã‚¯ãƒ³ ID**ã¯ã€Mattermost å†…éƒ¨ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¸€æ„ã«è­˜åˆ¥ã™ã‚‹ãŸã‚ã® ID ã§ã‚ã‚Šã€REST API ã®å®Ÿè¡Œã«åˆ©ç”¨ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“)

![complete pat](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day10/complete-pat.png)

### REST API å®Ÿè¡Œ

å…ˆã»ã©ç”Ÿæˆã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’ Authorization ãƒ˜ãƒƒãƒ€ãƒ¼ã«æŒ‡å®šã—ã€`/api/v4/users/me`ã® API ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ã‚’å–å¾—ã™ã‚‹ API ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```bash
$ curl -i \
>   -H 'Authorization: Bearer 4cacdozwn3fndnzobbpha3nnhy' \
>   http://localhost:8065/api/v4/users/me
HTTP/1.1 200 OK
Content-Type: application/json
Etag: 5.30.0.87x93uo8pfnzdro9ktcmobpa1r.1606000641083..0.true.true.0
Expires: 0
Vary: Accept-Encoding
X-Request-Id: qws4oo9dyjy8pxs48kaqd86goh
X-Version-Id: 5.30.0.dev.3fbba2b2e9e21536fd2bdc547afe31fd.false
Date: Sun, 22 Nov 2020 05:33:58 GMT
Content-Length: 774

{"id":"87x93uo8pfnzdro9ktcmobpa1r","create_at":1598680540414,"update_at":1606000641083,"delete_at":0,"username":"kaakaa","auth_data":"","auth_service":"","email":"kaakaa@example.com","nickname":"","first_name":"","last_name":"","position":"","roles":"system_user system_admin","allow_marketing":true,"notify_props":{"auto_responder_active":"false","auto_responder_message":"ãŸã ã„ã¾å¤–å‡ºä¸­ã®ãŸã‚è¿”ä¿¡ã§ãã¾ã›ã‚“ã€‚","channel":"true","comments":"never","desktop":"all","desktop_notification_sound":"Bing","desktop_sound":"true","email":"true","first_name":"false","mention_keys":"","push":"mention","push_status":"away"},"last_password_update":1598680540414,"locale":"ja","timezone":{"automaticTimezone":"","manualTimezone":"","useAutomaticTimezone":"true"}}
```

## REST API å®Ÿè¡Œ

REST API ã¯ç¨®é¡ãŒå¤šã„ãŸã‚ã€ä¸€éƒ¨ã®ã¿å®Ÿè¡Œæ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

### REST API ã‹ã‚‰æŠ•ç¨¿ã‚’ä½œæˆã™ã‚‹

REST API ã‚’ä½¿ã£ã¦ Mattermost ã«æŠ•ç¨¿ã‚’ä½œæˆã™ã‚‹ã«ã¯`/posts`ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚ã¾ãŸã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ JSON å½¢å¼ã®ãŸã‚`Content-Type`ãƒ˜ãƒƒãƒ€ãƒ¼ã«`application/json`ã‚’æŒ‡å®šã—ã€ä¸‹è¨˜ã®ã‚ˆã†ã« API ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§æŠ•ç¨¿ã‚’ä½œæˆã§ãã¾ã™ã€‚

```bash
BODY='{
  "channel_id": "uoxmk8819pyftybx6zqkij37ce",
  "message": "Create post by REST API"
}'

curl -i \
  -H 'Authorization: Bearer 4cacdozwn3fndnzobbpha3nnhy' \
  -H 'Content-Type: application/json' \
  -d "$BODY" \
  http://localhost:8065/api/v4/posts
```

![use rest api](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day10/example-rest.png)

ä»¥ä¸‹ã®ã‚ˆã†ã«`props`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«`attachments`ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ Message Attachments ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

```bash
BODY='{
  "channel_id": "uoxmk8819pyftybx6zqkij37ce",
  "message": "Create post by REST API",
  "props": {
    "attachments": [{
      "text": "hoge"
    }]
  }
}'
```

![use rest api](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day10/example-rest2.png)

### çµ±è¨ˆæƒ…å ±ã‚’å–å¾—ã™ã‚‹

`/analytics/old`ã§ã¯ Mattermost ã®çµ±è¨ˆæƒ…å ±ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```bash
$ curl \
>   -H 'Authorization: Bearer 4cacdozwn3fndnzobbpha3nnhy' \
>   http://localhost:8065/api/v4/analytics/old
[
  {
    "name": "channel_open_count",
    "value": 9
  },
  {
    "name": "channel_private_count",
    "value": 1
  },
  {
    "name": "post_count",
    "value": 3696
  },
  {
    "name": "unique_user_count",
    "value": 3
  },
  {
    "name": "team_count",
    "value": 1
  },
  {
    "name": "total_websocket_connections",
    "value": 3
  },
  {
    "name": "total_master_db_connections",
    "value": 7
  },
  {
    "name": "total_read_db_connections",
    "value": 0
  },
  {
    "name": "daily_active_users",
    "value": 1
  },
  {
    "name": "monthly_active_users",
    "value": 2
  },
  {
    "name": "inactive_user_count",
    "value": 0
  }
]
```

name ã‚¯ã‚¨ãƒªã«ã‚ˆã‚Šå–å¾—ã™ã‚‹çµ±è¨ˆæƒ…å ±ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ä¾‹ãˆã°ã€`?name=post_counts_day`ã§ã¯ã€ã“ã“ä¸€é€±é–“ã®æ—¥ã”ã¨ã®æŠ•ç¨¿æ•°ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ï¼ˆå–å¾—ã™ã‚‹æœŸé–“ã®æŒ‡å®šãªã©ã«ã¯å¯¾å¿œã—ã¦ã„ãªã„ã‚ˆã†ã§ã™ï¼‰

```bash
$ curl \
>   -H 'Authorization: Bearer 4cacdozwn3fndnzobbpha3nnhy' \
>   http://localhost:8065/api/v4/analytics/old?name=post_counts_day
[
  {
    "name": "2020-11-19",
    "value": 11
  },
  {
    "name": "2020-11-07",
    "value": 15
  },
  {
    "name": "2020-11-04",
    "value": 29
  },
  {
    "name": "2020-11-03",
    "value": 41
  },
  {
    "name": "2020-11-02",
    "value": 5
  },
  {
    "name": "2020-11-01",
    "value": 17
  },
  {
    "name": "2020-10-31",
    "value": 25
  }
]
```

## ãã®ä»–

### API å®Ÿè¡Œå›æ•°ã®åˆ¶é™

å¤§é‡ã® API ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡¦ç†ã«ã‚ˆã‚‹é«˜è² è·çŠ¶æ…‹ã‚’é¿ã‘ã‚‹ãŸã‚ã«ã€REST API ã®é »åº¦åˆ¶é™(Rate Limit)ã‚’ã‹ã‘ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚**ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ³ã‚½ãƒ¼ãƒ« > ç’°å¢ƒ > æŠ•ç¨¿é »åº¦åˆ¶é™**ã‹ã‚‰è¨­å®šã‚’è¡Œãˆã¾ã™ã€‚

![config rate limit](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day10/config-rate-limit.png)

### å„è¨€èªå‘ã‘ Drivers

Mattermost REST API ã«ã¯å„è¨€èªå‘ã‘ã® Driver ãŒå­˜åœ¨ã—ã¾ã™ã€‚Go ã¨ Javascript ã«ã¤ã„ã¦ã¯ã€Mattermost ãŒå…¬å¼ã«ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚
https://api.mattermost.com/#tag/drivers

- Go(å…¬å¼): https://github.com/mattermost/mattermost-server/blob/master/model/client4.go
- Javascript(å…¬å¼): https://github.com/mattermost/mattermost-redux/blob/master/src/client/client4.ts
- Python: https://github.com/Vaelor/python-mattermost-driver
- PHP: https://github.com/gnello/php-mattermost-driver
- Java: https://github.com/maruTA-bis5/mattermost4j

## ã•ã„ã”ã«

Mattermost REST API ã®ä½¿ã„æ–¹ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã—ãŸã€‚
æ˜æ—¥ã¯ã€WebSocket API ã®ä½¿ã„æ–¹ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚
