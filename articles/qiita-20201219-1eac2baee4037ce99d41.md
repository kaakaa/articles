---
title: "[Mattermost Integrations] Plugin (Server API)"
date: 2020-12-19T00:00:00+09:00
emoji: "ğŸ“†"
type: "tech"
topics: ["Mattermost"]
published: true
aliases: "/post/mattermost/advent-calendar-2020/day19-plugin-server-api"
---

Mattermost è¨˜äº‹ã¾ã¨ã‚: https://blog.kaakaa.dev/tags/mattermost/

## æœ¬è¨˜äº‹ã«ã¤ã„ã¦

[Mattermost ã®çµ±åˆæ©Ÿèƒ½ã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼](https://qiita.com/advent-calendar/2020/mattermost-integrations)ã®ç¬¬ 19 æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚

æœ¬è¨˜äº‹ã§ã¯ã€Mattermost Server Plugin ã®é–‹ç™ºã«åˆ©ç”¨ã§ãã‚‹ API ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã™ã€‚

Mattermost Plugin ã«ã¤ã„ã¦ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ä¸‹è¨˜ã«ãªã‚Šã¾ã™ã€‚
https://developers.mattermost.com/extend/plugins/overview/

## Mattermost Plugin API

Mattermost Server Plugin ã®é–‹ç™ºã«åˆ©ç”¨ã§ãã‚‹ API ã®ä¸€è¦§ã¯ä¸‹è¨˜ã«ã‚ã‚Šã¾ã™ã€‚

https://developers.mattermost.com/extend/plugins/server/reference/

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚„ãƒãƒ£ãƒ³ãƒãƒ«ã€æŠ•ç¨¿ãªã©ã®æ“ä½œã«ã¤ã„ã¦ã¯ REST API ã¨ã»ã¼åŒæ§˜ã®æ©Ÿèƒ½ã‚’æœ‰ã—ã¦ã„ã¾ã™ã€‚æ•°ãŒå¤šã„ãŸã‚å…¨ã¦ã¯ç´¹ä»‹ã—ã¾ã›ã‚“ãŒã€Server Plugin ç‰¹æœ‰ã®å‡¦ç†ã«é–¢ã™ã‚‹ API ã‚’ç´¹ä»‹ã—ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚

### GetConfig

`GetConfig`ã¯ã€Mattermost Server ã®ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®è¨­å®šæƒ…å ±ã‚’å–å¾—ã—ã¾ã™ã€‚

```go
siteURL := p.API.GetConfig().ServiceSettings.SiteURL
```

`p.API.GetConfig()`ä¸‹è¨˜ã®`OnConfigurationChange`å†…ã§å®Ÿè¡Œã—ã€Plugin æ§‹é€ ä½“ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨ã—ã¦ä¿æŒã—ã¦ãŠãã®ãŒè‰¯ã„ãã†ã§ã™ã€‚
https://github.com/mattermost/mattermost-plugin-starter-template/blob/master/server/configuration.go

### OpenInteractiveDialog

`OpenInteractiveDialog`ã¯ã€ç¬¬ 16 æ—¥ç›®ã®è¨˜äº‹ã§ã‚‚ç´¹ä»‹ã—ãŸ Interactive Dialog ã‚’ Plugin ã‹ã‚‰é–‹ããŸã‚ã® API ã§ã™ã€‚Interactive Dialog ã‚’é–‹ãã«ã¯`TriggerId`ã¨ã„ã†ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå¿…é ˆã§ã‚ã‚Šã€`TriggerId`ã¯ Slash Command å®Ÿè¡Œæ™‚ã€ã‚‚ã—ãã¯ Interactive Message Button/Menu å®Ÿè¡Œæ™‚ã«é€ä¿¡ã•ã‚Œã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰ã—ã‹å–å¾—ã§ãã¾ã›ã‚“ã€‚

ä»¥ä¸‹ã®ä¾‹ã¯ Slash Command å®Ÿè¡Œæ™‚ã« Interactive Dialog ã‚’é–‹ãã€å…¥åŠ›ã•ã‚ŒãŸæƒ…å ±ã‚’æ•´å½¢ã—ã¦æŠ•ç¨¿ã‚’ä½œæˆã™ã‚‹ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚

![](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day19/open-interactive-dialog.gif)

```go:plugin.go
func (p *SamplePlugin) ExecuteCommand(c *plugin.Context, args *model.CommandArgs) (*model.CommandResponse, *model.AppError) {
	appErr := p.API.OpenInteractiveDialog(model.OpenDialogRequest{
		TriggerId: args.TriggerId,
		URL:       fmt.Sprintf("%s/plugins/com.github.kaakaa.mattermost-plugin-starter-template/callback", *p.API.GetConfig().ServiceSettings.SiteURL),
		Dialog: model.Dialog{
			Title:       "Sample Plugin Dialog",
			SubmitLabel: "Submit",
			Elements: []model.DialogElement{
				{
					DisplayName: "ã‚¿ã‚¤ãƒˆãƒ«",
					Name:        "title",
					Placeholder: "Title",
					Type:        "text",
				},
				{
					DisplayName: "Snippet",
					Name:        "snippet",
					Type:        "textarea",
				},
			},
		},
	})
	if appErr != nil {
		return nil, appErr
	}
	return &model.CommandResponse{}, nil
}
```

Interactive Dialog ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡å…ˆã‚’

```go
		URL:       fmt.Sprintf("%s/plugins/com.github.kaakaa.mattermost-plugin-starter-template/callback", *p.API.GetConfig().ServiceSettings.SiteURL),
```

ã®ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã€Plugin ã‹ã‚‰é–‹ã„ãŸ Interactive Dialog ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ Plugin ã§å‡¦ç†ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ã“ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å—ä¿¡å…ˆã¨ã—ã¦ã€Mattermost Plugin Server Hook ã§ã‚ã‚‹`ServeHTTP`ã‚’ä½¿ã£ã¦`/callback`ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å—ã‘å–ã‚‹å‡¦ç†ã‚’è¿½åŠ ã—ã¾ã™ã€‚

````go:plugin.go
func (p *SamplePlugin) ServeHTTP(c *plugin.Context, w http.ResponseWriter, r *http.Request) {
	if r.URL.Path == "/callback" {
		defer r.Body.Close()
		request := model.SubmitDialogRequestFromJson(r.Body)
		t := request.Submission["title"]
		s := request.Submission["snippet"]
		p.API.CreatePost(&model.Post{
			UserId:    request.UserId,
			ChannelId: request.ChannelId,
			Message:   fmt.Sprintf("## %s\n\n```\n%s\n```", t, s),
		})
		return
	}
	fmt.Fprint(w, "Hello, world!")
}
````

ã“ã®ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã€Interactive Dialog ã®èµ·å‹•ã‹ã‚‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡¦ç†ã¾ã§ã‚’ Plugin ã ã‘ã§å®Œçµã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### PublishWebSocketEvent

`PublishWebSocketEvent`ã¯ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç‹¬è‡ªã® WebSoket ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡ã™ã‚‹ API ã§ã™ã€‚

`PublishWebSocketEvent`ã¯ã€3 ã¤ã®å¼•æ•°ã‚’å–ã‚Šã¾ã™ã€‚

- `event string`: WebSocket ã‚¤ãƒ™ãƒ³ãƒˆåã‚’æŒ‡å®šã—ã¾ã™ã€‚å®Ÿéš›ã«é€ä¿¡ã•ã‚Œã‚‹ WebSocket ã‚¤ãƒ™ãƒ³ãƒˆã«ã¯æ¥é ­è¾ã¨ã—ã¦`custom_<PluginID>_`ãŒä»˜ä¸ã•ã‚Œã¾ã™
- `payload map[string]interface{}`: é€ä¿¡ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã®å†…å®¹ã‚’æŒ‡å®šã—ã¾ã™
- `broadcast *model.WebsocketBroadcast`: WebSocket ã‚’é€ä¿¡ã™ã‚‹å¯¾è±¡ã‚’æŒ‡å®šã—ã¾ã™
  - [`model.WebsocketBroadcast`](https://pkg.go.dev/github.com/mattermost/mattermost-server/v5/model#WebsocketBroadcast)ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ãƒãƒ£ãƒ³ãƒãƒ«ã€ãƒãƒ¼ãƒ ã‚’æŒ‡å®šã—ãŸã‚Šã€å—ä¿¡å¯¾è±¡ã‹ã‚‰å¤–ã™ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æŒ‡å®šã—ãŸã‚Šã§ãã¾ã™

Webapp Plugin API ã®[`registerWebSocketEventHandler`](https://developers.mattermost.com/extend/plugins/webapp/reference/#registerWebSocketEventHandler)ã¨çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å†…ã§ WebSocket ã‚¤ãƒ™ãƒ³ãƒˆã«é–¢ã™ã‚‹å‡¦ç†ã‚’å®Œçµã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ã“ã®è¾ºã‚Šã®ä½¿ç”¨ä¾‹ã¯ç¬¬ 22 æ—¥ç›®ä»¥é™ã®è¨˜äº‹ã§ç´¹ä»‹ã™ã‚‹äºˆå®šã§ã™ã€‚

### SendMail

`SendMail`ã¯ã€Mattermost Plugin ã‹ã‚‰ HTML ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã™ã‚‹ API ã§ã™ã€‚ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ SMTP ã®è¨­å®šãŒå®Œäº†ã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

Slash Command ã‚’å®Ÿè¡Œã—ãŸéš›ã«ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã™ã‚‹ä¾‹ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```go:plugin.go
func (p *SamplePlugin) ExecuteCommand(c *plugin.Context, args *model.CommandArgs) (*model.CommandResponse, *model.AppError) {
	appErr := p.API.SendMail(
		"test@example.com",
		"Sample Title",
		"<h1>Mail from plugin</h1><div><p>Sample Mail</p></div>")
	if appErr != nil {
		return nil, appErr
	}

	return &model.CommandResponse{}, nil
}
```

![](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day19/send-mail.jpg)

### KVGet / KVSet

`KVGet`, `KVSet`ã¯ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã”ã¨ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸ Key Value ã‚¹ãƒˆã‚¢ã‹ã‚‰å€¤ã‚’å–å¾—ã€ã¾ãŸã¯å€¤ã‚’è¨­å®šã™ã‚‹ API ã§ã™ã€‚Key Value ã‚¹ãƒˆã‚¢ã«ã¯`[]byte`å‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ã§ãã‚‹ãŸã‚ã€æ ¼ç´ç”¨ãƒ‡ãƒ¼ã‚¿ã®æ§‹é€ ä½“ã‚’ä½œæˆã—ã€`json.Marshal`ã§`[]byte`å‹ã®ãƒ‡ãƒ¼ã‚¿åŒ–ã—ãŸã‚‚ã®ã‚’å‡ºã—å…¥ã‚Œã™ã‚‹ã®ãŒä¸»ãªä½¿ã„æ–¹ã«ãªã‚‹ã®ã§ã¯ãªã„ã‹ã¨æ€ã„ã¾ã™ã€‚

Key Value ã‚¹ãƒˆã‚¢ã‚’ä½¿ç”¨ã—ã¦ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’å®Ÿè£…ã—ãŸä¾‹ãŒä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚

![](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day19/kvget-kvset.gif)

```go:plugin.go
type counter struct {
	Count     int    `json:"count"`
	CreatedAt string `json:"created_at"`
}

func (p *SamplePlugin) ExecuteCommand(c *plugin.Context, args *model.CommandArgs) (*model.CommandResponse, *model.AppError) {
	// read data
	b, appErr := p.API.KVGet("counter")
	if appErr != nil {
		return nil, appErr
	}
	var ct counter
	if b == nil {
		// init if data is not found
		ct = counter{
			Count:     0,
			CreatedAt: time.Now().Format(time.RFC3339),
		}
	} else {
		if err := json.Unmarshal(b, &ct); err != nil {
			return nil, model.NewAppError("where", "id", nil, err.Error(), http.StatusInternalServerError)
		}
	}
	// count up
	ct.Count = ct.Count + 1
	b, err := json.Marshal(ct)
	if err != nil {
		return nil, model.NewAppError("where", "id", nil, err.Error(), http.StatusInternalServerError)
	}
	// set data
	if appErr := p.API.KVSet("counter", b); appErr != nil {
		return nil, appErr
	}

	return &model.CommandResponse{Text: fmt.Sprintf("counter: %d", ct.Count)}, nil
}
```

Key Value ã‚¹ãƒˆã‚¢ã‚’æ“ä½œã™ã‚‹ API ã¯`KVGet`, `KVSet`ä»¥å¤–ã«ã‚‚æ•°å¤šãã‚ã‚Šã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã™ã‚‹`KVDelete`ã‚„ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å†…ã§ä¿å­˜æ¸ˆã¿ã®ãƒ‡ãƒ¼ã‚¿ã®`key`ã‚’å–å¾—ã™ã‚‹`KVList`ã€æœŸé–“ã‚’æŒ‡å®šã—ã¦å€¤ã‚’æ ¼ç´ã§ãã‚‹`KVSetWithExpiry`ãªã©ãŒã‚ã‚Šã¾ã™ã€‚ã¾ãŸã€åŒæ™‚ã«`KVSet`ãŒå®Ÿè¡Œã•ã‚ŒãŸå ´åˆã«ä¸æ•´åˆãŒèµ·ããªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã€Atomic ãª Key Value ã‚¹ãƒˆã‚¢ã®æ“ä½œã‚’å¼·åˆ¶ã™ã‚‹ãŸã‚ã®`KVCompareAndSet`ãªã©ã‚‚ã‚ã‚Šã¾ã™ã€‚

API ã®ä¸€è¦§ã«ã¤ã„ã¦ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
https://developers.mattermost.com/extend/plugins/server/reference/

## Helpers

Mattermost Plugin API ã¯æ•°å¤šãã‚ã‚‹ãŸã‚ã€Mattermost ã«å¯¾ã™ã‚‹ã»ã¨ã‚“ã©ã®æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã¯ã§ãã¾ã™ãŒã€ã‚ˆã‚Šç°¡å˜ã« Plugin API ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã® Helper é–¢æ•°ãŒã„ãã¤ã‹å­˜åœ¨ã—ã¾ã™ã€‚

ã“ã“ã§ã¯ã€Helper é–¢æ•°ã®ã†ã¡ä¸€éƒ¨ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

Helper é–¢æ•°ã®ä¸€è¦§ã¯ä¸‹è¨˜ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ã‚Šã¾ã™ã€‚
https://developers.mattermost.com/extend/plugins/server/reference/#Helpers

### KVGetJSON / KVSetJSON

å…ˆã»ã©ã®`KVGet`ã€`KVSet`ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€æ§‹é€ ä½“ã‚’`[]byte`ã«å¤‰æ›ã™ã‚‹ãŸã‚ã«`KVSet`ã‚’å‘¼ã¶å‰ã«`json.Marshal`ã‚’ã€`KVGet`ã‚’å‘¼ã‚“ã å¾Œã«`json.Unmarshal`ã‚’å‘¼ã‚“ã§ã„ã¾ã—ãŸãŒã€`KVGetJSON`ã€`KVSetJSON`ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ãã®å¿…è¦ãŒãªããªã‚Šã¾ã™ã€‚

ãã®ãŸã‚ã€å…ˆã»ã©ã®å‡¦ç†ã‚’å¤šå°‘ã™ã£ãã‚Šã¨æ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚

```go:plugin.go
type counter struct {
	Count     int    `json:"count"`
	CreatedAt string `json:"created_at"`
}

func (p *SamplePlugin) ExecuteCommand(c *plugin.Context, args *model.CommandArgs) (*model.CommandResponse, *model.AppError) {
	// read data
	var ct counter
	exists, err := p.Helpers.KVGetJSON("counter", &ct)
	if err != nil {
		return nil, model.NewAppError("where", "id", nil, err.Error(), http.StatusInternalServerError)
	}
	if !exists {
		ct = counter{
			Count:     0,
			CreatedAt: time.Now().Format(time.RFC3339),
		}
	}

	// count up
	ct.Count = ct.Count + 1

	// set data
	if appErr := p.Helpers.KVSetJSON("counter", ct); appErr != nil {
		return nil, model.NewAppError("where", "id", nil, err.Error(), http.StatusInternalServerError)
	}

	return &model.CommandResponse{Text: fmt.Sprintf("counter: %d", ct.Count)}, nil
}
```

### CheckRequiredServerConfiguration

`CheckRequiredServerConfiguration`ã¯ã€ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®è¨­å®šã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãŸã‚ã® Helper é–¢æ•°ã§ã™ã€‚

å¼•æ•°ã«æŒ‡å®šã—ãŸ[`model.Config`](https://pkg.go.dev/github.com/mattermost/mattermost-server/v5/model#Config)ã¨åŒã˜è¨­å®šã«ãªã£ã¦ã„ã‚‹ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€ç•°ãªã‚‹è¨­å®šã ã£ãŸå ´åˆã¯`false`ã‚’è¿”ã—ã¾ã™ã€‚

**ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ³ã‚½ãƒ¼ãƒ« > Bot ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ > Bot ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä½œæˆã‚’æœ‰åŠ¹ã«ã™ã‚‹**ã®è¨­å®šãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ãªã„å ´åˆã«ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®èµ·å‹•ã‚’åœæ­¢ã™ã‚‹ã‚ˆã†ãªä¾‹ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```go:plugin.go
func toPtr(v bool) *bool {
	return &v
}

func (p *SamplePlugin) OnActivate() error {
	b, err := p.Helpers.CheckRequiredServerConfiguration(&model.Config{
		ServiceSettings: model.ServiceSettings{
			EnableBotAccountCreation: toPtr(true),
		},
	})
	if err != nil {
		return err
	}
	if !b {
		return errors.New("EnableBotAccountCreation must be true.")
	}

    ...
```

ãƒ—ãƒ©ã‚°ã‚¤ãƒ³èµ·å‹•æ™‚ã€ã‚µãƒ¼ãƒãƒ¼ã®ãƒ­ã‚°ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚

```bash
2020-12-13T00:16:01.409+0900    error   mlog/log.go:229 Unable to restart plugin on upgrade.    {"path": "/api/v4/plugins", "request_id": "u31bzwuyhbyibratzznjxgxzrr", "ip_addr": "::1", "user_id": "87x93uo8pfnzdro9ktcmobpa1r", "method": "POST", "err_where": "installExtractedPlugin", "http_code": 500, "err_details": "EnableBotAccountCreation must be true."}
```

## ã•ã„ã”ã«

æœ¬æ—¥ã¯ã€Mattermost Plugin ã® Server API ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã—ãŸã€‚
æ˜æ—¥ã‹ã‚‰ã¯ã€Mattermost Plugin ã®**Webapp**ã‚µã‚¤ãƒ‰ã®å®Ÿè£…ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã™ã€‚
