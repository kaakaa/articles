---
title: "[Mattermost Integrations] Matterpoll Plugin (Webapp)"
date: 2020-12-23T00:00:00+09:00
emoji: "ğŸ“†"
type: "tech"
topics: ["Mattermost"]
published: true
aliases: "/post/mattermost/advent-calendar-2020/day23-matterpoll-webapp"
---

Mattermost è¨˜äº‹ã¾ã¨ã‚: https://blog.kaakaa.dev/tags/mattermost/

## æœ¬è¨˜äº‹ã«ã¤ã„ã¦

[Mattermost ã®çµ±åˆæ©Ÿèƒ½ã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼](https://qiita.com/advent-calendar/2020/mattermost-integrations)ã®ç¬¬ 23 æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚

ä»¥å‰ã‹ã‚‰é–‹ç™ºã«å‚åŠ ã—ã¦ã„ã‚‹[Matterpoll](https://github.com/matterpoll/matterpoll)ãŒ Mattermost å…¬å¼ã® Plugin Marketplace ã§ Community Plugin ã¨ã—ã¦å…¬é–‹ã•ã‚Œã¾ã—ãŸã€‚

æ˜¨æ—¥ã®è¨˜äº‹ã§ã¯ Matterpoll Plugin ã® Server å´ã®å®Ÿè£…ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã—ãŸãŒã€æœ¬æ—¥ã®è¨˜äº‹ã§ã¯ Matterpoll Plugin ã® Webapp å´ã®æ©Ÿèƒ½ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã™ã€‚

## Webapp å´ã®å‡¦ç†

Webapp å´ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¯ã«æŠ•ç¥¨ã®è¦‹ãˆæ–¹ã‚’å¤‰ãˆã‚‹ãŸã‚ã®å‡¦ç†ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

### ç‹¬è‡ªã® PostType ã«ã‚ˆã‚‹æŠ•ç¥¨æ¸ˆã¿å›ç­”ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ

![matterpoll-posttype.dio.png](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day23/matterpoll-posttype.dio.png)

Mattermos ã§æŠ•ç¨¿ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã€Mattermost ä¸Šã§ã¯ [Post](<[https://github.com/mattermost/mattermost-server/blob/master/model/post.go#L72](https://github.com/mattermost/mattermost-server/blob/master/model/post.go#L72)>) æ§‹é€ ä½“ã®ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦æ‰±ã‚ã‚Œã¦ã„ã¾ã™ã€‚ãã—ã¦ã€`Post`æ§‹é€ ä½“ã®`Type` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å€¤ã«ã‚ˆã£ã¦æŠ•ç¨¿ã®ç¨®åˆ¥ã‚’åˆ¤åˆ¥ã—ã¦ã„ã¾ã™ã€‚`Post.Type`ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯å¤§ããåˆ†ã‘ã¦äºŒã¤ã®ç¨®é¡ãŒã‚ã‚Šã€ä¸€ã¤ã¯é€šå¸¸ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŠ•ç¨¿ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆ `Post.Type` ãŒç©ºæ–‡å­—ï¼ˆ`POST_DEFAULT`ï¼‰ã€‚ã‚‚ã†ä¸€ã¤ã¯ã€ãƒãƒ£ãƒ³ãƒãƒ«å‚åŠ æ™‚ãªã©ã«ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã£ã¦æŠ•ç¨¿ã•ã‚Œã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆ`Post.Type` ã¯ [`system_` ã§å§‹ã¾ã‚‹](<[https://github.com/mattermost/mattermost-server/blob/master/model/post.go#L22](https://github.com/mattermost/mattermost-server/blob/master/model/post.go#L22)>)ï¼‰ã§ã™ã€‚

![2 ã¤ã®Post.Typeã®æŠ•ç¨¿](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day23/posttype-sample.png)

Mattermost ä¸Šã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¦‹ãŸç›®ã¯ [Message Attachements](<[https://docs.mattermost.com/developer/message-attachments.html](https://docs.mattermost.com/developer/message-attachments.html)>) ã®æ©Ÿèƒ½ã‚’ä½¿ã†äº‹ã§ã‚ã‚‹ç¨‹åº¦å¤‰æ›´ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã™ãŒã€ Message Attachments ã§ã¯ Mattermost ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¨å“¡ã«å¯¾ã—ã¦åŒã˜è¦‹ãŸç›®ã—ã‹æä¾›ã§ããªã„ãŸã‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¯ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä¸€éƒ¨ã‚’å¤‰æ›´ã—ãŸã„å ´åˆãªã©ã¯ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§å‡¦ç†ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚Matterpoll ã®å ´åˆã€Œè‡ªåˆ†ãŒæŠ•ç¥¨ã—ãŸå›ç­”ãŒã©ã‚Œãªã®ã‹è¡¨ç¤ºã—ãŸã„ã€ã¨ã„ã†ã‚ˆã†ãªãƒ¦ãƒ¼ã‚¶ãƒ¼æ¯ã«è¡¨ç¤ºã‚’å¤‰æ›´ã™ã‚‹è¦æ±‚ãŒã‚ã£ãŸãŸã‚ã€ã“ã®éƒ¨åˆ†ã‚’ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§å‡¦ç†ã—ã¦ã„ã¾ã™ã€‚

ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§æŠ•ç¨¿ã®è¦‹ãŸç›®ã‚’å¤‰ãˆãŸã„å ´åˆã€ã¾ãš Server å´ã§æŠ•ç¨¿ã‚’ä½œæˆã™ã‚‹éš›ã«ã€ç‹¬è‡ªã®`Post.Type`ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚Matterpoll ã§ã¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ `/poll` ãŒå®Ÿè£…ã•ã‚ŒãŸéš›ã«æŠ•ç¥¨ç”¨ã®æŠ•ç¨¿ (`Post`) ã‚’ä½œæˆã™ã‚‹ã®ã§ã™ãŒã€ãã®éš›ã« `Post.Type` ã« `custom_matterpoll` ã¨ã„ã†å€¤ã‚’è¨­å®šã—ã¦ã„ã¾ã™ã€‚

```go:server/plugin/plugin.go
...
const (
  ...
	// MatterpollPostType is post_type of posts generated by Matterpoll
	MatterpollPostType = "custom_matterpoll"
)
...
```

[https://github.com/matterpoll/matterpoll/blob/45f095875a98fb1d4f3f166851c86f41b987493e/server/plugin/plugin.go#L53](https://github.com/matterpoll/matterpoll/blob/45f095875a98fb1d4f3f166851c86f41b987493e/server/plugin/plugin.go#L53)

```go:server/plugin/command.go
...
  post := &model.Post{
		UserId:    p.botUserID,
		ChannelId: args.ChannelId,
		RootId:    args.RootId,
		Type:      MatterpollPostType,
		Props: map[string]interface{}{
			"poll_id": newPoll.ID,
		},
	}
	model.ParseSlackAttachment(post, actions)

	rPost, appErr := p.API.CreatePost(post)
...
```

[https://github.com/matterpoll/matterpoll/blob/45f095875a98fb1d4f3f166851c86f41b987493e/server/plugin/command.go#L191](https://github.com/matterpoll/matterpoll/blob/45f095875a98fb1d4f3f166851c86f41b987493e/server/plugin/command.go#L191)

ä¸Šè¨˜ã®ã‚ˆã†ã«`Post.Type` ã«ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç‹¬è‡ªã®å€¤ã‚’è¨­å®šã—ã¾ã—ãŸãŒã€Webapp å´ã§`custom_matterpoll`ã¨ã„ã†`Post.Type`ã«å¯¾ã™ã‚‹å‡¦ç†ã‚’è¿½åŠ ã—ãªã„é™ã‚Šã€é€šå¸¸ã®æŠ•ç¨¿ã¨åŒã˜ã‚ˆã†ã«è¡¨ç¤ºã•ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚Mattermost ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§ã¯ã€WebApp ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ API ã®[registerPostTypeComponent](<[https://developers.mattermost.com/extend/plugins/webapp/reference/#registerPostTypeComponent](https://developers.mattermost.com/extend/plugins/webapp/reference/#registerPostTypeComponent)>) ã‚’ä½¿ã„ `Post.Type` ã« `custom_matterpoll` ãŒè¨­å®šã•ã‚ŒãŸå ´åˆã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ–¹æ³•ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚

[registerPostTypeComponent](<[https://developers.mattermost.com/extend/plugins/webapp/reference/#registerPostTypeComponent](https://developers.mattermost.com/extend/plugins/webapp/reference/#registerPostTypeComponent)>) ã¯ç¬¬ä¸€å¼•æ•°ã«`Post.Type` ã®æ–‡å­—åˆ—ã‚’æŒ‡å®šã—ã€ç¬¬äºŒå¼•æ•°ã« React ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æŒ‡å®šã—ã¾ã™ã€‚Matterpoll ã®å ´åˆã¯ã€Server å´ã§ `Post.Type` ã« `custom_matterpoll` ã‚’æŒ‡å®šã—ã¦ã„ã‚‹ãŸã‚ã€ä¸‹è¨˜ã®ã‚ˆã†ã«ç¬¬ä¸€å¼•æ•°ã« `custom_matterpoll` ã‚’ã€ç¬¬äºŒå¼•æ•°ã«ç‹¬è‡ªã® React ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æŒ‡å®šã—ã¦ [registerPostTypeComponent](<[https://developers.mattermost.com/extend/plugins/webapp/reference/#registerPostTypeComponent](https://developers.mattermost.com/extend/plugins/webapp/reference/#registerPostTypeComponent)>) ã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã€‚

```jsx:webapp/src/actions/config.js
import PostType from 'components/post_type';
...

    if (data.experimentalui) {
        registeredComponentId = registry.registerPostTypeComponent('custom_matterpoll', PostType);
    } else {
       registry.unregisterPostTypeComponent(registeredComponentId);
       registeredComponentId = '';
    }
...
```

[https://github.com/matterpoll/matterpoll/blob/fa1f3aa8489deb24706937beac7d9976b0528ed7/webapp/src/actions/config.js#L11](https://github.com/matterpoll/matterpoll/blob/fa1f3aa8489deb24706937beac7d9976b0528ed7/webapp/src/actions/config.js#L11)

[registerPostTypeComponent](<[https://developers.mattermost.com/extend/plugins/webapp/reference/#registerPostTypeComponent](https://developers.mattermost.com/extend/plugins/webapp/reference/#registerPostTypeComponent)>) ã¯æˆ»ã‚Šå€¤ã¨ã—ã¦ç™»éŒ²ã•ã‚ŒãŸ React ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«å¯¾å¿œã™ã‚‹ ID æ–‡å­—åˆ—ã‚’è¿”ã—ã¾ã™ãŒã€ã“ã‚Œã¯ç™»éŒ²ã—ãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’[unregisterPostTypeComponent](<[https://developers.mattermost.com/extend/plugins/webapp/reference/#unregisterPostTypeComponent](https://developers.mattermost.com/extend/plugins/webapp/reference/#registerPostTypeComponent)>)ã‚’åˆ©ç”¨ã—ã¦è§£é™¤ã™ã‚‹å ´åˆã«å¿…è¦ãªãŸã‚ state ã«ä¿æŒã—ã¦ã„ã¾ã™ã€‚

Matterpoll ã§ã¯ã€Webapp å´ã®æ©Ÿèƒ½ã¯ã¾ã  Experimental ãªæ©Ÿèƒ½ã¨ã—ã¦è¨­å®šã§ On/Off ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã„ã‚‹ãŸã‚ã€è¨­å®šå¤‰æ›´ã«ã‚ˆã£ã¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ç™»éŒ²/è§£é™¤ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

ã“ã®ã‚ˆã†ã«ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç‹¬è‡ªã«æŠ•ç¨¿ã®è¦‹ãŸç›®ã‚’å¤‰ãˆãŸã„å ´åˆã€è‡ªä½œã® React ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®æ™‚ã€Mattermost æœ¬ä½“ãŒæ§‹ç¯‰ã™ã‚‹æŠ•ç¨¿ã«é–¢ã™ã‚‹ DOM ã®ä¸€éƒ¨ã ã‘è¡¨ç¤ºã‚’å¤‰æ›´ã™ã‚‹ãªã©ãŒã§ãã‚‹ã¨è‰¯ã„ã®ã§ã™ãŒã€Mattermost ã® React ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯å¤–éƒ¨ã‹ã‚‰å‚ç…§ã§ãã‚‹å½¢ã§å…¬é–‹ã•ã‚Œã¦ã„ãªã„ãŸã‚ã€ä¸€ã‹ã‚‰è‡ªåˆ†ã§ä½œã‚‹å¿…è¦ãŒã‚ã‚Šãªã‹ãªã‹é›£å„€ã—ã¦ã„ã¾ã™...ã€‚ãŸã ã€React ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’é–‹ç™ºã™ã‚‹éš›ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ãŒã„ãã¤ã‹åˆ©ç”¨å¯èƒ½ãªãŸã‚ã€ã“ã®è¾ºã‚Šã‚’ä½¿ã£ã„ã¾ã™ã€‚

[https://developers.mattermost.com/extend/plugins/webapp/reference/#post-utils](https://developers.mattermost.com/extend/plugins/webapp/reference/#post-utils)

#### ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç‹¬è‡ªã® WebSocket ã‚¤ãƒ™ãƒ³ãƒˆ

![matterpoll-ws.dio.png](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day23/matterpoll-ws.dio.png)

Mattermost ã® Server ã¨ Webapp ã®é–“ã¯ WebSocket ã«ã‚ˆã‚Šã‚„ã‚Šå–ã‚ŠãŒè¡Œã‚ã‚Œã¦ã„ã¾ã™ã€‚

Webapp å´ã§ WebSocket ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ä¿¡ã—ãŸæ™‚ã®ç‹¬è‡ªå‡¦ç†ã‚’ç™»éŒ²ã™ã‚‹ã®ãŒ [registerWebSocketEventHandler](<[https://developers.mattermost.com/extend/plugins/webapp/reference/#registerWebSocketEventHandler](https://developers.mattermost.com/extend/plugins/webapp/reference/#registerWebSocketEventHandler)>)ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã€ç¬¬ä¸€å¼•æ•°ã« WebSocket ã‚¤ãƒ™ãƒ³ãƒˆåã€ç¬¬äºŒå¼•æ•°ã« WebSocket ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ã‘å–ã£ãŸã¨ãã«å®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†ã‚’é–¢æ•°ã¨ã—ã¦ç™»éŒ²ã—ã¾ã™ã€‚

Mattermost ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ Publish ã—ã¦ã„ã‚‹ WebSocket ã‚¤ãƒ™ãƒ³ãƒˆã¯[API ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](<[https://api.mattermost.com/#tag/WebSocket](https://api.mattermost.com/#tag/WebSocket)>)ã«ä¸€è¦§ã§ã¾ã¨ã‚ã‚‰ã‚Œã¦ãŠã‚Šã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æŠ•ç¨¿/å‰Šé™¤/ç·¨é›†ã‚„ãƒãƒ£ãƒ³ãƒãƒ«ã®ä½œæˆ/å‰Šé™¤ã€å‚åŠ /è„±é€€ãªã©ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã«å¯¾ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãŒä¸€é€šã‚Šç¶²ç¾…ã•ã‚Œã¦ã„ã¾ã™ã€‚ã¾ãŸã€Server å´ã‹ã‚‰ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã”ã¨ã«ç‹¬è‡ªã® WebSocket ã‚¤ãƒ™ãƒ³ãƒˆã‚’ Publish ã™ã‚‹ã“ã¨ã‚‚ã§ãã€Matterpoll ã§ã¯ã€Matterpoll ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®è¨­å®šãŒå¤‰æ›´ã•ã‚ŒãŸæ™‚ã¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŠ•ç¥¨ã«å›ç­”ã—ãŸã¨ãã«ç‹¬è‡ªã® WebSocket ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡ã—ã¦ã„ã¾ã™ã€‚

ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç‹¬è‡ªã® WebSocket ã‚¤ãƒ™ãƒ³ãƒˆã‚’ Publish ã™ã‚‹ã«ã¯ã€Server å´ã§ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ API ã®[PublishWebSocketEvent](<[https://developers.mattermost.com/extend/plugins/server/reference/#API.PublishWebSocketEvent](https://developers.mattermost.com/extend/plugins/server/reference/#API.PublishWebSocketEvent)>)ã‚’å®Ÿè¡Œã™ã‚‹ã ã‘ã§ã‚ˆãã€Matterpoll ã§ã¯ä¸‹è¨˜ã®ã‚ˆã†ãªãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½œæˆã—ã€æŠ•ç¥¨ãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›´ãŒã‚ã£ãŸæ™‚ã«ã“ã®å‡¦ç†ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§ã€æŠ•ç¥¨ã«é–¢ã™ã‚‹æœ€æ–°ã®ãƒ‡ãƒ¼ã‚¿ã‚’ Webapp ã«é€ä¿¡ã—ã¦ã„ã¾ã™ã€‚

```go:server/plugin/api.go
func (p *MatterpollPlugin) publishPollMetadata(poll *poll.Poll, userID string) {
	hasAdminPermission, appErr := p.HasAdminPermission(poll, userID)
	if appErr != nil {
		p.API.LogWarn("Failed to check admin permission", "userID", userID, "pollID", poll.ID, "error", appErr.Error())
		hasAdminPermission = false
	}
	metadata := poll.GetMetadata(userID, hasAdminPermission)
	p.API.PublishWebSocketEvent("has_voted", metadata.ToMap(), &model.WebsocketBroadcast{UserId: userID})
}
```

[https://github.com/matterpoll/matterpoll/blob/45f095875a98fb1d4f3f166851c86f41b987493e/server/plugin/api.go#L411](https://github.com/matterpoll/matterpoll/blob/45f095875a98fb1d4f3f166851c86f41b987493e/server/plugin/api.go#L411)

ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ API ã§ã‚ã‚‹ [PublishWebSocketEvent](<[https://developers.mattermost.com/extend/plugins/server/reference/#API.PublishWebSocketEvent](https://developers.mattermost.com/extend/plugins/server/reference/#API.PublishWebSocketEvent)>) ã¯ 3 ã¤ã®å¼•æ•°ã‚’å–ã‚Šã€ç¬¬ä¸€å¼•æ•°ã§ Publish ã™ã‚‹ WebSocket ã‚¤ãƒ™ãƒ³ãƒˆã®ã‚¤ãƒ™ãƒ³ãƒˆåã‚’æŒ‡å®šã—ã¾ã™ã€‚å®Ÿéš›ã«ã¯ã€ã“ã“ã§æŒ‡å®šã•ã‚ŒãŸã‚¤ãƒ™ãƒ³ãƒˆåã®å…ˆé ­ã« `custom_<pluginid>_` ã‚’ä»˜ä¸ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆåã¨ã—ã¦ã‚„ã‚Šå–ã‚Šã•ã‚Œã‚‹ãŸã‚ã€ç¬¬ 1 å¼•æ•°ã‚’ "has_voted" ã¨ã—ã¦ã„ã‚‹ä»Šå›ã®ä¾‹ã§ã¯ `custom_com.github.matterpoll.matterpoll_has_voted`ã¨ã„ã† WebSocket ã‚¤ãƒ™ãƒ³ãƒˆåã¨ãªã‚Šã¾ã™ã€‚ã‚¤ãƒ™ãƒ³ãƒˆåã«ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ ID ãŒå…¥ã£ã¦ã„ã‚‹ãŸã‚ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³é–“ã®ã‚¤ãƒ™ãƒ³ãƒˆåã®ç«¶åˆã«ã¤ã„ã¦ã¯è€ƒæ…®ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã›ã‚“ã€‚

ç¬¬ 2 å¼•æ•°ã«ã¯ Publish ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’æŒ‡å®šã—ã¾ã™ã€‚`map` å½¢å¼ã§ value ã«ã¯ `interface{}` å‹ãŒæŒ‡å®šã§ãã¾ã™ãŒã€ã“ã®å€¤ã«ã¯ Go ã®ãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–å‹ã‹ [mattermost-server/model](<[https://github.com/mattermost/mattermost-server/tree/master/model](https://github.com/mattermost/mattermost-server/tree/master/model)>) ã—ã‹æŒ‡å®šã§ãã¾ã›ã‚“ã€‚ãã‚Œä»¥å¤–ã®å€¤ã‚’æŒ‡å®šã—ã¦ã—ã¾ã†ã¨ã€å®Ÿè¡Œæ™‚ã«ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼ã¨ãªã‚Šã¾ã™ã€‚ï¼ˆMattermost ã‚µãƒ¼ãƒãƒ¼ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ãªã„ã¨åˆ†ã‹ã‚‰ãªã„ãŸã‚ãƒãƒã‚ŠãŒã¡ã§ã™ï¼‰

ç¬¬ 3 å¼•æ•°ã§ã¯ã€ã“ã® WebSocket ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã©ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦é€ä¿¡ã™ã‚‹ã‹ã‚’æ±ºå®šã—ã¾ã™ã€‚[model.WebsocketBroadcast](<[https://pkg.go.dev/github.com/mattermost/mattermost-server/v5/model#WebsocketBroadcast](https://pkg.go.dev/github.com/mattermost/mattermost-server/v5/model#WebsocketBroadcast)>)ã®å®šç¾©ã‚’è¦‹ã‚‹ã¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼å˜ä½ä»¥å¤–ã«ã‚‚ãƒãƒ£ãƒ³ãƒãƒ«ã‚„ãƒãƒ¼ãƒ å˜ä½ã§æŒ‡å®šã™ã‚‹ã“ã¨ã‚‚ã§ããã†ã§ã™ï¼ˆè©¦ã—ãŸã“ã¨ã¯ãªã„ã§ã™ãŒï¼‰ã€‚

æ¬¡ã«ã€Server å´ã‹ã‚‰ Publish ã•ã‚ŒãŸ WebSocket ã‚¤ãƒ™ãƒ³ãƒˆ `custome_com.github.matterpoll.matterpoll_has_voted` ã‚’ Webapp å´ã§å‡¦ç†ã™ã‚‹ãŸã‚ã«ã€å‰è¿°ã® [registerWebSocketEventHandler](<[https://developers.mattermost.com/extend/plugins/webapp/reference/#registerWebSocketEventHandler](https://developers.mattermost.com/extend/plugins/webapp/reference/#registerWebSocketEventHandler)>) ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```jsx:webapp/src/plugin.jsx
export default class MatterPollPlugin {
    async initialize(registry, store) {
        ...
        registry.registerWebSocketEventHandler(
            'custom_' + pluginId + '_has_voted',
            (message) => {
                store.dispatch(websocketHasVoted(message.data));
            },
        );
        ...
    }
```

[https://github.com/matterpoll/matterpoll/blob/0b797025cfbf319c43464fcf457d4cdfe5086188/webapp/src/plugin.jsx#L17](https://github.com/matterpoll/matterpoll/blob/0b797025cfbf319c43464fcf457d4cdfe5086188/webapp/src/plugin.jsx#L17)

ä¸Šè¨˜ã®ã‚ˆã†ã«ã€Webapp å´ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³èµ·å‹•æ™‚ã« WebSocket ã‚’å—ä¿¡ã—ãŸæ™‚ã® Handler ã‚’ç™»éŒ²ã—ã¦ãŠãã“ã¨ã§ã€Mattermost ä¸Šã®æ“ä½œã«å¿œã˜ã¦ Webapp å´ã®è¡¨ç¤ºã‚’å¤‰ãˆã‚‹ãªã©ã®å‡¦ç†ã‚’è¡Œãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

## ã•ã„ã”ã«

æœ¬æ—¥ã¯ã€Mattermost ä¸Šã§æŠ•ç¥¨ã‚’è¡Œãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ Matterpoll Plugin ã® Webapp å´ã®å®Ÿè£…ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã—ãŸã€‚
æ˜æ—¥ã¯ã€Matterpoll Plugin é–‹ç™ºã«ãŠã‘ã‚‹ãƒ†ã‚¹ãƒˆã‚„ CI ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã™ã€‚
