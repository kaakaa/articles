---
title: "[Mattermost Integrations] Slash Command å¿œç”¨ç·¨"
date: 2020-12-08T00:00:00+09:00
emoji: "ğŸ“†"
type: "tech"
topics: ["Mattermost"]
published: true
---

Mattermost è¨˜äº‹ã¾ã¨ã‚: https://blog.kaakaa.dev/tags/mattermost/

## æœ¬è¨˜äº‹ã«ã¤ã„ã¦

Mattermost ã®çµ±åˆæ©Ÿèƒ½ã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ç¬¬ 8 æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚

æœ¬æ—¥ã®è¨˜äº‹ã¯ã€æ˜¨æ—¥ã¾ã§ç´¹ä»‹ã—ã¦ããŸ Slash Command ã‚’ä½¿ã£ãŸã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã®ç´¹ä»‹ã§ã™ã€‚

## èƒŒæ™¯

ã‚³ãƒ­ãƒŠå½±éŸ¿ã«ã‚ˆã‚Š WFH(Work From Home)ãŒå®šç€ã—ã¦ãã¾ã—ãŸãŒã€æ¯æ—¥è‡ªå®…ã§ä½œæ¥­ã—ã¦ã„ã‚‹ã¨åŒã˜æ™¯è‰²ã—ã‹è¦‹ãˆãªã„ãŸã‚æ°—æŒã¡ãŒæ»…å…¥ã£ã¦ãã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚è‡ªåˆ†ã¯å°‘ã—ã§ã‚‚æ—¥å¸¸ã«å¤‰åŒ–ã‚’ä»˜ã‘ã‚ˆã†ã¨éŸ³æ¥½ã‚’æµã—ãªãŒã‚‰ä½œæ¥­ã—ã¦ã„ã‚‹ã“ã¨ãŒå¤šã„ã®ã§ã€Mattermost ã‹ã‚‰ Spotify ã®ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’æ¢ã™ã“ã¨ãŒã§ãã‚‹çµ±åˆæ©Ÿèƒ½ã‚’ä½œã£ã¦ã¿ã¾ã—ãŸã€‚ï¼ˆæ™®æ®µã¯ AppleMusic æ´¾ã§ã™ãŒ...ï¼‰

## å‹•ä½œä¾‹

![movie](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day8/example-music-command.gif)

`/music [search_term]`ã§ã€`[search_term]`ã‚’æ¤œç´¢ã‚­ãƒ¼ã¨ã—ã¦ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’æ¤œç´¢ã—ã¾ã™ã€‚`[search_term]`ã‚’æŒ‡å®šã—ãªã„å ´åˆã€`workfromhome`ã‚’æ¤œç´¢ã‚­ãƒ¼ã¨ã—ã¦æ¤œç´¢ã—ã¾ã™ã€‚
ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€è¦‹ã¤ã‹ã£ãŸãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã®æƒ…å ±ã‚’ãƒªãƒ³ã‚¯ä»˜ãã§ Mattermost ã«æŠ•ç¨¿ã—ã¾ã™ã€‚ã“ã®æ™‚ã€`card`æ©Ÿèƒ½ã‚’ä½¿ã£ã¦æŠ•ç¨¿ã‹ã‚‰ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã®å†…å®¹ã‚’ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

## ã‚³ãƒ¼ãƒ‰

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ä¸‹è¨˜ã®ãƒªãƒã‚¸ãƒˆãƒªã«ã‚³ãƒŸãƒƒãƒˆã—ã¦ã‚ã‚Šã¾ã™ã€‚

https://github.com/kaakaa/blog/tree/master/code/mattermost/2020-advent-calendar/slash-command-spotify

Mattermost é€£æºéƒ¨åˆ†ã®å‹•ä½œã‚³ãƒ¼ãƒ‰ã¯ä¸‹è¨˜ã«ãªã‚Šã¾ã™ã€‚ã“ã‚Œã¨ã¯åˆ¥ã« Spotify ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”¨ã®ã‚³ãƒ¼ãƒ‰ã‚‚ã‚ã‚Šã¾ã™ãŒã€ãã¡ã‚‰ã®ç´¹ä»‹ã¯å‰²æ„›ã—ã¾ã™ã€‚

```go
package main

import (
	"fmt"
	"io"
	"log"
	"math/rand"
	"net/http"
	"strings"

	"github.com/mattermost/mattermost-server/v5/model"
)

const (
	// (1) å®šæ•°ã®è¨­å®š
	MattermostToken     = "arzoyh4i57dw5x57yumenuktqw"
	SpotifyClientID     = "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
	SpotifyClientSecret = "ZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZ"
)

func main() {
	// (2) Spotify ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–
	client, err := NewSpotifyClient(SpotifyClientID, SpotifyClientSecret)
	if err != nil {
		log.Fatalf("failed to set up spotify client: %s", err.Error())
	}
	http.HandleFunc("/spotify", func(w http.ResponseWriter, r *http.Request) {
		r.ParseForm()
		// (3) ãƒˆãƒ¼ã‚¯ãƒ³ã«ã‚ˆã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®æ¤œè¨¼
		if MattermostToken != r.Form.Get("token") {
			log.Printf("received token is invalid: %s", r.Form.Get("token"))
			return
		}

		// (4) serach_termã®å–å¾—
		term := "workfromhome"
		if t := r.Form.Get("text"); len(t) > 0 {
			term = t
		}

		// (5) ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã®æ¤œç´¢
		playlist, err := client.findRandomPlaylist(term)
		if err != nil {
			io.WriteString(w, fmt.Sprintf("failed to serach playlist: %s", err.Error()))
			return
		}

		// (6) ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆå†…ã®ãƒˆãƒ©ãƒƒã‚¯æƒ…å ±ã®å–å¾—
		tracks, err := client.getTracks(playlist.Id)
		if err != nil {
			io.WriteString(w, fmt.Sprintf("failed to get tracks: %s", err.Error()))
			return
		}
		contextInfo := []string{"Tracks"}
		for _, t := range tracks {
			contextInfo = append(contextInfo, fmt.Sprintf("1. %s", t))
		}

		// (7) Mattermostã¸ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æ§‹ç¯‰
		response := model.CommandResponse{
			ResponseType: model.COMMAND_RESPONSE_TYPE_IN_CHANNEL,
			Username:     "Music Provider",
			Props: map[string]interface{}{
				"card": strings.Join(contextInfo, "\n"),
			},
			Attachments: playlist.ToMessage(),
		}

		w.Header().Add("Content-Type", "application/json")
		io.WriteString(w, response.ToJson())
	})

	// Start server
	http.ListenAndServe(":8080", nil)
}
```

### (1) å®šæ•°ã®è¨­å®š

ãƒ—ãƒ­ã‚°ãƒ©ãƒ å†…ã§ä½¿ç”¨ã™ã‚‹å®šæ•°ã‚’å®£è¨€ã—ã¦ã„ã¾ã™ã€‚

Mattermost é–¢ä¿‚ã¯ Slash Command ã‹ã‚‰é€ä¿¡ã•ã‚Œã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ¤œè¨¼ç”¨ã®ãƒˆãƒ¼ã‚¯ãƒ³æ–‡å­—åˆ—ã€‚  
Spotify ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ ID/ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã§ã™ã€‚ã“ã‚Œã‚‰ã®å€¤ã®å–å¾—æ–¹æ³•ã«ã¤ã„ã¦ã¯ [Spotify Developer Platform: Spotify API ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãƒ‡ãƒ¼ã‚¿å–å¾—ã—ã¦ã¿ã¦ã¿ãŸ \- Qiita](https://qiita.com/shirok/items/ba5c45511498b75aac27) ãªã©ã‚’å‚ç…§ãã ã•ã„ã€‚[Client Credential Flow](https://developer.spotify.com/documentation/general/guides/authorization-guide/)ã§èªè¨¼ã™ã‚‹ãŸã‚ã€Redirect URI ãªã©ã®è¨­å®šã¯å¿…è¦ç„¡ã„ã‹ã¨æ€ã„ã¾ã™ã€‚

### (2) Spotify ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–

Spotify ã® API ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’æ§‹ç¯‰ã—ã¦ã„ã¾ã™ã€‚å†…å®¹ã«ã¤ã„ã¦ã¯å‰²æ„›ã—ã¾ã™ã€‚

### (3) ãƒˆãƒ¼ã‚¯ãƒ³ã«ã‚ˆã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®æ¤œè¨¼

Mattermost ã® Custom Slash Command ã«ã‚ˆã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ä¿¡ã—ãŸã‚‰ã€ã¾ãšã¯ãƒˆãƒ¼ã‚¯ãƒ³ã«ã‚ˆã‚‹æ¤œè¨¼ã‚’è¡Œã„ã¾ã™ã€‚

### (4) serach_term ã®å–å¾—

Custom Slash Command ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰ã€Slash Command ã®å¼•æ•°ã¨ã—ã¦æŒ‡å®šã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—ã—ã¾ã™ã€‚ã“ã‚ŒãŒ Spotify ã¸ã®æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã™ã€‚
Custom Slash Command ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã«ã¤ã„ã¦ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ãã ã•ã„ã€‚

- https://developers.mattermost.com/integrate/slash-commands/#basic-usage

### (5) ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã®æ¤œç´¢

(2) ã§åˆæœŸåŒ–ã—ãŸ Spotify ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½¿ã£ã¦ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã®æ¤œç´¢ã‚’è¡Œã„ã¾ã™ã€‚è©³ç´°ã¯å‰²æ„›ã—ã¾ã™ãŒã€[Search for an Item \| Spotify for Developers](https://developer.spotify.com/documentation/web-api/reference/search/search/)ã® API ã‚’å®Ÿè¡Œã—ã€ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã‚“ã ä¸€ã¤ã®ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’è¿”ã™ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

### (6) ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆå†…ã®ãƒˆãƒ©ãƒƒã‚¯æƒ…å ±ã®å–å¾—

ã“ã¡ã‚‰ã‚‚ Spotify ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½¿ã£ã¦(5)ã§å–å¾—ã—ãŸãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã®ãƒˆãƒ©ãƒƒã‚¯ã‚’å–å¾—ã—ã¦ã„ã¾ã™ã€‚å†…éƒ¨ã§ã¯[Get a Playlist's Items \| Spotify for Developers](https://developer.spotify.com/documentation/web-api/reference/playlists/get-playlists-tracks/)ã® API ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚
ä¸€åº¦ã® API ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§å–å¾—ã§ãã‚‹æœ€å¤§ã®ãƒˆãƒ©ãƒƒã‚¯ã‚¹æ•°ãŒ 100 ã§ã‚ã‚Šã€100 ãƒˆãƒ©ãƒƒã‚¯ä»¥ä¸Šã‚ã‚‹ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã«ã¤ã„ã¦ã¯ã€æœ€åˆã® 100 ãƒˆãƒ©ãƒƒã‚¯ã ã‘ã‚’å–å¾—ã—ã¦ã„ã¾ã™ã€‚

### (7) Mattermost ã¸ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æ§‹ç¯‰

ä»Šã¾ã§å–å¾—ã—ã¦ããŸæƒ…å ±ã‚’ä½¿ã£ã¦ Mattermost ã¸ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æ§‹ç¯‰ã—ã¦ã„ã¾ã™ã€‚`attachments`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯[MessageAttachments](https://docs.mattermost.com/developer/message-attachments.html)ã®æ©Ÿèƒ½ã‚’ä½¿ã£ã¦ã„ã¾ã™ãŒã€[MessageAttachments](https://docs.mattermost.com/developer/message-attachments.html)ã«ã¤ã„ã¦ã¯å¾Œæ—¥ç´¹ä»‹ã—ã¾ã™ã€‚

---

## ã•ã„ã”ã«

ä»¥ä¸Šã®ã‚ˆã†ã«ã€Custom Slash Command ã«ã‚ˆã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ä¿¡ã—ãŸã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã€å¤–éƒ¨ã® API ã‚’å®Ÿè¡Œã—ã€çµæœã‚’ Mattermost ã«è¿”ã™ã‚ˆã†ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚å¤–éƒ¨ API ã®å®Ÿè¡Œã«æ™‚é–“ãŒã‹ã‹ã‚‹æã‚ŒãŒã‚ã‚‹å ´åˆã¯ã€[Delayed Response](https://developers.mattermost.com/integrate/slash-commands/#delayed-and-multiple-responses)ã‚’åˆ©ç”¨ã™ã‚‹ã¨ Slash Command ã‚’å®Ÿè¡Œã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ã™ãã«è¿”ã›ã‚‹ãŸã‚ä¾¿åˆ©ã§ã™ã€‚Delayed Response ã®æ©Ÿèƒ½ã«ã¤ã„ã¦ã¯æ˜¨æ—¥ã®è¨˜äº‹ã§ç´¹ä»‹ã—ã¾ã—ãŸã€‚

æ˜æ—¥ã¯ã€Message Attachments ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã™ã€‚
