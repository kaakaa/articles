---
title: "[Mattermost Integrations] Matterpoll Plugin (Server)"
date: 2020-12-22T00:00:00+09:00
emoji: "ğŸ“†"
type: "tech"
topics: ["Mattermost"]
published: true
aliases: "/post/mattermost/advent-calendar-2020/day22-matterpoll-server"
---

Mattermost è¨˜äº‹ã¾ã¨ã‚: https://blog.kaakaa.dev/tags/mattermost/

## æœ¬è¨˜äº‹ã«ã¤ã„ã¦

[Mattermost ã®çµ±åˆæ©Ÿèƒ½ã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼](https://qiita.com/advent-calendar/2020/mattermost-integrations)ã®ç¬¬ 22 æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚

ä»¥å‰ã‹ã‚‰é–‹ç™ºã«å‚åŠ ã—ã¦ã„ã‚‹[Matterpoll](https://github.com/matterpoll/matterpoll)ãŒ Mattermost å…¬å¼ã® Plugin Marketplace ã§ Community Plugin ã¨ã—ã¦å…¬é–‹ã•ã‚Œã¾ã—ãŸã€‚

å…¬å¼ã® Plugin Marketplace ã§å…¬é–‹ã•ã‚ŒãŸã“ã¨ã«ã‚ˆã‚Šã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹å¿…è¦ãªã**ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ > ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ãƒ¼ã‚¹**ã‹ã‚‰ãƒœã‚¿ãƒ³ä¸€ã¤ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

![main menu](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day22/marketplace-menu.png)

![install button](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day22/marketplace-install-button.png)

Matterpoll ã¯ Mattermost ä¸Šã§æŠ•ç¥¨ã‚’è¡Œã†ã“ã¨ãŒã§ãã‚‹ Plugin ã§ã‚ã‚Šã€Mattermost ç¤¾ã®é–‹ç™ºè€…ã§ã‚ã‚‹ Hanzei ã¨ç§ã‚’ä¸­å¿ƒã«é–‹ç™ºãŒé€²ã‚ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚

![screenshot of MatterPoll](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day22/matterpoll.png)

ä»¥å‰ã‚ˆã‚Š Mattermost ã«æŠ•ç¥¨æ©Ÿèƒ½ã‚’ä»˜ã‘ã‚‹ã¨ã„ã†ææ¡ˆã¯[Mattermost ã® Feature Request Forum ã§ã‚‚ç¥¨æ•°ã‚’é›†ã‚ã¦](https://mattermost.uservoice.com/forums/306457-general/suggestions/11721996-polls-like-doodle-or-for-decision-making)ã„ãŸãŸã‚ã€ä»¥å‰ã¯çµµæ–‡å­—ã§æŠ•ç¥¨ã‚’ä¿ƒã™ã‚ˆã†ãªçµ±åˆæ©Ÿèƒ½ã‚’é–‹ç™ºã—ã¦ã„ã¾ã—ãŸã€‚

[https://github.com/matterpoll/matterpoll-emoji](https://github.com/matterpoll/matterpoll-emoji)

ãŸã ãã®å½“æ™‚ã¯ Mattermost ã« Plugin æ©Ÿèƒ½ãŒãªã‹ã£ãŸãŸã‚ã€ã“ã®çµ±åˆæ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ Mattermost ã¨ã¯åˆ¥ã«ã‚µãƒ¼ãƒãƒ¼ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚‹ã®ãŒé›£ç‚¹ã§ã—ãŸã€‚

ãã®å¾Œã€Mattermost ã« Plugin æ©Ÿèƒ½ãŒä»˜ã„ãŸã“ã¨ã§ã€Mattermost ã®ãƒ—ãƒ­ã‚»ã‚¹ã®ä¸Šã§çµ±åˆæ©Ÿèƒ½ã‚’å‹•ä½œã•ã›ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã€`matterpoll-emoji` ã‚‚ Plugin ã¨ã—ã¦é–‹ç™ºã—ç›´ã™ã“ã¨ã¨ãªã‚Šã¾ã—ãŸã€‚ãã“ã§å‡ºæ¥ãŸãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒã€ä»Šå› Plugin Marketplace ã§å…¬é–‹ã•ã‚ŒãŸ Matterpoll Plugin ã«ãªã‚Šã¾ã™ã€‚

ã“ã®è¨˜äº‹ã§ã¯ã€ã¾ã æ—¥æœ¬èªã§ã¯ã‚ã¾ã‚Šæƒ…å ±ã®ãªã„ Mattermost Plugin ã«ã¤ã„ã¦ã€Matterpoll Plugin ã®æ§‹é€ ã‚’å…ƒã«ç´¹ä»‹ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

æœ¬è¨˜äº‹ã§ã¯ã€Mattermost ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã® Getting Started çš„ãªéƒ¨åˆ†ã«ã¤ã„ã¦ã¯ã‚ã¾ã‚Šè§¦ã‚Œã¾ã›ã‚“ã€‚Mattermost Plugin ã®åŸºæœ¬çš„ãªéƒ¨åˆ†ã«ã¤ã„ã¦ã¯ã€[ã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ä»–ã®è¨˜äº‹](https://qiita.com/advent-calendar/2020/mattermost-integrations)ã‚„ã€å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã„ãŸã ã‘ã‚Œã°ã¨æ€ã„ã¾ã™ã€‚

[https://developers.mattermost.com/extend/plugins/](https://developers.mattermost.com/extend/plugins/)

ã¾ãŸã€å®Ÿéš›ã«é–‹ç™ºã‚’å§‹ã‚ã‚‹å ´åˆã¯ GitHub ã§å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ Mattermost Plugin ç”¨ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒª [https://github.com/mattermost/mattermost-plugin-starter-template](https://github.com/mattermost/mattermost-plugin-starter-template) ã‚’ä½¿ç”¨ã™ã‚‹ã®ãŒãŠã™ã™ã‚ã§ã™ã€‚ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã‚’ä½¿ã£ãŸé–‹ç™ºã®å§‹ã‚æ–¹ã«ã¤ã„ã¦ã¯ã€ä¸‹è¨˜ã®è¨˜äº‹ã§ç´¹ä»‹ã—ã¦ã„ã¾ã™ã€‚ï¼ˆå°‘ã—æƒ…å ±ãŒå¤ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“...ï¼‰

[Mattermost ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç”¨ã®ãƒªãƒã‚¸ãƒˆãƒªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ Â· kaakaa blog](https://blog.kaakaa.dev/post/mattermost/plugin-template/)

## æ¦‚è¦

Matterpoll Plugin ã¯ Server å´ã®æ©Ÿèƒ½ã¨ Webapp å´ã®æ©Ÿèƒ½ãŒé€£æºã—ã¦å‹•ä½œã—ã¦ã„ã¾ã™ã€‚

Server å´ã®æ©Ÿèƒ½ã¯æŠ•ç¥¨ä½œæˆã‚³ãƒãƒ³ãƒ‰(`/poll`)ã‚’å‡¦ç†ã—ãŸã‚Šã€æŠ•ç¥¨ãŒå®Ÿè¡Œã® HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã£ã¦å‡¦ç†ã‚’ã—ãŸã‚Šã€æŠ•ç¥¨ã«é–¢ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ç®¡ç†ã—ãŸã‚Šã—ã¦ã„ã¾ã™ã€‚Webapp å´ã§ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¯ã«è¡¨ç¤ºã‚’å¤‰ãˆãŸã„å ´åˆãªã©ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®å‡¦ç†ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚Server å´ã¯ Go è¨€èªã€WebApp å´ã¯ React.js(JavaScript/TypeScript)ã§æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚

Mattermost ã®åŸºæœ¬çš„ãªå‡¦ç†ã®æµã‚Œã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

![architecture](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day22/matterpoll.dio.png)

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ Mattermost ä¸Šã§ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ `/poll` ã‚’å®Ÿè¡Œã™ã‚‹ **(1)** ã¨ã€ãã®ã‚³ãƒãƒ³ãƒ‰ã‚’ Matterpoll Server å´ãŒå—ã‘å–ã‚Š **(2)**ã€æŠ•ç¥¨ãƒ‡ãƒ¼ã‚¿(`Poll`)ã‚’ä½œæˆã—ã¾ã™ **(3)**ã€‚ä½œæˆã•ã‚ŒãŸ `Poll` ã®ãƒ‡ãƒ¼ã‚¿ã¯ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç”¨ã® Key-Value Store ã«æ ¼ç´ã•ã‚Œã¾ã™ **(4)**ã€‚ãã—ã¦ã€Mattermost ã®æŠ•ç¨¿å½¢å¼ (`Post`)ã¸å¤‰æ›ã•ã‚Œ **(5)**ã€é€šå¸¸ã®æŠ•ç¨¿ã¨åŒæ§˜ã« Mattermost ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ ¼ç´ã•ã‚Œ **(6)**ã€Webapp ã¸ WebSocket ã‚’é€šã˜ã¦ Publish ã•ã‚Œã¾ã™ **(7)**ã€‚(å®Ÿéš›ã«ã¯ã€è«¸äº‹æƒ…ã«ã‚ˆã‚ŠæŠ•ç¨¿ãŒä½œæˆ **(6)** ã•ã‚Œã¦ã‹ã‚‰æŠ•ç¥¨ãƒ‡ãƒ¼ã‚¿ã‚’ Key-Value ã‚¹ãƒˆã‚¢ ã«æ ¼ç´ **(4)** ã—ã¦ã„ã¾ã™ãŒã€è©±ã‚’ç°¡å˜ã«ã™ã‚‹ãŸã‚ä¸Šè¨˜ã®é †ã§è©±ã‚’ã—ã¦ã„ã¾ã™)

Matterpoll Plugin ã«ã‚ˆã‚Šä½œæˆã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã€Mattermost Webapp å´ã®å‡¦ç†ã«ã‚ˆã£ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¯ã«è¦‹ãŸç›®ãŒå¤‰ã‚ã‚Šã¾ã™ **(8)**ã€‚å…·ä½“çš„ã«ã¯ã€è‡ªåˆ†ãŒæŠ•ç¥¨ã—ãŸå›ç­”ã®ãƒœã‚¿ãƒ³ã®è‰²ãŒå¤‰ã‚ã£ãŸã‚Šã€æŠ•ç¥¨ç®¡ç†ç³»ã®ãƒœã‚¿ãƒ³ãŒæ¨©é™ã®ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰è¦‹ãˆãªããªã£ãŸã‚Šã—ã¾ã™ã€‚ã“ã® WebApp å´ã®æ©Ÿèƒ½ã¯ã€ç¾åœ¨å®Ÿé¨“çš„ãªæ©Ÿèƒ½ã¨ã—ã¦æä¾›ã•ã‚Œã¦ãŠã‚Šã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ Off ã«ãªã£ã¦ã„ã¾ã™ã€‚Mattermost ã® System Console ã® Matterpoll ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®è¨­å®šã‹ã‚‰ On ã«ã™ã‚‹ã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚(è¨­å®šãŒ Off ã§ã‚‚ã€æŠ•ç¥¨æ©Ÿèƒ½è‡ªä½“ã¯åˆ©ç”¨å¯èƒ½)

## Server å´ã®å‡¦ç†

Matterpoll ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ Server å´ã§æŠ•ç¥¨ã®ä½œæˆã€å®Ÿè¡Œã€ãƒ‡ãƒ¼ã‚¿ã®ç®¡ç†ãªã©ã®æŠ•ç¥¨ã«é–¢ã‚ã‚‹åŸºæœ¬çš„ãªå‡¦ç†ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚ã“ã“ã§ã¯ã€Mattermost Plugin ã®æ©Ÿèƒ½ã«ã‚ˆã‚Šã€ä»¥ä¸‹ã®å‡¦ç†ã‚’ã©ã®ã‚ˆã†ã«å®Ÿè£…ã—ã¦ã„ã‚‹ã‹ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¦ã„ãã¾ã™ã€‚

- ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å°‚ç”¨ã®ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ã‚’è¿½åŠ ã—ã€æŠ•ç¥¨ä½œæˆã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
- ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å°‚ç”¨ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®æŠ•ç¥¨ã‚’å—ã‘ä»˜ã‘ã‚‹
- ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å°‚ç”¨ã® Key-Value ã‚¹ãƒˆã‚¢ã§æŠ•ç¥¨ãƒ‡ãƒ¼ã‚¿ã‚’ç®¡ç†ã™ã‚‹

### æŠ•ç¥¨ä½œæˆç”¨ã®ç‹¬è‡ªã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ã®è¿½åŠ 

![matterpoll-command.dio.png](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day22/matterpoll-command.dio.png)

Matterpoll ã¯å°‚ç”¨ã®ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ `/poll` ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§æŠ•ç¥¨ã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã® `/poll` ã‚³ãƒãƒ³ãƒ‰ã¯ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³èµ·å‹•æ™‚ã«ç™»éŒ²ã•ã‚Œã¾ã™ã€‚

Mattermost ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§ã¯ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ API ã® [RegisterCommand](<[https://developers.mattermost.com/extend/plugins/server/reference/#API.RegisterCommand](https://developers.mattermost.com/extend/plugins/server/reference/#API.RegisterCommand)>) ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§æ–°ãŸãªã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ã‚’ç™»éŒ²ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```go:server/plugin/configuration.go
...
// OnConfigurationChange loads the plugin configuration, validates it and saves it.
func (p *MatterpollPlugin) OnConfigurationChange() error {
  ...
	// This require a loaded i18n bundle
	if p.isActivated() {
		command, err := p.getCommand(configuration.Trigger)
		if err != nil {
			return errors.Wrap(err, "failed to get command")
		}
    ...
		if err := p.API.RegisterCommand(command); err != nil {
			return errors.Wrap(err, "failed to register new command")
		}
    ...
	}
  ...
}
...
```

[https://github.com/matterpoll/matterpoll/blob/45f095875a98fb1d4f3f166851c86f41b987493e/server/plugin/configuration.go#L43](https://github.com/matterpoll/matterpoll/blob/45f095875a98fb1d4f3f166851c86f41b987493e/server/plugin/configuration.go#L43)

`RegisterCommand`ã®å¼•æ•°ã«ã¯ã€`getCommand`ãƒ¡ã‚½ãƒƒãƒ‰ã®æˆ»ã‚Šå€¤ `command` ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ãŒã€`getCommand`ã¯ Slash Command ã®ãƒ¢ãƒ‡ãƒ«ã§ã‚ã‚‹`model.Command`ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®å†…éƒ¨ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚

```go:server/plugin/command.go
func (p *MatterpollPlugin) getCommand(trigger string) (*model.Command, error) {
  ...
	return &model.Command{
		Trigger:              trigger,
		AutoComplete:         true,
		AutoCompleteDesc:     p.LocalizeDefaultMessage(localizer, commandAutoCompleteDesc),
		AutoCompleteHint:     p.LocalizeDefaultMessage(localizer, commandAutoCompleteHint),
		AutocompleteIconData: iconData,
	}, nil
}
```

[https://github.com/matterpoll/matterpoll/blob/45f095875a98fb1d4f3f166851c86f41b987493e/server/plugin/command.go#L215](https://github.com/matterpoll/matterpoll/blob/45f095875a98fb1d4f3f166851c86f41b987493e/server/plugin/command.go#L215)

ã¾ãŸã€`getCommand`ã®å¼•æ•° (`configuration.Trigger`)ã¯ Slash Command ã®ãƒˆãƒªã‚¬ãƒ¼ãƒ¯ãƒ¼ãƒ‰(ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰å)ã§ã™ãŒã€Matterpoll ã§ã¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰åã‚’è¨­å®šã‹ã‚‰å¤‰æ›´ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã‚ã‚‹ãŸã‚ã€è¨­å®šç”»é¢ã§å…¥åŠ›ã•ã‚ŒãŸå€¤ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã«`configuration.Trigger`ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚

![è¨­å®šç”»é¢](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day22/matterpoll-settings-trigger.png)

ãã®ãŸã‚ã€è¨­å®šãŒå¤‰æ›´ã•ã‚ŒãŸéš›ã«å®Ÿè¡Œã•ã‚Œã‚‹ [OnConfigurationChange](<[https://developers.mattermost.com/extend/plugins/server/reference/#Hooks.OnConfigurationChange](https://developers.mattermost.com/extend/plugins/server/reference/#Hooks.OnConfigurationChange)>) Hook ã®ä¸­ã§ã€[RegisterCommand](<[https://developers.mattermost.com/extend/plugins/server/reference/#API.RegisterCommand](https://developers.mattermost.com/extend/plugins/server/reference/#API.RegisterCommand)>) ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚

---

ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã«ã‚ˆã‚Šç™»éŒ²ã•ã‚ŒãŸã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰(`/poll`)ãŒå®Ÿè¡Œã•ã‚ŒãŸå ´åˆã®å‡¦ç†ã¯ã€[ExecuteCommand](<[https://developers.mattermost.com/extend/plugins/server/reference/#Hooks.ExecuteCommand](https://developers.mattermost.com/extend/plugins/server/reference/#Hooks.ExecuteCommand)>) Hook ã¨ã—ã¦å®Ÿè£…ã—ã¾ã™ã€‚

```go:server/plugin/command.go
// ExecuteCommand parses a given input and creates a poll if the input is correct
func (p *MatterpollPlugin) ExecuteCommand(c *plugin.Context, args *model.CommandArgs) (*model.CommandResponse, *model.AppError) {
	msg, appErr := p.executeCommand(args)
	if msg != "" {
		p.SendEphemeralPost(args.ChannelId, args.UserId, args.RootId, msg)
	}
	return &model.CommandResponse{}, appErr
}
```

[https://github.com/matterpoll/matterpoll/blob/45f095875a98fb1d4f3f166851c86f41b987493e/server/plugin/command.go#L84](https://github.com/matterpoll/matterpoll/blob/45f095875a98fb1d4f3f166851c86f41b987493e/server/plugin/command.go#L84)

[ExecuteCommand](<[https://developers.mattermost.com/extend/plugins/server/reference/#Hooks.ExecuteCommand](https://developers.mattermost.com/extend/plugins/server/reference/#Hooks.ExecuteCommand)>)ã®ç¬¬äºŒå¼•æ•°ã§ã‚ã‚‹ [\*model.CommandArgs](<[https://pkg.go.dev/github.com/mattermost/mattermost-server/v5/model#CommandArgs](https://pkg.go.dev/github.com/mattermost/mattermost-server/v5/model#CommandArgs)>) å‹ã®å¤‰æ•°ã«ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œæ™‚ã®å¼•æ•°ã‚„ã€ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ IDã€ã‚³ãƒãƒ³ãƒ‰ãŒå®Ÿè¡Œã•ã‚ŒãŸãƒãƒ£ãƒ³ãƒãƒ«ã® ID ãªã©ã®æƒ…å ±ãŒæ ¼ç´ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã“ã‚Œã‚‰ã®å€¤ã‚’ä½¿ã£ã¦ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ãŒå®Ÿè¡Œã•ã‚ŒãŸæ™‚ã®å‡¦ç†ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚

`executeCommand` ãƒ¡ã‚½ãƒƒãƒ‰ã§å¼•æ•°ã‚’è§£æã—ã¦æŠ•ç¥¨ã‚’ä½œæˆã™ã‚‹å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ãŒã€ç´°ã‹ã„å‡¦ç†ãŒå¤šã„ãŸã‚ã“ã‚Œä»¥ä¸Šã®èª¬æ˜ã¯å‰²æ„›ã—ã¾ã™ã€‚

#### æŠ•ç¥¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã‚‹ãŸã‚ã®ç‹¬è‡ªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®è¿½åŠ 

Matterpoll ã«ã‚ˆã‚Šä½œæˆã•ã‚ŒãŸæŠ•ç¨¿ã§ã¯ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«åŸ‹ã‚è¾¼ã¾ã‚ŒãŸãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã“ã¨ã§æŠ•ç¥¨ã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚

![Message Button](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day22/matterpoll-sample.png)

ã“ã®ãƒœã‚¿ãƒ³ã¯ Mattermost ã® [Interacitve Message](<[https://docs.mattermost.com/developer/interactive-messages.html](https://docs.mattermost.com/developer/interactive-messages.html)>) æ©Ÿèƒ½ã‚’åˆ©ç”¨ã—ã¦å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ (Interactive Message ã«ã¤ã„ã¦ã¯[ç¬¬ 14 æ—¥ç›®](https://blog.kaakaa.dev/post/mattermost/advent-calendar-2020/day14-interactive-message-button/)ã€[ç¬¬ 15 æ—¥ç›®](https://blog.kaakaa.dev/post/mattermost/advent-calendar-2020/day15-interactive-message-menu/)ã®è¨˜äº‹ã§ç´¹ä»‹ã—ã¦ã„ã¾ã™)ã€‚Matterpoll ã§ã¯ [https://github.com/matterpoll/matterpoll/blob/45f095875a98fb1d4f3f166851c86f41b987493e/server/plugin/command.go#L186](https://github.com/matterpoll/matterpoll/blob/45f095875a98fb1d4f3f166851c86f41b987493e/server/plugin/command.go#L186) ã®ã‚ãŸã‚Šã§å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚ï¼‰

Matterpoll ãŒä½œæˆã™ã‚‹æŠ•ç¨¿ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ãƒœã‚¿ãƒ³ã¯ã€ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ãã‚Œãã‚Œç•°ãªã‚‹ URL ã¸ HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé€ä¿¡ã•ã‚Œã¾ã™ã€‚ã“ã® HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ Matterpoll ã® Server å´ãŒå—ã‘å–ã‚Šã€ã©ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã©ã®å›ç­”ã«æŠ•ç¥¨ã—ãŸã‹ã‚’è§£æã—ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹æŠ•ç¥¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã™ã‚‹ã“ã¨ã§æŠ•ç¥¨å‡¦ç†ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚

![matterpoll-command.dio.png](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day22/matterpoll-vote.dio.png)

ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã‚‹ãŸã‚ã«ã¯ Matterpoll ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç”¨ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ Mattermost ä¸Šã«å®šç¾©ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€ã“ã‚Œã¯ Mattermost ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®æ©Ÿèƒ½ã§ã‚ã‚‹ [ServeHTTP](<[https://developers.mattermost.com/extend/plugins/server/reference/#Hooks.ServeHTTP](https://developers.mattermost.com/extend/plugins/server/reference/#Hooks.ServeHTTP)>) Hook ã«ã‚ˆã‚Šå®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚[ServeHTTP](<[https://developers.mattermost.com/extend/plugins/server/reference/#Hooks.ServeHTTP](https://developers.mattermost.com/extend/plugins/server/reference/#Hooks.ServeHTTP)>)ã‚’å®Ÿè£…ã™ã‚‹ã¨ã€Mattermost ã« `/plugins/{pluginid}` ã¨ã„ã†ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒç”Ÿæˆã•ã‚Œã€ã“ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«é€ä¿¡ã•ã‚ŒãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§å‡¦ç†ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ä¾‹ãˆã°ã€Mattermost ã« `https://example.com:8065` ã¨ã„ã† URL ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã¨ã™ã‚‹ã¨ã€`https://example.com:8065/plugins/com.github.matterpoll.matterpoll`ãŒ Matterpoll ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å°‚ç”¨ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ãªã‚Šã¾ã™ã€‚

Matterpoll ã§ã¯ã€ã•ã‚‰ã«[gorilla/mux](<[https://github.com/gorilla/mux](https://github.com/gorilla/mux)>) ã‚’ä½¿ç”¨ã—ã¦ Router ã‚’ç”Ÿæˆã—ã€[ServeHTTP](<[https://developers.mattermost.com/extend/plugins/server/reference/#Hooks.ServeHTTP](https://developers.mattermost.com/extend/plugins/server/reference/#Hooks.ServeHTTP)>) ã®å¼•æ•°ã‚’ãã®ã¾ã¾ Router ã¸æµã—è¾¼ã‚€ã“ã¨ã§ã€æŠ•ç¥¨ã®ä½œæˆ/å‰Šé™¤/çµ‚äº†ã‚„æŠ•ç¥¨ã®ç®¡ç†ãªã©æ§˜ã€…ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¯¾å¿œã™ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ç”Ÿæˆã—ã¦å‡¦ç†ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

```go:server/plugin/api.go
...
// InitAPI initializes the REST API
func (p *MatterpollPlugin) InitAPI() *mux.Router {
	r := mux.NewRouter()
	r.HandleFunc("/", p.handleInfo).Methods(http.MethodGet)
	r.HandleFunc("/"+iconFilename, p.handleLogo).Methods(http.MethodGet)

	apiV1 := r.PathPrefix("/api/v1").Subrouter()
	apiV1.Use(checkAuthenticity)
	apiV1.HandleFunc("/configuration", p.handlePluginConfiguration).Methods(http.MethodGet)

	apiV1.HandleFunc("/polls/create", p.handleSubmitDialogRequest(p.handleCreatePoll)).Methods(http.MethodPost)
	pollRouter := apiV1.PathPrefix("/polls/{id:[a-z0-9]+}").Subrouter()
	pollRouter.HandleFunc("/vote/{optionNumber:[0-9]+}", p.handlePostActionIntegrationRequest(p.handleVote)).Methods(http.MethodPost)
	pollRouter.HandleFunc("/votes/reset", p.handlePostActionIntegrationRequest(p.handleResetVotes)).Methods(http.MethodPost)
	pollRouter.HandleFunc("/option/add/request", p.handlePostActionIntegrationRequest(p.handleAddOption)).Methods(http.MethodPost)
	pollRouter.HandleFunc("/option/add", p.handleSubmitDialogRequest(p.handleAddOptionConfirm)).Methods(http.MethodPost)
	pollRouter.HandleFunc("/end", p.handlePostActionIntegrationRequest(p.handleEndPoll)).Methods(http.MethodPost)
	pollRouter.HandleFunc("/end/confirm", p.handleSubmitDialogRequest(p.handleEndPollConfirm)).Methods(http.MethodPost)
	pollRouter.HandleFunc("/delete", p.handlePostActionIntegrationRequest(p.handleDeletePoll)).Methods(http.MethodPost)
	pollRouter.HandleFunc("/delete/confirm", p.handleSubmitDialogRequest(p.handleDeletePollConfirm)).Methods(http.MethodPost)
	pollRouter.HandleFunc("/metadata", p.handlePollMetadata).Methods(http.MethodGet)
	return r
}

func (p *MatterpollPlugin) ServeHTTP(c *plugin.Context, w http.ResponseWriter, r *http.Request) {
	p.API.LogDebug("New request:", "Host", r.Host, "RequestURI", r.RequestURI, "Method", r.Method)
	p.router.ServeHTTP(w, r)
}
...
```

[https://github.com/matterpoll/matterpoll/blob/45f095875a98fb1d4f3f166851c86f41b987493e/server/plugin/api.go#L70](https://github.com/matterpoll/matterpoll/blob/45f095875a98fb1d4f3f166851c86f41b987493e/server/plugin/api.go#L70)

#### Key-Value ã‚¹ãƒˆã‚¢ ã«ã‚ˆã‚‹æŠ•ç¥¨ãƒ‡ãƒ¼ã‚¿ã®ç®¡ç†

ã“ã“ã¾ã§ã€ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã‚‹æŠ•ç¥¨ã®ä½œæˆã€Interactive Message ã«ã‚ˆã‚‹æŠ•ç¥¨å‡¦ç†ã«ã¤ã„ã¦èª¬æ˜ã—ã¦ãã¾ã—ãŸãŒã€æŠ•ç¥¨æ©Ÿèƒ½ã‚’å®Ÿç¾ã™ã‚‹ã«ã¯ã€ã“ã‚Œã‚‰ã®æŠ•ç¥¨ã«é–¢ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ“ä½œã‚’è¨˜éŒ²ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚Mattermost ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§ã¯å„ãƒ—ãƒ©ã‚°ã‚¤ãƒ³æ¯ã«å°‚ç”¨ã® Key Value ã‚¹ãƒˆã‚¢ãŒç”¨æ„ã•ã‚Œã¦ãŠã‚Šã€Matterpoll ã§ã¯æŠ•ç¥¨ã«é–¢ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«ã“ã® Key-Value ã‚¹ãƒˆã‚¢ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚

![matterpoll-kv.dio.png](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day22/matterpoll-kv.dio.png)

æŠ•ç¥¨ãƒ‡ãƒ¼ã‚¿ã® Key ã¯ `poll_` ã‚’æ¥é ­è¾ã«ã‚‚ã¤æŠ•ç¥¨ ID ã§ã‚ã‚Šã€æŠ•ç¥¨ ID ã¯æŠ•ç¥¨ãŒä½œæˆã•ã‚Œã‚‹ã”ã¨ã« Mattermost æœ¬ä½“ã®[`model.NewID`](<[https://github.com/mattermost/mattermost-server/blob/00ed2b138b0099be64a5f6b829ad916c220e1d6a/model/utils.go#L160](https://github.com/mattermost/mattermost-server/blob/00ed2b138b0099be64a5f6b829ad916c220e1d6a/model/utils.go#L160)>)ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã£ã¦ä¹±æ•°ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™ã€‚Mattermost Plugin ã® Key Value ã‚¹ãƒˆã‚¢ã«ã¯`[]byte`å‹ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿æ ¼ç´ã§ãã‚‹ãŸã‚ã€æŠ•ç¥¨çŠ¶æ…‹ã‚’æŒã¤[Poll](<[https://github.com/matterpoll/matterpoll/blob/22dc39da19825ef10c59e35d28359c02c220debb/server/poll/poll.go#L23](https://github.com/matterpoll/matterpoll/blob/22dc39da19825ef10c59e35d28359c02c220debb/server/poll/poll.go#L23)>)æ§‹é€ ä½“ã‚’ JSON å½¢å¼ã® `[]byte` ã«å¤‰æ›ã—ãŸå€¤ã‚’æ ¼ç´ã—ã¦ã„ã¾ã™ã€‚

```go:server/plugin/poll.go
...
// Poll stores all needed information for a poll
type Poll struct {
	ID            string
	PostID        string `json:"post_id,omitempty"`
	CreatedAt     int64
	Creator       string
	Question      string
	AnswerOptions []*AnswerOption
	Settings      Settings
}
...
// EncodeToByte returns a poll as a byte array
func (p *Poll) EncodeToByte() []byte {
	b, _ := json.Marshal(p)
	return b
}
...
```

[https://github.com/matterpoll/matterpoll/blob/45f095875a98fb1d4f3f166851c86f41b987493e/server/poll/poll.go#L23](https://github.com/matterpoll/matterpoll/blob/45f095875a98fb1d4f3f166851c86f41b987493e/server/poll/poll.go#L23)

Key Value ã‚¹ãƒˆã‚¢ã¯ã€å˜ç´”ã«[KVSet](<[https://developers.mattermost.com/extend/plugins/server/reference/#API.KVSet](https://developers.mattermost.com/extend/plugins/server/reference/#API.KVSet)>) ã§å€¤ã®æ ¼ç´ã€[KVGet](<[https://developers.mattermost.com/extend/plugins/server/reference/#API.KVGet](https://developers.mattermost.com/extend/plugins/server/reference/#API.KVGet)>)ã§å€¤ã®å–å¾—ã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ãŒã€Matterpoll ã§ã¯åŒæ™‚ã«æŠ•ç¥¨æ“ä½œãŒè¡Œã‚ã‚ŒãŸå ´åˆãªã©ã«ä¸æ•´åˆãŒèµ·ããªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ã™ã‚‹éš›ã¯ Atomic ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä»˜ã‘ã¦å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚

```go
...
// Update updates an existing a poll in the KV Store.
func (s *PollStore) Update(prev *poll.Poll, new *poll.Poll) error {
	opt := model.PluginKVSetOptions{
		Atomic:   true,
		OldValue: prev.EncodeToByte(),
	}
	ok, err := s.api.KVSetWithOptions(pollPrefix+prev.ID, new.EncodeToByte(), opt)
	if err != nil {
		return err
	}
  ...
}
...
```

ã¾ãŸã€Matterpoll ã§ã¯ã€[Key Value ã‚¹ãƒˆã‚¢ ã¸ã®å‡¦ç†ã¯å…¨ã¦ interface ã‚’ç”¨æ„ã—ã¦ã„ã¾ã™](<[https://github.com/matterpoll/matterpoll/blob/22dc39da19825ef10c59e35d28359c02c220debb/server/store/store.go](https://github.com/matterpoll/matterpoll/blob/22dc39da19825ef10c59e35d28359c02c220debb/server/store/store.go)>)ãŒã€ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆç”¨ã« [mockery](<[https://github.com/vektra/mockery](https://github.com/vektra/mockery)>) ã§ãƒ¢ãƒƒã‚¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è‡ªå‹•ã§ä½œæˆã™ã‚‹ãŸã‚ã§ã™ã€‚

## ã•ã„ã”ã«

æœ¬æ—¥ã¯ã€Mattermost ä¸Šã§æŠ•ç¥¨ã‚’è¡Œãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ Matterpoll Plugin ã®æ¦‚è¦ã¨ Server å´ã®å®Ÿè£…ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã—ãŸã€‚
æ˜æ—¥ã¯ã€Matterpoll Plugin ã® Webapp å´ã®å®Ÿè£…ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã™ã€‚
