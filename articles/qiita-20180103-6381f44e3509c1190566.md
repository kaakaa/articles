---
title: "Mattermostã«Redashã®ãƒãƒ£ãƒ¼ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã‚‹"
date: 2018-01-03T00:00:00+09:00
emoji: "ğŸ“Š"
type: "tech"
topics: ["Mattermost"]
published: true
aliases: "/post/mattermostã«redashã®ãƒãƒ£ãƒ¼ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã‚‹"
---

# ã¯ã˜ã‚ã«

Redash ã§ã‚¢ã‚¯ã‚»ã‚¹æ•°ã‚’å¯è¦–åŒ–ã—ã¦ã‚‹ã®ã§ã™ãŒã€ã‚ã–ã‚ã– Redash ã‚’é–‹ãã®ãŒé¢å€’ã«ãªã£ã¦ããŸã®ã§ Mattermost ã‹ã‚‰ Redash ã®ãƒãƒ£ãƒ¼ãƒˆã‚’å–å¾—ã§ãã‚‹[kaakaa/matter-redash](https://github.com/kaakaa/matter-redash)ã¨ã„ã†ã‚‚ã®ã‚’ä½œã‚Šã¾ã—ãŸã€‚

Slack ã ã¨ Redash é€£æºã¯è‰²ã€…ã‚ã‚‹ã®ã« Mattermost ã§ã¯è¦‹å½“ãŸã‚‰ãªã„ = ä½œã‚‹ã—ã‹ãªã„ã€‚
[re:dash ã« slack bot æ©Ÿèƒ½ãŒè¿½åŠ ã•ã‚ŒãŸã‚ˆï¼ - Qiita](https://qiita.com/toru-takahashi/items/e86acc292e0b3dc360e8)
[hakobera/redashbot: Slack Bot for re:dash](https://github.com/hakobera/redashbot)

# ã©ã‚“ãªã‚‚ã®ï¼Ÿ

Mattermost ã® Slash Command ã¨ã—ã¦å‹•ãã¾ã™ã€‚

![matter-redash.gif](https://qiita-image-store.s3.amazonaws.com/0/9891/2de5c4ed-2a28-d9e2-fe33-b4fac2b585c5.gif)

# ã©ã†ã‚„ã£ã¦å‹•ã‹ã™ï¼Ÿ

[kaakaa/matter-redash: Redash integrations for Mattermost](https://github.com/kaakaa/matter-redash)ã® README ã«æ›¸ã„ã¦ã„ã¾ã™ã€‚

# ã©ã†ã„ã†é¢¨ã«å‹•ã„ã¦ã‚‹ï¼Ÿ

- Mattermost ã® Slash Command ã§`matter-redash`ã¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆé£›ã°ã™
- å¼•æ•°ã§æŒ‡å®šã•ã‚ŒãŸãƒãƒ£ãƒ¼ãƒˆç”»åƒã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’å–å¾—
- Mattermost ã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼†ãƒãƒ£ãƒ¼ãƒˆã‚’æŠ•ç¨¿

ã¨ã„ã†æµã‚Œã§ã™ã€‚

ä»¥ä¸‹ã€ã„ãã¤ã‹ã¤ã¾ã¥ã„ãŸã¨ã“ã‚ã€‚

## Redash

Redash ã‹ã‚‰ãƒãƒ£ãƒ¼ãƒˆç”»åƒã‚’å–å¾—ã™ã‚‹ãŸã‚ã«`/embed` API ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚ï¼ˆRedash ã® API Spec ã¯ã©ã“ã‹ã«ç„¡ã„ã ã‚ã†ã‹ãƒ»ãƒ»ï¼‰
[redash/embed.py at 1ef2238d65c0c87ed0bc74141cca44b7766b8453 Â· getredash/redash](https://github.com/getredash/redash/blob/1ef2238d65c0c87ed0bc74141cca44b7766b8453/redash/handlers/embed.py#L69)

ã“ã® API ã‚’å©ãã¨ SVG å…¥ã‚Šã® HTML ãŒå–å¾—ã§ãã€ãã®ã¾ã¾ã§ã¯ Mattermost ã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã§ããªã„ã®ã§[GoogleChrome/puppeteer](https://github.com/GoogleChrome/puppeteer)ã‚’ä½¿ã£ã¦ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ’®ã‚Šã€ãã®ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ Mattermost ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã„ã¾ã™ã€‚

```js:app/mattermost.js#L35
const embedUrl = util.format('%s://%s/embed/query/%d/visualization/%d?api_key=%s', protocol, redashHost, queryId, visualizationId, config.redash.apiKey);
console.log('Redash Embed URL: %s', embedUrl); // eslint-disable-line no-console |
const file = await webshot(embedUrl); |
```

```js:app/webshot.js#L4
const webshot = async (url) => {
    const tmpFile = tempfile('.png');
    const browser = await puppeteer.launch();
    const page = await browser.newPage();

    await page.goto(url);
    await page.screenshot({path: tmpFile});
    await browser.close();

    return tmpFile;
};
```

ãã“ã‚‰è¾ºã®å®Ÿè£…æ–¹æ³•ã«ã¤ã„ã¦ã¯[hakobera/redashbot](https://github.com/hakobera/redashbot)ã‚’å‚è€ƒã«ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚

## Mattermost

### Personal Access Token

Mattermost ã« API çµŒç”±ã§ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãŸã‚ã«æŠ•ç¨¿æ¨©é™ãŒå¿…è¦ã§ã€ä»Šã®æ‰€[Personal Access Token](https://docs.mattermost.com/developer/personal-access-tokens.html)ã®ã¿ã‚µãƒãƒ¼ãƒˆã—ã¦ã¾ã™ã€‚
ãªã®ã§ã€Mattermost ã¯ Personal Access Token ãŒå®Ÿè£…ã•ã‚ŒãŸ`v4.1.2`ä»¥ä¸Šã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### Public Link

Mattermost ä¸Šã§ãƒãƒ£ãƒ¼ãƒˆç”»åƒã‚’è¦‹ã‚„ã™ãã™ã‚‹ãŸã‚ã€ä¸€æ—¦ãƒãƒ£ãƒ¼ãƒˆç”»åƒã‚’ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦æŠ•ç¨¿ã—ã€[ãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾ã™ã‚‹å…¬é–‹ãƒªãƒ³ã‚¯]([Sharing Files â€” Mattermost 4.5 documentation](https://docs.mattermost.com/help/messaging/attaching-files.html#sharing-public-links))ã‚’å–å¾—ã—ã€[Message Attachments](https://docs.mattermost.com/developer/message-attachments.html#images)ã¨ã—ã¦æŠ•ç¨¿ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

```js:app/mattermost.js#L39
    // Upload webshot image file
    const imageFormData = new FormData();
    imageFormData.append('files', fs.createReadStream(file));
    imageFormData.append('channel_id', req.body.channel_id);

    const uploadFile = await client.uploadFile(imageFormData, imageFormData.getBoundary());

    // Get public link of uploaded file
    const fileId = uploadFile.file_infos[0].id;
    const post = await client.createPost({
        channel_id: req.body.channel_id,
        message: 'This message is posted solely to get the public link and should be deleted immediately.',
        file_ids: [fileId]
    });
    const link = await client.getFilePublicLink(fileId);
    console.log('Mattermost Public Link: %s', link.link); // eslint-disable-line no-console

    // Response to Mattermost
    res.header({'content-type': 'application/json'});
    res.send(commandResponse(url, link.link));

    // Delete unnecessary post.
    client.deletePost(post.id);
```

æœ€å¾Œã«ä¸è¦ãª Post ã‚’å‰Šé™¤ã—ã¦ã„ã¾ã™ãŒã€ã“ã‚Œã¯ Mattermost ã®ä»•æ§˜ä¸Šã€ä¸€åº¦ Post ã«å¯¾ã™ã‚‹æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦æŠ•ç¨¿ã—ãªã„ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã®å…¬é–‹ãƒªãƒ³ã‚¯ã‚’å–å¾—ã§ããªã„ãŸã‚ã§ã™ã€‚
ãªã®ã§ã€å®Ÿè¡Œã”ã¨ã«`(ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸ)`ã¨ã„ã†æŠ•ç¨¿ãŒç™ºç”Ÿã—ã¦ã„ã¾ã†ã®ã§å°‘ã—æ°—æŒã¡æ‚ªã„ã§ã™ã€‚

### æ³¨æ„ç‚¹

Personal Access Token ã‚‚ Public Link ã‚‚è¨­å®šã§ç„¡åŠ¹ã«ã§ããŸã‚Šã™ã‚‹ã®ã§ã€ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰æœ‰åŠ¹ã«ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## ãŠã‚ã‚Šã«

ã¨ã‚Šã‚ãˆãšé‹ç”¨ã—ã¦ã¿ã¦ã€ä½¿ãˆãã†ãªã‚‰[Share your Mattermost projects | Mattermost](https://www.mattermost.org/share-your-mattermost-projects/)ã‹ã‚‰ Mattermost ãƒãƒ¼ãƒ ã«å ±å‘Šã™ã‚‹æ‰€å­˜ã€‚

ã‚ã¨ã€[Mattermost ãƒ—ãƒ©ã‚°ã‚¤ãƒ³](https://docs.mattermost.com/administration/plugins.html)ã¨ã—ã¦ä½œã‚Šç›´ã—ãŸã„ãªã€‚
