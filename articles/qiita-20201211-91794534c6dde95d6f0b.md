---
title: "[Mattermost Integrations] REST API (WebSocket)"
date: 2020-12-11T00:00:00+09:00
emoji: "ğŸ“†"
type: "tech"
topics: ["Mattermost"]
published: true
---

Mattermost è¨˜äº‹ã¾ã¨ã‚: https://blog.kaakaa.dev/tags/mattermost/

## æœ¬è¨˜äº‹ã«ã¤ã„ã¦

[Mattermost ã®çµ±åˆæ©Ÿèƒ½ã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼](https://qiita.com/advent-calendar/2020/mattermost-integrations)ã®ç¬¬ 11 æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚

æœ¬è¨˜äº‹ã§ã¯ã€Mattermost ã® WebSocket API ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã™ã€‚

## WebSocket API ã®æ¦‚è¦

Mattermost ã¯ WebSocket API ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€Mattermost ä¸Šã§ã‚„ã‚Šå–ã‚Šã•ã‚Œã¦ã„ã‚‹ WebSocket ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

WebSocket API ã«ã¤ã„ã¦ã¯ REST API ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«èª¬æ˜ãŒã‚ã‚Šã¾ã™ã€‚
https://api.mattermost.com/#tag/WebSocket

## WebSocket ã‚¤ãƒ™ãƒ³ãƒˆã®å–å¾—

Mattermost ã® WebSocket Event ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ã€Mattermost å…¬å¼ã® WebSocket ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ [websocket_client.go](https://github.com/mattermost/mattermost-server/blob/master/model/websocket_client.go) ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

```go
package main

import (
	"log"

	"github.com/mattermost/mattermost-server/v5/model"
)

const (
  // (1) Mattermost WebSocket Endpoint
  MattermostWebSocketURL = "ws://localhost:8065"
  // (2) Access Token
	AccessToken            = "4cacdozwn3fndnzobbpha3nnhy"
)

func main() {
  // (3) WebSocket Clientã®æ§‹ç¯‰
	client, appErr := model.NewWebSocketClient4(MattermostWebSocketURL, AccessToken)
	if appErr != nil {
		log.Fatal(appErr.Error())
	}

  // (4) æ¥ç¶š
	if appErr = client.Connect(); appErr != nil {
		log.Fatal(appErr.Error())
	}
	client.Listen()

	for {
		select {
    case event := <-client.EventChannel:
      // (5) WebSocket Eventã«ã¤ã„ã¦ã®å‡¦ç†
			log.Printf("Received: %v", event)
		}
	}
}
```

`(1)`ã§ Mattermost WebSocket ã® URL ã‚’å®£è¨€ã—ã¦ã„ã¾ã™ã€‚ãƒ—ãƒ­ãƒˆã‚³ãƒ«ãŒ`http(s)`ã§ã¯ãªã`ws(s)`ã«ãªã‚Šã¾ã™ã€‚ã¾ãŸã€WebSocket API ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯`/api/v4/websocket`ã§ã™ãŒã€ã“ã®éƒ¨åˆ†ã¯ Mattermost ã® WebSocket Driver ãŒä»˜ä¸ã—ã¦ãã‚Œã¾ã™ã€‚
`(2)`ã§ã¯ WebSocket API ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã™ã‚‹ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å®£è¨€ã—ã¦ã„ã¾ã™ã€‚REST API å®Ÿè¡Œç”¨ã¨åŒã˜ Token ã§ã™ã€‚

`(3)`ã§ã€Mattermost ã® WebSocket Driver ã‚’åˆ©ç”¨ã—ã¦ WebSocket ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ç”Ÿæˆã—ã€ã“ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½¿ã£ã¦`(4)`ã§ WebSocket API ã¸æ¥ç¶šã—ã¦ã„ã¾ã™ã€‚

æ¥ç¶šãŒå•é¡Œãªãå®Œäº†ã™ã‚‹ã¨ã€ WebSocket ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®`EventChannel`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã« WebSocket Event ãŒæµã‚Œã¦ãã¾ã™ã€‚`(5)`ã§ã€æµã‚Œã¦ããŸã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡ºåŠ›ã—ã¦ã„ã¾ã™ã€‚

ä¸Šè¨˜ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãŠãã¨ã€Mattermost ä¸Šã§ä½•ã‹æ“ä½œã‚’ã—ãŸæ™‚ã« WebSocket Event ãŒã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

![video](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day11/example-websocket-api.gif)

`Ctrl + c`ã‚’å…¥åŠ›ã™ã‚‹ã¨ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’çµ‚äº†ã—ã¾ã™ã€‚

ä»Šå›ã¯å˜ã«å—ã‘å–ã£ãŸã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã‚’å‡ºåŠ›ã™ã‚‹ã ã‘ã§ã—ãŸãŒã€å—ã‘å–ã£ãŸ[WebSocketEvent](https://github.com/mattermost/mattermost-server/blob/c54ab6da211af861b25af1364518e549d3a1ed91/model/websocket_message.go#L109)ã®å†…å®¹ã«å¿œã˜ãŸå‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
`WebSocketEvent`æ§‹é€ ä½“ã®`Data`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å†…å®¹ã¯ã‚¤ãƒ™ãƒ³ãƒˆã®ç¨®é¡ã«ã‚ˆã£ã¦ç•°ãªã‚Šã€ã‚¤ãƒ™ãƒ³ãƒˆã®ç¨®é¡ã¯ä¸‹è¨˜ã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚
https://github.com/mattermost/mattermost-server/blob/c54ab6da211af861b25af1364518e549d3a1ed91/model/websocket_message.go#L14

## WebSocket API ã®å®Ÿè¡Œ

Mattermost ã§ã¯ WebSocket API ã‚’é€šã˜ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ã‚ˆã†ã§ã™ãŒã€ç¾åœ¨åˆ©ç”¨å¯èƒ½ãªã®ãŒä¸‹è¨˜ 3 ç¨®é¡ã®ã¿ã®ã‚ˆã†ã§ã€ã¡ã‚‡ã£ã¨ç”¨é€”ãŒä»Šã®ã¨ã“ã‚åˆ†ã‹ã‚Šã¾ã›ã‚“ã€‚

- user_typing
- get_statuses
- get_statuses_by_id

## ã•ã„ã”ã«

Mattermost WebSocket API ã®ä½¿ã„æ–¹ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã—ãŸã€‚
æ˜æ—¥ã¯ã€Bot ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä½¿ã„æ–¹ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚
