---
title: "[Mattermost Integrations] Plugin"
---


## Mattermost Plugin

Mattermost Plugin ã¯ã€Mattermost ã®æ§˜ã€…ãªç®‡æ‰€ã«å­˜åœ¨ã™ã‚‹æ‹¡å¼µãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ã£ã¦ã‚ˆã‚Šå¹…åºƒãã€ã‚³ã‚¢ã«è¿‘ã„éƒ¨åˆ†ã«å‡¦ç†ã‚’å·®ã—è¾¼ã‚€ã“ã¨ãŒã§ãã‚‹æ©Ÿèƒ½ã§ã™ã€‚ä»Šã¾ã§ç´¹ä»‹ã—ã¦ããŸçµ±åˆæ©Ÿèƒ½ã«æ¯”ã¹ã¦ã€ä¸‹è¨˜ï¼’ç‚¹ã§å„ªã‚Œã¦ã„ã‚‹ã¨å€‹äººçš„ã«æ€ã£ã¦ã„ã¾ã™ã€‚

1. æŠ•ç¨¿ä»¥å¤–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¡Œå‹•ã«å¯¾ã—ã¦ç‹¬è‡ªã®å‡¦ç†ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ãŒã§ãã‚‹
2. Mattermost ã¨åŒã˜ã‚µãƒ¼ãƒãƒ¼ä¸Šã§å‹•ã‹ã™ã“ã¨ãŒã§ãã€ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†ã‚‚ Mattermost ã«ä»»ã›ã‚‰ã‚Œã‚‹

`1.`ã®ç‚¹ã«ã¤ã„ã¦ã¯ã€ä»Šã¾ã§ç´¹ä»‹ã—ã¦ããŸçµ±åˆæ©Ÿèƒ½ã¯ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æŠ•ç¨¿ã‚„ Slash Command ã®å®Ÿè¡Œãªã© Mattermost ä¸Šã§æŠ•ç¨¿æ“ä½œãŒè¡Œã‚ã‚ŒãŸéš›ã«ç‹¬è‡ªã®å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã¨ã„ã†ã‚‚ã®ã§ã—ãŸã€‚ã—ã‹ã—ã€Plugin æ©Ÿèƒ½ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹æŠ•ç¨¿æ“ä½œã®ä»–ã«ã‚‚ãƒãƒ£ãƒ³ãƒãƒ«/ãƒãƒ¼ãƒ ã¸ã®å‚åŠ /è„±é€€ã‚„ãƒãƒ£ãƒ³ãƒãƒ«ä½œæˆæ™‚ãªã©ã€Mattermost ä¸Šã®æ§˜ã€…ãªæ“ä½œã«åå¿œã—ã¦ç‹¬è‡ªã®å‡¦ç†ã‚’å®Ÿè¡Œã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã¾ãŸã€æŠ•ç¨¿æ“ä½œã«ã¤ã„ã¦ã‚‚ã€æŠ•ç¨¿ãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã•ã‚Œã‚‹å‰å¾Œã§å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã‚‹ãŸã‚ã€æŠ•ç¨¿ãŒä½œæˆã•ã‚Œã‚‹å‰ã« Reject ã™ã‚‹ã‚ˆã†ãªã“ã¨ã‚‚ã§ãã¾ã™ã€‚

`2.`ã®ç‚¹ã«ã¤ã„ã¦ã¯ WebSocket API ã‚’ä½¿ã†ã“ã¨ã§å®Ÿç¾ã§ããŸã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€WebSocket API ã‚’å§‹ã‚ Mattermost ã®çµ±åˆæ©Ÿèƒ½ã‚’ä½¿ã†ã«ã¯ã€Mattermost ã¨ã¯åˆ¥ã«çµ±åˆæ©Ÿèƒ½ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã‚‹ã‚µãƒ¼ãƒãƒ¼ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚ã—ã‹ã—ã€Mattermost Plugin ã¯ã€ãã®ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†ã‚’ Mattermost è‡ªèº«ãŒè¡Œã†ãŸã‚ã€Mattermost ä»¥å¤–ã®ã‚µãƒ¼ãƒãƒ¼ã‚’ç®¡ç†ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã“ã‚ŒãŒ`2.`ã®åˆ©ç‚¹ã§ã™ã€‚ã•ã‚‰ã«ã€Mattermost Plugin ã§ã¯ Plugin ç”¨ã® Key-Value ã‚¹ãƒˆã‚¢ã‚‚ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ç°¡å˜ãªãƒ‡ãƒ¼ã‚¿ã®ä¿æŒã§ã‚ã‚Œã° Mattermost ã«ä»»ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

Mattermost Plugin ã¯ã€ã‚µãƒ¼ãƒãƒ¼å´ã§å‹•ä½œã™ã‚‹**Server**ã‚µã‚¤ãƒ‰ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¨ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§å‹•ä½œã™ã‚‹**Webapp**ã‚µã‚¤ãƒ‰ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒã‚ã‚Šã¾ã™ã€‚ä¸€ã¤ã® Plugin ã«ä¸¡æ–¹ã®æ©Ÿèƒ½ã‚’æŒãŸã›ã¦ã‚‚è‰¯ã„ã§ã™ã—ã€ã©ã¡ã‚‰ã‹ä¸€æ–¹ã®æ©Ÿèƒ½ã ã‘ã® Plugin ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

## Mattermost Plugin ã®ä½¿ç”¨

ã¾ãšã€Mattermost Plugin ã‚’ä½¿ã£ã¦ã¿ã‚‹ã¨ã“ã‚ã‹ã‚‰ç´¹ä»‹ã—ã¾ã™ã€‚

ä»Šå›ã¯ã€ç§ã‚‚é–‹ç™ºã«å‚åŠ ã—ã¦ã„ã‚‹ Mattermost ä¸Šã§æŠ•ç¥¨æ©Ÿèƒ½ã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã‚‹[Matterpoll ãƒ—ãƒ©ã‚°ã‚¤ãƒ³](https://github.com/matterpoll/matterpoll)ã‚’æ‰‹å‹•ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã¿ã¾ã™ã€‚

https://github.com/matterpoll/matterpoll

![matterpoll](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day17/matterpoll.png)

### è¨­å®š

ã¾ãšã€Mattermost Plugin ã‚’ä½¿ã†ã«ã¯ã€**ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ³ã‚½ãƒ¼ãƒ« > ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç®¡ç† > ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹**ãŒ`æœ‰åŠ¹`ã«ãªã£ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

![config plugin](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day17/config-plugin.png)

ã¾ãŸã€æ‰‹å‹•ã§ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’è¡Œã†å ´åˆã€**ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ³ã‚½ãƒ¼ãƒ« > ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç®¡ç† > ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹**ã®`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã™ã‚‹`ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã‚‚ã—ã€ã“ã®ãƒœã‚¿ãƒ³ãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€Mattermost ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‚µãƒ¼ãƒãƒ¼ã® Mattermost ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚ã‚‹`config/config.json`ã®`EnableUploads`ã‚’`true`ã«ã—ã€Mattermost ã‚’å†èµ·å‹•ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```config.json
    ...
    "PluginSettings": {
        "Enable": true,
        "EnableUploads": true,
    ...
```

### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

Plugin ã‚’ä½¿ç”¨ã™ã‚‹è¨­å®šãŒå®Œäº†ã—ãŸã‚‰ã€ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã‹ã‚‰`com.github.matterpoll.matterpoll-1.4.0.tar.gz`ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€**ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ³ã‚½ãƒ¼ãƒ« > ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç®¡ç† > ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹**ã‹ã‚‰ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚

https://github.com/matterpoll/matterpoll/releases/tag/v1.4.0

(Matterpoll v1.4.0 ã¯**Mattermost v5.20**ä»¥ä¸Šã‚’å¯¾è±¡ã¨ã—ã¦ã„ã‚‹ãŸã‚ã€ãã‚Œã‚ˆã‚Šå¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã¯ã€Matterpoll ã‚‚å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚‚ã®ã‚’ãŠä½¿ã„ãã ã•ã„)

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒæ­£å¸¸ã«çµ‚äº†ã™ã‚‹ã¨ã€`ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ãƒ—ãƒ©ã‚°ã‚¤ãƒ³`ã®ã¨ã“ã‚ã« Matterpoll ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚Matterpoll ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ã¨ã“ã‚ã«ã‚ã‚‹`æœ‰åŠ¹ã«ã™ã‚‹`ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã“ã¨ã§ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’æœ‰åŠ¹ã«ã§ãã¾ã™ã€‚

![install plugin](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day17/install-plugin.png)

### å®Ÿè¡Œ

Matterpoll ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒå•é¡Œãªãèµ·å‹•ã§ãã‚Œã°ã€Matterpoll ã®æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚Matterpoll ã¯ Slash Command ã§æŠ•ç¥¨ã‚’ä½œæˆã™ã‚‹ãŸã‚ã€ãƒãƒ£ãƒ³ãƒãƒ«ã«æˆ»ã‚Š `/poll help` ã¨æ‰“ã¤ã¨ã€Matterpoll ã®ãƒ˜ãƒ«ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå‡ºã¦ãã¾ã™ã€‚

![execute plugin](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day17/execute-plugin.png)

## Mattermost Plugin ã®é–‹ç™º

å…ˆã»ã©ã‚‚è¦‹ãŸã‚ˆã†ã«ã€Mattermost Plugin ã®æœ¬ä½“ã¯`.tar.gz`ãƒ•ã‚¡ã‚¤ãƒ«ã«ãªã‚Šã¾ã™ã€‚ã“ã®`.tar.gz`ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚„ã€Server ã‚µã‚¤ãƒ‰æ©Ÿèƒ½ã®ãƒã‚¤ãƒŠãƒªã€Webapp ã‚µã‚¤ãƒ‰ã®`.js`ãƒ•ã‚¡ã‚¤ãƒ«ãªã©ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

æ¯å›ä¸€ã‹ã‚‰ã“ã‚Œã‚‰ã‚’ç”¨æ„ã™ã‚‹ã®ã¯å¤§å¤‰ãªãŸã‚ã€Mattermost ãƒãƒ¼ãƒ ã¯ Mattermost Plugin é–‹ç™ºç”¨ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã‚’å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚

https://github.com/mattermost/mattermost-plugin-starter-template

ã“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã‚’ä½¿ã£ãŸ Mattermost Plugin ã®é–‹ç™ºæ–¹æ³•ã¯ã€ä»¥ä¸‹ã®è¨˜äº‹ã§æ—¢ã«ç´¹ä»‹ã—ã¦ã„ã‚‹ãŸã‚ã€ã“ã“ã§ã®èª¬æ˜ã¯å‰²æ„›ã—ã¾ã™ã€‚

[Mattermost ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç”¨ã® GitHub ãƒªãƒã‚¸ãƒˆãƒªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ã£ã¦ã¿ã‚‹ \- Qiita](https://qiita.com/kaakaa_hoe/items/6f3d1aa0a126f2e94e01)

## Mattermost Demo Plugin

Mattermost Plugin ã§ã¯ Mattermost ã®æ§˜ã€…ãªç®‡æ‰€ã‚’æ‹¡å¼µã§ãã¾ã™ãŒã€Plugin ã§æ‹¡å¼µã§ãã‚‹ç®‡æ‰€ã‚’ç´¹ä»‹ã™ã‚‹ Demo ç”¨ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒå…¬é–‹ã•ã‚Œã¦ã„ã¾ã™ã€‚

https://github.com/mattermost/mattermost-plugin-demo

ã“ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã“ã¨ã§ã€å…¨ã¦ã§ã¯ãªã„ã§ã™ãŒ Mattermost Plugin ã§æ‹¡å¼µå¯èƒ½ãªç®‡æ‰€ã‚’ç¢ºèªã§ãã¾ã™ã€‚


## Mattermost Plugin (Server) ã«ã¤ã„ã¦

**Server Hooks**ã®èª¬æ˜ã®å‰ã«ã€Mattermost Plugin ã®æœ¬ä½“ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã™ã€‚

Mattermost ã®**Server**ã‚µã‚¤ãƒ‰ã® Plugin ã‚’å®Ÿè£…ã™ã‚‹å ´åˆã€[`plugin.MattermostPlugin`](https://github.com/mattermost/mattermost-server/blob/f2571099539ee6e432d59e5bb4bc390652426a0e/plugin/client.go#L39)ã‚’åŸ‹ã‚è¾¼ã‚“ã æ§‹é€ ä½“ãŒ Plugin æœ¬ä½“ã¨ãªã‚Šã¾ã™ã€‚`plugin.MattermostPlugin`ã‚’åŸ‹ã‚è¾¼ã‚“ã æ§‹é€ ä½“ã¯ã€`API`ã¨`Helper`ã¨ã„ã†ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŒã¡ã€ã“ã‚Œã‚‰ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’çµŒç”±ã—ã¦ Mattermost ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å‡¦ç†ã™ã‚‹æ§˜ã€…ãªãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚ã¾ãŸã€`plugin.MattermostPlugin`ã‚’åŸ‹ã‚è¾¼ã‚“ã æ§‹é€ ä½“ã«å¯¾ã—ã¦**Server Hooks**ã¨åŒã˜ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æŒã¤ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã§ã€**Server Hooks**ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```go
package main

import (
	"github.com/mattermost/mattermost-server/v5/plugin"
)

type SamplePlugin struct {
	plugin.MattermostPlugin
}

// OnActivate Hooksã®å®Ÿè£…
func (p *SamplePlugin) OnActivate() error {
    // `API`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’é€šã˜ãŸPlugin APIã®å‘¼ã³å‡ºã—
	if err := p.API.RegisterCommand(&model.Command{
		Trigger: "sample-command",
	}); err != nil {
		return errors.Wrap(err, "failed to register  command")
	}
    return nil
}
```

`main`ãƒ¡ã‚½ãƒƒãƒ‰ã§`plugin.MattermostPlugin`ã‚’åŸ‹ã‚è¾¼ã‚“ã æ§‹é€ ä½“ã‚’å¼•æ•°ã¨ã—ã¦`plugin.ClientMain`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã¶ã“ã¨ã§ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’èµ·å‹•ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```go
package main

import (
	"github.com/mattermost/mattermost-server/v5/plugin"
)

func main() {
	plugin.ClientMain(&SamplePlugin{})
}
```

## Server Hooks

Mattermost Plugin ã® Server Hooks ã¯ã€Mattermost ä¸Šã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒãƒ£ãƒ³ãƒãƒ«ã«å‚åŠ ã—ãŸã¨ãã‚„ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ Mattermost ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸã¨ããªã©ã€ä½•ã‹ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«å¿œã˜ã¦å®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†ã‚’è¿½åŠ ã§ãã‚‹æ©Ÿèƒ½ã§ã™ã€‚
`plugin.MattermostPlugin`ã‚’åŸ‹ã‚è¾¼ã‚“ã æ§‹é€ ä½“ã«ã€Server Hooks ã¨åŒã˜ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æŒã¤ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã§åˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

Server Hooks ã®ä¸€è¦§ã¯ä¸‹è¨˜ã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚

https://developers.mattermost.com/extend/plugins/server/reference/#Hooks

### OnActivate

`OnActivate` ã¯ Plugin ãŒèµ·å‹•ã—ãŸã¨ãã«å‘¼ã°ã‚Œã‚‹ Hook ã§ã™ã€‚Bot ã‚’ä½¿ã† Plugin ã®å ´åˆã¯ã“ã® Hook å†…ã§ Bot ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ãŸã‚Šã€Slash Command ã‚’ä½¿ã† Plugin ãªã‚‰ SlashCommand ã®ç™»éŒ²ãªã©ã‚’è¡Œã„ã¾ã™ã€‚(Plugin ã‹ã‚‰ç™»éŒ²ã—ãŸ Slash Command ã¯ã€é€šå¸¸ã®çµ±åˆæ©Ÿèƒ½ã¨ã—ã¦ä½œæˆã—ãŸ Slash Command ã¨é•ã„å¤–éƒ¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã€‚Slash Command ãŒå®Ÿè¡Œã•ã‚ŒãŸæ™‚ã®å‡¦ç†ã¯ã€Server Hooks ã®`ExecuteCommand`ã§å®Ÿè£…ã—ã¾ã™ã€‚)

`error``ãŒè¿”å´ã•ã‚ŒãŸå ´åˆã¯ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒèµ·å‹•ã•ã‚Œã¾ã›ã‚“ã€‚

```go
func (p *SamplePlugin) OnActivate() error {
	// Botã®ç™»éŒ²
	bot := &model.Bot{
		Username:    "test-bot",
		DisplayName: "Sample Bot",
	}
	botUserID, appErr := p.Helpers.EnsureBot(bot)
	if appErr != nil {
		return errors.Wrap(appErr, "failed to ensure bot user")
	}
	p.botUserID = botUserID

	// Slash Commandã®ç™»éŒ²
	if err := p.API.RegisterCommand(&model.Command{
		Trigger:      "sample",
		AutoComplete: true,
	}); err != nil {
		return errors.Wrap(err, "failed to register  command")
	}

    return nil
}
```

### Implemented

`Implemented`ã¯ã€Plugin ãŒå®Ÿè£…ã—ã¦ã„ã‚‹ Hook ã®åå‰ã‚’è¿”ã™ãŸã‚ã® Hooks ã§ã™ã€‚ã—ã‹ã—ã€å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã®ã‚’è¦‹ãŸã“ã¨ãŒãªã„ã®ã§ã€ç”¨é€”ã¯ãªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

```go
func (p *MatterpollPlugin) Implemented() ([]string, error) {
    return []string{"OnActivate", "Implemented"}, nil
}
```

### OnDeactivate

`OnDeactivate`ã¯ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒåœæ­¢ã•ã‚ŒãŸæ™‚ã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

```go
func (p *MatterpollPlugin) OnDeactivate() error {
    p.clean()
    return nil
}
```

### OnConfigurationChange

Plugin å°‚ç”¨ã®è¨­å®šãŒå¤‰æ›´ã•ã‚ŒãŸéš›ã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
Mattermost Plugin ã®[Manifest ãƒ•ã‚¡ã‚¤ãƒ«](https://developers.mattermost.com/extend/plugins/manifest-reference/)ã«`settings`ã‚’è¨˜è¿°ã™ã‚‹ã“ã¨ã§ã€Plugin å°‚ç”¨ã®è¨­å®šç”»é¢ã‚’æŒã¤ã“ã¨ãŒã§ãã¾ã™ã€‚

![IMAGE](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day18/configuration-page.png)

`OnConfigurationChange`å‘¨ã‚Šã®å‡¦ç†ã¯ä¸‹è¨˜ã® Starter ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ã‚³ãƒ¼ãƒ‰ã‚’æµç”¨ã™ã‚‹ã¨è‰¯ã„ã§ã™ã€‚
https://github.com/mattermost/mattermost-plugin-starter-template/blob/master/server/configuration.go

```go
type configuration struct {
	SampleSetting string
}

func (p *SamplePlugin) OnConfigurationChange() error {
	var configuration = new(configuration)

	// Load the public configuration fields from the Mattermost server configuration.
	if err := p.API.LoadPluginConfiguration(configuration); err != nil {
		return errors.Wrap(err, "failed to load plugin configuration")
	}

    p.setConfiguration(configuration)

	return nil
}
```

### ServeHTTP

Mattermost Plugin å°‚ç”¨ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å¯¾ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé€ä¿¡ã•ã‚ŒãŸæ™‚ã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

Mattermost Plugin ã«ã¯ Plugin ã”ã¨ã«ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå­˜åœ¨ã—ã¾ã™ã€‚Mattermost ãŒ`https://example.com:8065`ã§èµ·å‹•ã—ã¦ã„ãŸã¨ã™ã‚‹ã¨ã€`https://example.com:8065/plugins/{PLUGING_ID}`ãŒ Plugin å°‚ç”¨ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ãªã‚Šã¾ã™ã€‚ã“ã“ã«é€ã‚‰ã‚ŒãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã™ã‚‹ã®ãŒ`ServeHTTP`ã§ã™ã€‚

```go
func (p *SamplePlugin) ServeHTTP(c *plugin.Context, w http.ResponseWriter, r *http.Request) {
	fmt.Fprint(w, "Hello, world!")
}
```

[Interactive Message](https://docs.mattermost.com/developer/interactive-messages.html)ãªã©ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡å…ˆã‚’ Plugin ç”¨ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã™ã‚‹ãªã©ã®åˆ©ç”¨æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚

### ExecuteCommand

Plugin API ã®[`RegisterCommand`](https://developers.mattermost.com/extend/plugins/server/reference/#API.RegisterCommand)ã§ç™»éŒ²ã•ã‚ŒãŸã‚³ãƒãƒ³ãƒ‰ãŒå®Ÿè¡Œã•ã‚ŒãŸæ™‚ã«å‡¦ç†ã•ã‚Œã¾ã™ã€‚

```go
func (p *SamplePlugin) OnActivate() error {
	// Slash Commandã®ç™»éŒ²
	if err := p.API.RegisterCommand(&model.Command{
		Trigger:      "sample",
		AutoComplete: true,
	}); err != nil {
		return errors.Wrap(err, "failed to register  command")
	}

	return nil
}

func (p *SamplePlugin) ExecuteCommand(c *plugin.Context, args *model.CommandArgs) (*model.CommandResponse, *model.AppError) {
	return &model.CommandResponse{Text: "Hello by plugin"}, nil
}
```

### UserHasBeenCreated

`UserHasBeenCreated`ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ–°è¦ã«ä½œæˆã•ã‚ŒãŸå ´åˆã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
æ–°ã—ãå‚åŠ ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã« Bot ã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹å ´åˆãªã©ã«ä½¿ç”¨ã§ãã¾ã™ã€‚

![IMAGE](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day18/user-has-been-created.png)

```go
func (p *SamplePlugin) UserHasBeenCreated(c *plugin.Context, user *model.User) {
	channel, appErr := p.API.GetDirectChannel(p.botUserID, user.Id)
	if appErr != nil {
		p.API.LogWarn("failed to get direct channel", "user_id1", p.botUserID, "user_id2", user.Id, "details", appErr.Error())
		return
	}
	if _, appErr := p.API.CreatePost(&model.Post{
		ChannelId: channel.Id,
		UserId:    p.botUserID,
		Message:   "Welcome to Our Mattermost!",
	}); appErr != nil {
		p.API.LogWarn("failed to create welcome post.", "channel_id", channel.Id, "details", appErr.Error())
	}
}
```

### UserWillLogIn

`UserWillLogIn`ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ç›´å‰ã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

ç©ºæ–‡å­—ä»¥å¤–ã®æ–‡å­—åˆ—ã‚’è¿”ã™ã¨ãƒ­ã‚°ã‚¤ãƒ³ãŒå–ã‚Šæ¶ˆã•ã‚Œã¾ã™ãŒã€ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯è¿”å´ã—ãŸæ–‡å­—åˆ—ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯è¡¨ç¤ºã•ã‚Œãšã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒåˆã£ã¦ã„ã¦ã‚‚`Enter a valid email or username and/or password`ã¨ã„ã†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¦ã—ã¾ã†ã‚ˆã†ã§ã™ã€‚ã•ã‚‰ã«ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ç®¡ç†ã§ãã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦ã—ã¾ã†ã¨ã€å‰è¨˜ã®ã‚¨ãƒ©ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³ã§ããšã€åˆ©ç”¨å¯èƒ½ãªçŠ¶æ…‹ã«æˆ»ã™ã®ãŒå›°é›£ã«ãªã£ã¦ã—ã¾ã†ã‹ã‚‚ã—ã‚Œãªã„ãŸã‚ã€ä½¿ç”¨ã«ã¯æ³¨æ„ãŒå¿…è¦ãã†ã§ã™ã€‚

```go
unc (p *SamplePlugin) UserWillLogIn(c *plugin.Context, user *model.User) string {
	if err := p.check(); err != nil {
		return err.Error()
	}
	return ""
}
```

### UserHasLoggedIn

`UserHasLoggedIn`ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ãŸç›´å¾Œã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

å‰å›ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ(ã‚ªãƒ•ãƒ©ã‚¤ãƒ³)ã—ã¦ã‹ã‚‰ã€7 æ—¥ä»¥ä¸ŠçµŒéã—ã¦ã„ãŸå ´åˆã« Bot ã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹å ´åˆãªã©ã«åˆ©ç”¨ã§ãã¾ã™ã€‚

![IMAGE](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day18/user-has-logged-in.png)

```go
func (p *SamplePlugin) UserHasLoggedIn(c *plugin.Context, user *model.User) {
	status, appErr := p.API.GetUserStatus(user.Id)
	if appErr != nil {
		p.API.LogWarn("failed to get user status", "user_id", user.Id, "details", appErr.Error())
		return
	}
	t := time.Unix(status.LastActivityAt/1000, status.LastActivityAt%1000)
	if status.Status == model.STATUS_OFFLINE && time.Now().After(t.AddDate(0, 0, 7)) {
		channel, appErr := p.API.GetDirectChannel(p.botUserID, user.Id)
		if appErr != nil {
			p.API.LogWarn("failed to get direct channel", "user_id1", p.botUserID, "user_id2", user.Id, "details", appErr.Error())
			return
		}
		if _, appErr := p.API.CreatePost(&model.Post{
			ChannelId: channel.Id,
			UserId:    p.botUserID,
			Message:   "Hi! :wave:",
		}); appErr != nil {
			p.API.LogWarn("failed to create post.", "channel_id", channel.Id, "details", appErr.Error())
		}
	}
}
```

### MessageWillBePosted

`MessageWillBePosted`ã¯ã€æŠ•ç¨¿ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã•ã‚Œã‚‹å‰ã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚æŠ•ç¨¿ã‚’æ‹’å¦ã—ãŸã‚Šã€æŠ•ç¨¿å†…å®¹ã‚’è‡ªå‹•ã§ç·¨é›†ã—ãŸã„å ´åˆãªã©ã«åˆ©ç”¨ã§ãã¾ã™ã€‚æŠ•ç¨¿ä½œæˆæ™‚ã«æ‹’å¦ã‚„ç·¨é›†ä»¥å¤–ã®å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹å ´åˆã¯ã€æŠ•ç¨¿ãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã•ã‚ŒãŸå¾Œã«å®Ÿè¡Œã•ã‚Œã‚‹`MessageHasBeenPosted`ã®åˆ©ç”¨ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

æŠ•ç¨¿ã‚’æ‹’å¦ã™ã‚‹å ´åˆã¯ã€ï¼’ã¤ç›®ã® return å€¤ã«ç©ºã§ãªã„æ–‡å­—åˆ—ã‚’æŒ‡å®šã—ã¾ã™ã€‚ä¸€ã¤ç›®ã®è¿”å´å€¤ã®`*model.Post`ã«ã¯å†…å®¹ã‚’ç·¨é›†ã—ãŸå¾Œã®`*model.Post`ã‚’æŒ‡å®šã—ã¾ã™ã€‚`nil`ã‚’æŒ‡å®šã—ãŸå ´åˆã§ã‚‚ã€å¼•æ•°ã§ä¸ãˆã‚‰ã‚ŒãŸ`*model.Post`ãŒæŒ‡å®šã•ã‚ŒãŸã‚‚ã®ã¨è§£é‡ˆã•ã‚Œã¾ã™ã€‚

```go
func (p *SamplePlugin) MessageWillBePosted(c *plugin.Context, post *model.Post) (*model.Post, string) {
	if strings.Contains(post.Message, "shit") || strings.Contains(post.Message, "ğŸ’©") {
		return nil, "You can't use `shit` and ğŸ’© on this server."
	}
	return nil, ""
}
```

![IMAGE](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day18/message-will-be-posted.png)

ã“ã® Hook ã«ã‚ˆã£ã¦æŠ•ç¨¿ãŒæ‹’å¦ã•ã‚ŒãŸå ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã¯ãã®æ‹’å¦ç†ç”±ãŒè¦‹ãˆãªã„ã‚ˆã†ãªã®ã§ã€æ‹’å¦åŸºæº–ã‚’æ˜æ–‡åŒ–ã—ãŸã‚Šã€æ‹’å¦ç†ç”±ã‚’ Bot ã‹ã‚‰é€šçŸ¥ã™ã‚‹ãªã©ã®å¯¾å¿œãŒå¿…è¦ãã†ã§ã™ã€‚

### MessageWillBeUpdated

`MessageWillBeUpdated`ã¯ã€æŠ•ç¨¿æ¸ˆã¿ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç·¨é›†ã—ãŸéš›ã€ç·¨é›†å†…å®¹ãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã•ã‚Œã‚‹ç›´å‰ã«å®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†ã§ã™ã€‚
`MessageWillBePosted`ã¨ã»ã¼åŒã˜å†…å®¹ã®ãŸã‚ã€ä¾‹ã¯çœç•¥ã—ã¾ã™ã€‚

```go
func (p *SamplePlugin) MessageWillBeUpdated(c *plugin.Context, newPost, oldPost *model.Post) (*model.Post, string) {
    ...
}
```

### MessageHasBeenPosted

`MessageHasBeenPosted`ã¯ã€æŠ•ç¨¿ãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã•ã‚ŒãŸç›´å¾Œã«å®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†ã§ã™ã€‚

ç‰¹å®šã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å«ã‚€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒä½œæˆã•ã‚ŒãŸå ´åˆã«ã€ç‰¹å®šã®ãƒãƒ£ãƒ³ãƒãƒ«ã«é€šçŸ¥ã™ã‚‹ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
Bot ãŒä½œæˆã—ãŸæŠ•ç¨¿ã‚‚ã“ã® Hook ã§å‡¦ç†ã•ã‚Œã‚‹ãŸã‚ã€è€ƒæ…®ãŒæ¼ã‚Œã‚‹ã¨å‡¦ç†ãŒç„¡é™ãƒ«ãƒ¼ãƒ—ã—ã¦ã—ã¾ã†ãŸã‚æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚ã¾ãŸã€éå…¬é–‹ãƒãƒ£ãƒ³ãƒãƒ«ã®æŠ•ç¨¿ãªã©ã‚‚å‡¦ç†ã•ã‚Œã¦ã—ã¾ã†ãŸã‚ã€ãã®ç‚¹ã‚’è€ƒæ…®ã™ã‚‹å¿…è¦ã‚‚ã‚ã‚Šã¾ã™ã€‚

![IMAGE](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day18/message-has-been-posted.png)

```go
func (p *SamplePlugin) MessageHasBeenPosted(c *plugin.Context, post *model.Post) {
	postUrl := fmt.Sprintf("http://localhost:8065/_redirect/pl/%s", post.Id)
	if strings.Contains(post.Message, "mattermost") && post.UserId != p.botUserID {
		p.API.CreatePost(&model.Post{
			Message:   fmt.Sprintf("Post refered to `mattermost` is created. See [here](%s) ", postUrl),
			UserId:    p.botUserID,
			ChannelId: "su7w9z51atnspjufg1c73ijx8w",
		})
	}
}
```

### MessageHasBeedUpdated

`MessageHasBeenUpdated`ã¯ã€æŠ•ç¨¿æ¸ˆã¿ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç·¨é›†ã—ãŸéš›ã€ç·¨é›†å†…å®¹ãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã•ã‚ŒãŸç›´å¾Œã«å®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†ã§ã™ã€‚
ã“ã¡ã‚‰ã‚‚`MessageHasBeenPosted`ã¨ã»ã¼åŒã˜å†…å®¹ã®ãŸã‚ã€ä¾‹ã¯çœç•¥ã—ã¾ã™ã€‚

```go
func (p *SamplePlugin) MessageHasBeenUpdated(c *plugin.Context, newPost, oldPost *model.Post) {
    ...
}
```

### ChannelHasBeenCreated

`ChannelHasBeenCreated`ã¯ã€ãƒãƒ£ãƒ³ãƒãƒ«ãŒä½œæˆã•ã‚ŒãŸç›´å¾Œã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

ãƒãƒ£ãƒ³ãƒãƒ«ãŒä½œæˆã•ã‚ŒãŸã“ã¨ã‚’`town-square`ãƒãƒ£ãƒ³ãƒãƒ«ã«é€šçŸ¥ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ã“ã® Hook ã«ã¤ã„ã¦ã‚‚ã€éå…¬é–‹ãƒãƒ£ãƒ³ãƒãƒ«ãŒä½œæˆã•ã‚ŒãŸå ´åˆã®è€ƒæ…®ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

![IMAGE](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day18/channel-has-been-created.png)

```go
func (p *SamplePlugin) ChannelHasBeenCreated(c *plugin.Context, channel *model.Channel) {
	if channel.Type != model.CHANNEL_OPEN {
		return
	}

	u, appErr := p.API.GetUser(channel.CreatorId)
	if appErr != nil {
		p.API.LogError("Failed to get user", "details", appErr)
		return
	}
	townSquare, appErr := p.API.GetChannelByName(channel.TeamId, model.DEFAULT_CHANNEL, false)
	if appErr != nil {
		p.API.LogError("Failed to get channel", "details", appErr)
		return
	}

	if _, appErr := p.API.CreatePost(&model.Post{
		Type:      model.POST_DEFAULT,
		ChannelId: townSquare.Id,
		UserId:    p.botUserID,
		Message:   fmt.Sprintf("Channel ~%s has been created by %s.", channel.Name, u.GetDisplayName(model.SHOW_USERNAME)),
	}); appErr != nil {
		p.API.LogError("Failed to create post", "details", appErr)
	}
}
```

### UserHasJoinedChannel

`UserHasJoinedChannel`ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒãƒ£ãƒ³ãƒãƒ«ã«å‚åŠ ã—ãŸç›´å¾Œã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ç¬¬ï¼“å¼•æ•°ã®`actor`ã¯ã€ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒãƒ£ãƒ³ãƒãƒ«ã«è¿½åŠ ã—ãŸå ´åˆãªã©ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒãƒ£ãƒ³ãƒãƒ«ã«è¿½åŠ ã™ã‚‹å‡¦ç†ã‚’å®Ÿè¡Œã—ãŸäººã®æƒ…å ±ãŒå…¥ã‚Šã¾ã™ã€‚

ãƒãƒ£ãƒ³ãƒãƒ«ã«æ–°ã—ãå‚åŠ ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«èª­ã‚“ã§æ¬²ã—ã„ãƒªãƒ³ã‚¯ãªã©ã‚’é€šçŸ¥ã™ã‚‹å ´åˆã«åˆ©ç”¨ã§ãã¾ã™ã€‚

![IMAGE](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day18/user-has-joined-channel.png)

```go
func (p *SamplePlugin) UserHasJoinedChannel(c *plugin.Context, channelMember *model.ChannelMember, actor *model.User) {
	if channelMember.ChannelId != TargetChannelID {
		return
	}
	p.API.SendEphemeralPost(actor.Id, &model.Post{
		ChannelId: channelMember.ChannelId,
		UserId:    p.botUserID,
		Message:   fmt.Sprintf("This chanels is for XXX user. You'd better to read [notes for this channel](%s).", UrlForNotes),
	})
}
```

### UserHasLeftChannel

`UserHasLeftChannel`ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒãƒ£ãƒ³ãƒãƒ«ã‹ã‚‰è„±é€€ã—ãŸç›´å¾Œã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
`UserHasJoinedChannel`ã¨ã»ã¼åŒã˜å†…å®¹ã®ãŸã‚ã€ä¾‹ã¯çœç•¥ã—ã¾ã™ã€‚

```go
func (p *SamplePlugin) UserHasLeftChannel(c *plugin.Context, channelMember *model.ChannelMember, actor *model.User) {
    ...
}
```

### UserHasJoinedTeam

`UserHasJoinedTeam`ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒãƒ¼ãƒ ã«å‚åŠ ã—ãŸç›´å¾Œã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
`UserHasJoinedChannel`ã¨ã»ã¼åŒã˜å†…å®¹ã®ãŸã‚ã€ä¾‹ã¯çœç•¥ã—ã¾ã™ã€‚

```go
func (p *SamplePlugin) UserHasJoinedTeam(c *plugin.Context, teamMember *model.TeamMember, actor *model.User)  {
    ...
}
```

### UserHasLeftTeam

`UserHasLeftTeam`ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒãƒ£ãƒ³ãƒãƒ«ã‹ã‚‰è„±é€€ã—ãŸç›´å¾Œã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
`UserHasJoinedChannel`ã¨ã»ã¼åŒã˜å†…å®¹ã®ãŸã‚ã€ä¾‹ã¯çœç•¥ã—ã¾ã™ã€‚

```go
func (p *SamplePlugin) UserHasLeftTeam(c *plugin.Context, teamMember *model.TeamMember, actor *model.User) {
    ...
}
```

### FileWillBeUploaded

`FileWillBeUploaded`ã¯ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›æ¬„ã«ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ·»ä»˜ã•ã‚ŒãŸæ™‚ã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŠ•ç¨¿ä½œæˆã‚’å®Ÿè¡Œã™ã‚‹å‰ã«ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›ã•ã‚Œã¾ã™ã€‚

æ·»ä»˜ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®æƒ…å ±ã¯ç¬¬ 2 å¼•æ•°ã®[`*model.FileInfo`](https://pkg.go.dev/github.com/mattermost/mattermost-server/v5/model#FileInfo)ã‹ã‚‰ã€ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã¯ç¬¬ 3 å¼•æ•°ã®`io.Reader`ã‹ã‚‰å–å¾—ã§ãã¾ã™ã€‚æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›´ã‚’åŠ ãˆãŸå ´åˆã¯ã€ç¬¬ 4 å¼•æ•°ã®`io.Writer`ã«æ›¸ãè¾¼ã¿ã¾ã™ã€‚
ã¾ãŸã€ãƒ•ã‚¡ã‚¤ãƒ«ã®æ·»ä»˜ã‚’æ‹’å¦ã™ã‚‹å ´åˆã¯ã€2 ã¤ç›®ã®è¿”å´å€¤ã«ç©ºã§ãªã„æ–‡å­—åˆ—ã‚’æŒ‡å®šã—ã¾ã™ã€‚1 ã¤ç›®ã®è¿”å´å€¤ã®`*model.FileInfo`ã«ã¯å†…å®¹ã‚’ç·¨é›†ã—ãŸå¾Œã®`*model.FileInfo`ã‚’æŒ‡å®šã—ã¾ã™ã€‚ã‚‚ã—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ãŸå ´åˆã€ç·¨é›†å¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã«ã¤ã„ã¦ã¯è‡ªå‹•ã§æ›´æ–°ã•ã‚Œã‚‹ãŸã‚ã€`FileWillBeUploaded`å†…ã§è¨ˆç®—ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

ç”»åƒã«ãƒ•ã‚£ãƒ«ã‚¿ã‚’ã‹ã‘ã‚‹ä¾‹ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

![IMAGE](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day18/file-will-be-uploaded.png)

```go
func (p *SamplePlugin) FileWillBeUploaded(c *plugin.Context, info *model.FileInfo, file io.Reader, output io.Writer) (*model.FileInfo, string) {
	if info.IsImage() {
		// Decode original image
		img, _, err := image.Decode(file)
		if err != nil {
			p.API.LogWarn("failed to decode uploaded image", "details", err.Error())
			return nil, ""
		}
		// Draw original image
		base := image.NewRGBA(image.Rect(0, 0, img.Bounds().Dx(), img.Bounds().Dy()))
		draw.Draw(base, base.Bounds(), img, image.ZP, draw.Src)

		// Create green filter
		src := image.NewRGBA(image.Rect(0, 0, img.Bounds().Dx(), img.Bounds().Dy()))
		draw.Draw(src, src.Bounds(), &image.Uniform{color.RGBA{255, 128, 255, 128}}, image.ZP, draw.Src)

		// Mask original image
		mask := image.Rect(25, 25, base.Bounds().Dx()-25, base.Bounds().Dy()-25)
		draw.DrawMask(base, base.Bounds(), src, image.ZP, mask, image.ZP, draw.Over)

		// Write masked image
		png.Encode(output, base)
	}
	return info, ""
}
```

ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã® Exif ã‚’å‰Šé™¤ã™ã‚‹ãªã©ã§åˆ©ç”¨ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ãŒã€å‡¦ç†è‡ªä½“ã¯ Mattermost ã‚µãƒ¼ãƒãƒ¼ã«ãƒ•ã‚¡ã‚¤ãƒ«ãŒé€ã‚‰ã‚ŒãŸå¾Œã«å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚


## Mattermost Plugin API

Mattermost Server Plugin ã®é–‹ç™ºã«åˆ©ç”¨ã§ãã‚‹ API ã®ä¸€è¦§ã¯ä¸‹è¨˜ã«ã‚ã‚Šã¾ã™ã€‚

https://developers.mattermost.com/extend/plugins/server/reference/

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚„ãƒãƒ£ãƒ³ãƒãƒ«ã€æŠ•ç¨¿ãªã©ã®æ“ä½œã«ã¤ã„ã¦ã¯ REST API ã¨ã»ã¼åŒæ§˜ã®æ©Ÿèƒ½ã‚’æœ‰ã—ã¦ã„ã¾ã™ã€‚æ•°ãŒå¤šã„ãŸã‚å…¨ã¦ã¯ç´¹ä»‹ã—ã¾ã›ã‚“ãŒã€Server Plugin ç‰¹æœ‰ã®å‡¦ç†ã«é–¢ã™ã‚‹ API ã‚’ç´¹ä»‹ã—ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚

### GetConfig

`GetConfig`ã¯ã€Mattermost Server ã®ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®è¨­å®šæƒ…å ±ã‚’å–å¾—ã—ã¾ã™ã€‚

```go
siteURL := p.API.GetConfig().ServiceSettings.SiteURL
```

`p.API.GetConfig()`ä¸‹è¨˜ã®`OnConfigurationChange`å†…ã§å®Ÿè¡Œã—ã€Plugin æ§‹é€ ä½“ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨ã—ã¦ä¿æŒã—ã¦ãŠãã®ãŒè‰¯ã„ãã†ã§ã™ã€‚
https://github.com/mattermost/mattermost-plugin-starter-template/blob/master/server/configuration.go

### OpenInteractiveDialog

`OpenInteractiveDialog`ã¯ã€ç¬¬ 16 æ—¥ç›®ã®è¨˜äº‹ã§ã‚‚ç´¹ä»‹ã—ãŸ Interactive Dialog ã‚’ Plugin ã‹ã‚‰é–‹ããŸã‚ã® API ã§ã™ã€‚Interactive Dialog ã‚’é–‹ãã«ã¯`TriggerId`ã¨ã„ã†ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå¿…é ˆã§ã‚ã‚Šã€`TriggerId`ã¯ Slash Command å®Ÿè¡Œæ™‚ã€ã‚‚ã—ãã¯ Interactive Message Button/Menu å®Ÿè¡Œæ™‚ã«é€ä¿¡ã•ã‚Œã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰ã—ã‹å–å¾—ã§ãã¾ã›ã‚“ã€‚

ä»¥ä¸‹ã®ä¾‹ã¯ Slash Command å®Ÿè¡Œæ™‚ã« Interactive Dialog ã‚’é–‹ãã€å…¥åŠ›ã•ã‚ŒãŸæƒ…å ±ã‚’æ•´å½¢ã—ã¦æŠ•ç¨¿ã‚’ä½œæˆã™ã‚‹ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚

![](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day19/open-interactive-dialog.gif)

```go:plugin.go
func (p *SamplePlugin) ExecuteCommand(c *plugin.Context, args *model.CommandArgs) (*model.CommandResponse, *model.AppError) {
	appErr := p.API.OpenInteractiveDialog(model.OpenDialogRequest{
		TriggerId: args.TriggerId,
		URL:       fmt.Sprintf("%s/plugins/com.github.kaakaa.mattermost-plugin-starter-template/callback", *p.API.GetConfig().ServiceSettings.SiteURL),
		Dialog: model.Dialog{
			Title:       "Sample Plugin Dialog",
			SubmitLabel: "Submit",
			Elements: []model.DialogElement{
				{
					DisplayName: "ã‚¿ã‚¤ãƒˆãƒ«",
					Name:        "title",
					Placeholder: "Title",
					Type:        "text",
				},
				{
					DisplayName: "Snippet",
					Name:        "snippet",
					Type:        "textarea",
				},
			},
		},
	})
	if appErr != nil {
		return nil, appErr
	}
	return &model.CommandResponse{}, nil
}
```

Interactive Dialog ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡å…ˆã‚’

```go
		URL:       fmt.Sprintf("%s/plugins/com.github.kaakaa.mattermost-plugin-starter-template/callback", *p.API.GetConfig().ServiceSettings.SiteURL),
```

ã®ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã€Plugin ã‹ã‚‰é–‹ã„ãŸ Interactive Dialog ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ Plugin ã§å‡¦ç†ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ã“ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å—ä¿¡å…ˆã¨ã—ã¦ã€Mattermost Plugin Server Hook ã§ã‚ã‚‹`ServeHTTP`ã‚’ä½¿ã£ã¦`/callback`ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å—ã‘å–ã‚‹å‡¦ç†ã‚’è¿½åŠ ã—ã¾ã™ã€‚

````go:plugin.go
func (p *SamplePlugin) ServeHTTP(c *plugin.Context, w http.ResponseWriter, r *http.Request) {
	if r.URL.Path == "/callback" {
		defer r.Body.Close()
		request := model.SubmitDialogRequestFromJson(r.Body)
		t := request.Submission["title"]
		s := request.Submission["snippet"]
		p.API.CreatePost(&model.Post{
			UserId:    request.UserId,
			ChannelId: request.ChannelId,
			Message:   fmt.Sprintf("## %s\n\n```\n%s\n```", t, s),
		})
		return
	}
	fmt.Fprint(w, "Hello, world!")
}
````

ã“ã®ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã€Interactive Dialog ã®èµ·å‹•ã‹ã‚‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡¦ç†ã¾ã§ã‚’ Plugin ã ã‘ã§å®Œçµã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### PublishWebSocketEvent

`PublishWebSocketEvent`ã¯ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç‹¬è‡ªã® WebSoket ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡ã™ã‚‹ API ã§ã™ã€‚

`PublishWebSocketEvent`ã¯ã€3 ã¤ã®å¼•æ•°ã‚’å–ã‚Šã¾ã™ã€‚

- `event string`: WebSocket ã‚¤ãƒ™ãƒ³ãƒˆåã‚’æŒ‡å®šã—ã¾ã™ã€‚å®Ÿéš›ã«é€ä¿¡ã•ã‚Œã‚‹ WebSocket ã‚¤ãƒ™ãƒ³ãƒˆã«ã¯æ¥é ­è¾ã¨ã—ã¦`custom_<PluginID>_`ãŒä»˜ä¸ã•ã‚Œã¾ã™
- `payload map[string]interface{}`: é€ä¿¡ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã®å†…å®¹ã‚’æŒ‡å®šã—ã¾ã™
- `broadcast *model.WebsocketBroadcast`: WebSocket ã‚’é€ä¿¡ã™ã‚‹å¯¾è±¡ã‚’æŒ‡å®šã—ã¾ã™
  - [`model.WebsocketBroadcast`](https://pkg.go.dev/github.com/mattermost/mattermost-server/v5/model#WebsocketBroadcast)ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ãƒãƒ£ãƒ³ãƒãƒ«ã€ãƒãƒ¼ãƒ ã‚’æŒ‡å®šã—ãŸã‚Šã€å—ä¿¡å¯¾è±¡ã‹ã‚‰å¤–ã™ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æŒ‡å®šã—ãŸã‚Šã§ãã¾ã™

Webapp Plugin API ã®[`registerWebSocketEventHandler`](https://developers.mattermost.com/extend/plugins/webapp/reference/#registerWebSocketEventHandler)ã¨çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å†…ã§ WebSocket ã‚¤ãƒ™ãƒ³ãƒˆã«é–¢ã™ã‚‹å‡¦ç†ã‚’å®Œçµã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ã“ã®è¾ºã‚Šã®ä½¿ç”¨ä¾‹ã¯ç¬¬ 22 æ—¥ç›®ä»¥é™ã®è¨˜äº‹ã§ç´¹ä»‹ã™ã‚‹äºˆå®šã§ã™ã€‚

### SendMail

`SendMail`ã¯ã€Mattermost Plugin ã‹ã‚‰ HTML ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã™ã‚‹ API ã§ã™ã€‚ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ SMTP ã®è¨­å®šãŒå®Œäº†ã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

Slash Command ã‚’å®Ÿè¡Œã—ãŸéš›ã«ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã™ã‚‹ä¾‹ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```go:plugin.go
func (p *SamplePlugin) ExecuteCommand(c *plugin.Context, args *model.CommandArgs) (*model.CommandResponse, *model.AppError) {
	appErr := p.API.SendMail(
		"test@example.com",
		"Sample Title",
		"<h1>Mail from plugin</h1><div><p>Sample Mail</p></div>")
	if appErr != nil {
		return nil, appErr
	}

	return &model.CommandResponse{}, nil
}
```

![](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day19/send-mail.jpg)

### KVGet / KVSet

`KVGet`, `KVSet`ã¯ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã”ã¨ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸ Key Value ã‚¹ãƒˆã‚¢ã‹ã‚‰å€¤ã‚’å–å¾—ã€ã¾ãŸã¯å€¤ã‚’è¨­å®šã™ã‚‹ API ã§ã™ã€‚Key Value ã‚¹ãƒˆã‚¢ã«ã¯`[]byte`å‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ã§ãã‚‹ãŸã‚ã€æ ¼ç´ç”¨ãƒ‡ãƒ¼ã‚¿ã®æ§‹é€ ä½“ã‚’ä½œæˆã—ã€`json.Marshal`ã§`[]byte`å‹ã®ãƒ‡ãƒ¼ã‚¿åŒ–ã—ãŸã‚‚ã®ã‚’å‡ºã—å…¥ã‚Œã™ã‚‹ã®ãŒä¸»ãªä½¿ã„æ–¹ã«ãªã‚‹ã®ã§ã¯ãªã„ã‹ã¨æ€ã„ã¾ã™ã€‚

Key Value ã‚¹ãƒˆã‚¢ã‚’ä½¿ç”¨ã—ã¦ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’å®Ÿè£…ã—ãŸä¾‹ãŒä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚

![](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day19/kvget-kvset.gif)

```go:plugin.go
type counter struct {
	Count     int    `json:"count"`
	CreatedAt string `json:"created_at"`
}

func (p *SamplePlugin) ExecuteCommand(c *plugin.Context, args *model.CommandArgs) (*model.CommandResponse, *model.AppError) {
	// read data
	b, appErr := p.API.KVGet("counter")
	if appErr != nil {
		return nil, appErr
	}
	var ct counter
	if b == nil {
		// init if data is not found
		ct = counter{
			Count:     0,
			CreatedAt: time.Now().Format(time.RFC3339),
		}
	} else {
		if err := json.Unmarshal(b, &ct); err != nil {
			return nil, model.NewAppError("where", "id", nil, err.Error(), http.StatusInternalServerError)
		}
	}
	// count up
	ct.Count = ct.Count + 1
	b, err := json.Marshal(ct)
	if err != nil {
		return nil, model.NewAppError("where", "id", nil, err.Error(), http.StatusInternalServerError)
	}
	// set data
	if appErr := p.API.KVSet("counter", b); appErr != nil {
		return nil, appErr
	}

	return &model.CommandResponse{Text: fmt.Sprintf("counter: %d", ct.Count)}, nil
}
```

Key Value ã‚¹ãƒˆã‚¢ã‚’æ“ä½œã™ã‚‹ API ã¯`KVGet`, `KVSet`ä»¥å¤–ã«ã‚‚æ•°å¤šãã‚ã‚Šã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã™ã‚‹`KVDelete`ã‚„ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å†…ã§ä¿å­˜æ¸ˆã¿ã®ãƒ‡ãƒ¼ã‚¿ã®`key`ã‚’å–å¾—ã™ã‚‹`KVList`ã€æœŸé–“ã‚’æŒ‡å®šã—ã¦å€¤ã‚’æ ¼ç´ã§ãã‚‹`KVSetWithExpiry`ãªã©ãŒã‚ã‚Šã¾ã™ã€‚ã¾ãŸã€åŒæ™‚ã«`KVSet`ãŒå®Ÿè¡Œã•ã‚ŒãŸå ´åˆã«ä¸æ•´åˆãŒèµ·ããªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã€Atomic ãª Key Value ã‚¹ãƒˆã‚¢ã®æ“ä½œã‚’å¼·åˆ¶ã™ã‚‹ãŸã‚ã®`KVCompareAndSet`ãªã©ã‚‚ã‚ã‚Šã¾ã™ã€‚

API ã®ä¸€è¦§ã«ã¤ã„ã¦ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
https://developers.mattermost.com/extend/plugins/server/reference/

## Helpers

Mattermost Plugin API ã¯æ•°å¤šãã‚ã‚‹ãŸã‚ã€Mattermost ã«å¯¾ã™ã‚‹ã»ã¨ã‚“ã©ã®æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã¯ã§ãã¾ã™ãŒã€ã‚ˆã‚Šç°¡å˜ã« Plugin API ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã® Helper é–¢æ•°ãŒã„ãã¤ã‹å­˜åœ¨ã—ã¾ã™ã€‚

ã“ã“ã§ã¯ã€Helper é–¢æ•°ã®ã†ã¡ä¸€éƒ¨ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

Helper é–¢æ•°ã®ä¸€è¦§ã¯ä¸‹è¨˜ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ã‚Šã¾ã™ã€‚
https://developers.mattermost.com/extend/plugins/server/reference/#Helpers

### KVGetJSON / KVSetJSON

å…ˆã»ã©ã®`KVGet`ã€`KVSet`ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€æ§‹é€ ä½“ã‚’`[]byte`ã«å¤‰æ›ã™ã‚‹ãŸã‚ã«`KVSet`ã‚’å‘¼ã¶å‰ã«`json.Marshal`ã‚’ã€`KVGet`ã‚’å‘¼ã‚“ã å¾Œã«`json.Unmarshal`ã‚’å‘¼ã‚“ã§ã„ã¾ã—ãŸãŒã€`KVGetJSON`ã€`KVSetJSON`ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ãã®å¿…è¦ãŒãªããªã‚Šã¾ã™ã€‚

ãã®ãŸã‚ã€å…ˆã»ã©ã®å‡¦ç†ã‚’å¤šå°‘ã™ã£ãã‚Šã¨æ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚

```go:plugin.go
type counter struct {
	Count     int    `json:"count"`
	CreatedAt string `json:"created_at"`
}

func (p *SamplePlugin) ExecuteCommand(c *plugin.Context, args *model.CommandArgs) (*model.CommandResponse, *model.AppError) {
	// read data
	var ct counter
	exists, err := p.Helpers.KVGetJSON("counter", &ct)
	if err != nil {
		return nil, model.NewAppError("where", "id", nil, err.Error(), http.StatusInternalServerError)
	}
	if !exists {
		ct = counter{
			Count:     0,
			CreatedAt: time.Now().Format(time.RFC3339),
		}
	}

	// count up
	ct.Count = ct.Count + 1

	// set data
	if appErr := p.Helpers.KVSetJSON("counter", ct); appErr != nil {
		return nil, model.NewAppError("where", "id", nil, err.Error(), http.StatusInternalServerError)
	}

	return &model.CommandResponse{Text: fmt.Sprintf("counter: %d", ct.Count)}, nil
}
```

### CheckRequiredServerConfiguration

`CheckRequiredServerConfiguration`ã¯ã€ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®è¨­å®šã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãŸã‚ã® Helper é–¢æ•°ã§ã™ã€‚

å¼•æ•°ã«æŒ‡å®šã—ãŸ[`model.Config`](https://pkg.go.dev/github.com/mattermost/mattermost-server/v5/model#Config)ã¨åŒã˜è¨­å®šã«ãªã£ã¦ã„ã‚‹ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€ç•°ãªã‚‹è¨­å®šã ã£ãŸå ´åˆã¯`false`ã‚’è¿”ã—ã¾ã™ã€‚

**ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ³ã‚½ãƒ¼ãƒ« > Bot ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ > Bot ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä½œæˆã‚’æœ‰åŠ¹ã«ã™ã‚‹**ã®è¨­å®šãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ãªã„å ´åˆã«ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®èµ·å‹•ã‚’åœæ­¢ã™ã‚‹ã‚ˆã†ãªä¾‹ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```go:plugin.go
func toPtr(v bool) *bool {
	return &v
}

func (p *SamplePlugin) OnActivate() error {
	b, err := p.Helpers.CheckRequiredServerConfiguration(&model.Config{
		ServiceSettings: model.ServiceSettings{
			EnableBotAccountCreation: toPtr(true),
		},
	})
	if err != nil {
		return err
	}
	if !b {
		return errors.New("EnableBotAccountCreation must be true.")
	}

    ...
```

ãƒ—ãƒ©ã‚°ã‚¤ãƒ³èµ·å‹•æ™‚ã€ã‚µãƒ¼ãƒãƒ¼ã®ãƒ­ã‚°ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚

```bash
2020-12-13T00:16:01.409+0900    error   mlog/log.go:229 Unable to restart plugin on upgrade.    {"path": "/api/v4/plugins", "request_id": "u31bzwuyhbyibratzznjxgxzrr", "ip_addr": "::1", "user_id": "87x93uo8pfnzdro9ktcmobpa1r", "method": "POST", "err_where": "installExtractedPlugin", "http_code": 500, "err_details": "EnableBotAccountCreation must be true."}
```


## Mattermost Plugin (Webapp) ã«ã¤ã„ã¦

Mattermost Plugin (Webapp) ã®æœ¬ä½“ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã™ã€‚

Mattermost ã®**Webapp**ã‚µã‚¤ãƒ‰ã® Plugin ã‚’å®Ÿè£…ã™ã‚‹å ´åˆã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³æœ¬ä½“ã¯`registry`ã¨`store`ã‚’å¼•æ•°ã«ã¨ã‚‹`initialize`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŒã¤ã‚¯ãƒ©ã‚¹ã§ã™ã€‚`registry`ã¯ Mattermost Plugin (Webapp)ã®æ©Ÿèƒ½ã‚’å‘¼ã³å‡ºã™ãŸã‚ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŒã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã€`store`ã¯ Mattermost ã®ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§ã™ã€‚

å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãª`PluginClass`ãŒç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã™ã€‚
https://developers.mattermost.com/extend/plugins/webapp/reference/

```js
class PluginClass {
    /**
    * initialize is called by the webapp when the plugin is first loaded.
    * Receives the following:
    * - registry - an instance of the registry tied to your plugin id
    * - store - the Redux store of the web app.
    */
    initialize(registry, store)

    /**
    * uninitialize is called by the webapp if your plugin is uninstalled
    */
    uninitialize()
}
```

ã“ã®`PluginClass`ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’`window`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæŒã¤`registerPlugin`é–¢æ•°ã« Plugin ID ã¨å…±ã«ä¸ãˆã‚‹ã“ã¨ã§ã€Plugin ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚

```js
window.registerPlugin("myplugin", new PluginClass());
```

## Webapp Plugin API

### [registerRootComponent](https://developers.mattermost.com/extend/plugins/webapp/reference/#registerRootComponent)

`registerRootComponent`ã¯ã€ç”»é¢å…¨ä½“ã«è¡¨ç¤ºã•ã‚Œã‚‹ãƒ¢ãƒ¼ãƒ€ãƒ«ã® React Component ã‚’ç™»éŒ²ã™ã‚‹ API ã§ã™ã€‚Component ãŒç™»éŒ²ã•ã‚Œã‚‹ã¨ã€Component ã‚’ä¸€æ„ã«è­˜åˆ¥ã™ã‚‹ãŸã‚ã® ID ãŒè¿”å´ã•ã‚Œã¾ã™ã€‚

ã“ã“ã§ç™»éŒ²ã—ãŸ Root Component ã¯ã€ç™»éŒ²ã™ã‚‹ã ã‘ã§è¡¨ç¤ºã•ã‚Œã‚‹ã‚ã‘ã§ã¯ãªãã€åˆ¥ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰èµ·å‹•ã•ã‚Œã‚‹ã“ã¨ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

ç™»éŒ²ã•ã‚ŒãŸ Component ã§ä½¿ç”¨ã§ãã‚‹ props ã¯ç‰¹ã«ã‚ã‚Šã¾ã›ã‚“ã€‚[channel_controller.jsx](https://github.com/mattermost/mattermost-webapp/blob/61a4de5e36f994955bacc47c8d56734f9a699a5a/components/channel_layout/channel_controller.jsx#L86)

ä»Šå›ã¯ã€ãƒãƒ£ãƒ³ãƒãƒ«ã®ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†ã«ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ã™ã‚‹`registerChannelHeaderButtonAction` API ã‚’ä½¿ã£ã¦ Root Component ã‚’è¡¨ç¤ºã™ã‚‹ä¾‹ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚å…¨ã¦ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’è¨˜è¿°ã™ã‚‹ã¨éå¸¸ã«é•·ããªã£ã¦ã—ã¾ã†ãŸã‚ã€Redux ã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿ã®ã‚„ã‚Šã¨ã‚Šãªã©éƒ¨åˆ†ã«ã¤ã„ã¦ã¯æœ¬è¨˜äº‹ã§ã¯å‰²æ„›ã—ã¾ã™ã€‚ãƒ—ãƒ­ã‚°ãƒ©ãƒ å…¨ä½“ã«ã¤ã„ã¦çŸ¥ã‚ŠãŸã„å ´åˆã¯ã€[kaakaa/mattermost-plugin-api-sample](https://github.com/kaakaa/mattermost-plugin-api-sampleã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚)
ã¾ãŸã€Mattermost å…¬å¼ãƒãƒ¼ãƒ ã«ã‚ˆã‚Šä½œæˆã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¢ç”¨ãƒ—ãƒ©ã‚°ã‚¤ãƒ³[mattermost-plugin-demo](https://github.com/mattermost/mattermost-plugin-demo/tree/master/webapp)ã®å®Ÿè£…ã‚‚å‚è€ƒã«ãªã‚Šã¾ã™ã€‚

![](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day20/root-component.gif)

```js
...

import {openRootModal} from './actions'
import reducer from './reducer';

import Root from './components/root';

...

export default class Plugin {
    initialize(registry, store) {
        // (1) Root Componentã®ç™»éŒ²
        registry.registerRootComponent(Root)

        // (2) Root Componentã‚’å‘¼ã³å‡ºã™ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ç™»éŒ²
        registry.registerChannelHeaderButtonAction(
            channelHeaderButtonIcon,
            () => store.dispatch(openRootModal()),
            "Open Root modal","Open Root modal"
        );

        registry.registerReducer(reducer);
    }
}
```

ä¸Šè¨˜ã®ä¾‹ã§ã¯ã€`(1)`ã§ Root Component ã¨ãªã‚‹ React Component ã‚’ç™»éŒ²ã—ã€`(2)`ã§ Root Component ã‚’è¡¨ç¤ºã™ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒãƒ£ãƒ³ãƒãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ãƒœã‚¿ãƒ³ã«ä¸ãˆã¦ã„ã¾ã™ã€‚`(2)`ã®`store.dispatch(openRootModal())`ãŒ Root Component ã‚’è¡¨ç¤ºã™ã‚‹å‡¦ç†ã§ã™ãŒã€ã“ã‚Œã¯ Root Component ã‚’è¡¨ç¤ºã™ã‚‹ state ã‚’æµã™å‡¦ç†ã«ãªã‚Šã¾ã™ã€‚

Root Component ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã§ã‚ã‚Šã€`visible = true`ã¨ãªã‚‹ã“ã¨ã§ç”»é¢ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

```js
import React from "react";

const Root = ({ visible, close }) => {
  if (!visible) {
    return null;
  }

  const style = getStyle();

  return (
    <div style={style.backdrop} onClick={close}>
      <div style={style.modal}>
        <p>Root modal</p>
      </div>
    </div>
  );
};

Root.propTypes = {
  visible: PropTypes.bool.isRequired,
  close: PropTypes.func.isRequired,
};

const getStyle = () => ({
  backdrop: {
    position: "absolute",
    display: "flex",
    top: 0,
    left: 0,
    right: 0,
    bottom: 0,
    backgroundColor: "rgba(0, 0, 0, 0.50)",
    zIndex: 2000,
    alignItems: "center",
    justifyContent: "center",
  },
  modal: {
    height: "300px",
    width: "500px",
    padding: "1em",
    color: "black",
    backgroundColor: "white",
  },
});

export default Root;
```

Root Component ã¯ React Component ã®ãŸã‚ã€æ§˜ã€…ãªè¦ç´ ã‚’è¡¨ç¤ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ãŒã€åŸºæœ¬çš„ã«ã¯é€šçŸ¥ã®ãŸã‚ã«åˆ©ç”¨ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å…¥åŠ›ã‚’ä¿ƒã™ã‚ˆã†ãªãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã®å ´åˆã¯[`Interactive Dialog`](https://docs.mattermost.com/developer/interactive-dialogs.html)ã‚’ä½¿ç”¨ã™ã¹ãã ã¨æ€ã„ã¾ã™ã€‚

### [registerPopoverUserAttributesComponent](https://developers.mattermost.com/extend/plugins/webapp/reference/#registerPopoverUserAttributesComponent)

`registerPopoverUserAttributesComponent`ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è¡¨ç¤ºã•ã‚Œã‚‹ popover å†…ã«è¡¨ç¤ºã•ã‚Œã‚‹ Component ã‚’ç™»éŒ²ã—ã¾ã™ã€‚

Mattermost å¤–ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ã‚’å–å¾—ã—ã¦è¡¨ç¤ºã™ã‚‹éš›ã«ä½¿ç”¨ã§ãã¾ã™ã€‚æ‰€å±ã®åç§°ãŒã‚³ãƒ­ã‚³ãƒ­å¤‰ã‚ã‚‹ä¼šç¤¾ãªã©ã§ LDAP ã‹ã‚‰æ‰€å±ã‚’å¼•ã„ã¦è¡¨ç¤ºã—ã¦ãŠãã¨ä¾¿åˆ©ã§ã™ã€‚

ç™»éŒ²ã—ãŸ Component ã¯ä»¥ä¸‹ã® props ã‚’å—ã‘å–ã‚Œã¾ã™ã€‚[profile_popover.jsx](https://github.com/mattermost/mattermost-webapp/blob/61a4de5e36f994955bacc47c8d56734f9a699a5a/components/profile_popover/profile_popover.jsx#L356)

- `user`: popover ã§è¡¨ç¤ºã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
  - ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã®ã¯[User](https://github.com/mattermost/mattermost-server/blob/master/model/user.go#L68)ãƒ¢ãƒ‡ãƒ«ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹æƒ…å ±ã«ãªã‚‹ã¨æ€ã„ã¾ã™
  - `User`ãƒ¢ãƒ‡ãƒ«ã§`omitempty`ã¨ãªã£ã¦ã„ã‚‹ã‚‚ã®ã¯ç©ºã®å ´åˆé™¤å¤–ã•ã‚Œã‚‹ãŸã‚ã€å€¤ãŒã‚ã‚‹å ´åˆã®ã¿ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™
- `hide`: popover ã‚’é–‰ã˜ã‚‹é–¢æ•°
- `status`: popover ã§è¡¨ç¤ºã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® status
  - `online`, `offline`ãªã©ã®å˜ãªã‚‹æ–‡å­—åˆ—ã®ã‚ˆã†ã§ã™

ã“ã“ã§ã¯ã€å›ºå®šæ–‡å­—åˆ—ã‚’è¡¨ç¤ºã™ã‚‹ä¾‹ã‚’ç¤ºã—ã¾ã™ã€‚

![](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day20/user-attribute.png)

```js:index.js
...

import UserAttributes from './components/user_attributes'

...

export default class Plugin {
    // eslint-disable-next-line no-unused-vars
    initialize(registry, store) {
		...
        // (1) User Popoverã«èª¬æ˜ã‚’è¿½åŠ ã™ã‚‹Componentã®ç™»éŒ²
		registry.registerPopoverUserAttributesComponent(UserAttributes)
		...
    }
}
```

```js:components/user_attributes.jsx
import React from 'react';
import PropTypes from 'prop-types';

const UserAttributes = ({user, hide, status}) => {
    console.log("user", user.id);
    return (
        <div>
            <p>{'UserId: ' + user.id}</p>
        </div>
    );
}

UserAttributes.propTypes = {
    user: PropTypes.object.isRequired,
    hide: PropTypes.func.isRequired,
    status: PropTypes.object.isRequired,
};

export default UserAttributes;
```

### [registerPopoverUserActionsComponent](https://developers.mattermost.com/extend/plugins/webapp/reference/#registerPopoverUserActionsComponent)

`registerPopoverUserActionsComponent`ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è¡¨ç¤ºã•ã‚Œã‚‹ popover å†…ã«è¡¨ç¤ºã•ã‚Œã‚‹ Component ã‚’ç™»éŒ²ã—ã¾ã™ã€‚`registerPopoverUserAttributesComponent`ã¨ä¼¼ã¦ã„ã¾ã™ãŒã€è¡¨ç¤ºã•ã‚Œã‚‹ä½ç½®ãŒç•°ãªã‚‹ã ã‘ã®é•ã„ã ã¨æ€ã„ã¾ã™ã€‚

ç™»éŒ²ã—ãŸ Component ã¯ã€`registerPopoverUserAttributesComponent`ã¨åŒã˜ãä»¥ä¸‹ã® props ã‚’å—ã‘å–ã‚Œã¾ã™ã€‚[profile_popover.jsx](https://github.com/mattermost/mattermost-webapp/blob/61a4de5e36f994955bacc47c8d56734f9a699a5a/components/profile_popover/profile_popover.jsx#L483)

- `user`: popover ã§è¡¨ç¤ºã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
- `hide`: popover ã‚’é–‰ã˜ã‚‹é–¢æ•°
- `status`: popover ã§è¡¨ç¤ºã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® status

`registerPopoverUserActionsComponent`ã§ã€RootComponent ã‚’è¡¨ç¤ºã™ã‚‹ä¾‹ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ï¼ˆå‡¦ç†ã‚’ä¸€éƒ¨å‰²æ„›ã—ã¦ã„ã‚‹ãŸã‚ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ å…¨ä½“ã¯ https://github.com/kaakaa/mattermost-plugin-api-sample ã‹ã‚‰ç¢ºèªã—ã¦ãã ã•ã„ï¼‰

![](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day20/user-action.gif)

```js:index.js
...
import UserAction from './components/user_action';
...
export default class Plugin {
    // eslint-disable-next-line no-unused-vars
    initialize(registry, store) {
		...
        // User Popoverã«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã™ã‚‹Componentã®ç™»éŒ²
		registry.registerPopoverUserActionsComponent(UserAction)
		...
	}
}
```

```js:components/user_action/user_action.jsx
import React from 'react';
import PropTypes from 'prop-types';

const UserActionComponent = ({openRootModal, user, hide, status}) => {
	const onClick = () => {
		openRootModal();
		hide();
	};
    return (
        <div>
            <p>User Action <button onClick={onClick}>Action</button></p>
        </div>
    )
};

UserActionComponent.PropTypes = {
	openRootModal: PropTypes.func.isRequired,
    user: PropTypes.object.isRequired,
    hide: PropTypes.func.isRequired,
    status: PropTypes.object.isRequired,
};

export default UserActionComponent;
```

### [registerLeftSidebarHeaderComponent](https://developers.mattermost.com/extend/plugins/webapp/reference/#registerLeftSidebarHeaderComponent)

`registerLeftSidebarHeaderComponent`ã¯ã€Mattermost ç”»é¢ã®å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«è¡¨ç¤ºã™ã‚‹ Component ã‚’ç™»éŒ²ã—ã¾ã™ã€‚

ç™»éŒ²ã•ã‚ŒãŸ Component ã§ä½¿ç”¨ã§ãã‚‹ props ã¯ç‰¹ã«ã‚ã‚Šã¾ã›ã‚“ã€‚[sidebar.tsx](https://github.com/mattermost/mattermost-webapp/blob/61a4de5e36f994955bacc47c8d56734f9a699a5a/components/sidebar/sidebar.tsx#L179)

å¸¸ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹éƒ¨åˆ†ã®ãŸã‚ã€è·å ´ã®å®¤æ¸©ã‚„ CO2 æ¿ƒåº¦ãªã©ã‚’è¡¨ç¤ºã™ã‚‹ãªã©ã®åˆ©ç”¨æ–¹æ³•ãŒã‚ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

![](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day20/left-sidebar-header.png)

```js:index.js
...
import LeftSidebarHeader from './components/left_sidebar_header';
...
export default class Plugin {
    // eslint-disable-next-line no-unused-vars
    initialize(registry, store) {
		...
        // User Popoverã«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã™ã‚‹Componentã®ç™»éŒ²
		registry.registerLeftSidebarHeaderComponent(LeftSidebarHeader)
		...
	}
}
```

```js:components/left_sidebar_header.jsx
import React from 'react';

const LeftSidebarHeaderComponent = () => {
	const style = {
		color: 'white',
	};
    return (
        <div style={style}>
            <p>left sidear header</p>
        </div>
    );
}

export default LeftSidebarHeader;
```

### [registerBottomTeamSidebarComponent](https://developers.mattermost.com/extend/plugins/webapp/reference/#registerBottomTeamSidebarComponent)

`registerBottomTeamSidebarComponent`ã¯ã€ãƒãƒ¼ãƒ é¸æŠã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ä¸‹éƒ¨ã«è¡¨ç¤ºã•ã‚Œã‚‹ Component ã‚’ç™»éŒ²ã—ã¾ã™ã€‚ï¼‘ã¤ã®ãƒãƒ¼ãƒ ã«ã—ã‹å‚åŠ ã—ã¦ã„ãªã„å ´åˆã€ãƒãƒ¼ãƒ é¸æŠã‚µã‚¤ãƒ‰ãƒãƒ¼è‡ªä½“ãŒè¡¨ç¤ºã•ã‚Œãªã„ãŸã‚ã€ã“ã“ã§ç™»éŒ²ã—ãŸ Component ã‚‚è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚

ç™»éŒ²ã•ã‚ŒãŸ Component ã§ä½¿ç”¨ã§ãã‚‹ props ã¯ç‰¹ã«ã‚ã‚Šã¾ã›ã‚“ã€‚[legacy_team_sidebar_controller.tsx](https://github.com/mattermost/mattermost-webapp/blob/61a4de5e36f994955bacc47c8d56734f9a699a5a/components/legacy_team_sidebar/legacy_team_sidebar_controller.tsx#L283)

![](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day20/bottom-team-sidebar.png)

```js:index.js
...
import BottomTeamSidebar from './components/bottom_team_sidebar';
...
export default class Plugin {
    // eslint-disable-next-line no-unused-vars
    initialize(registry, store) {
		...
        // User Popoverã«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã™ã‚‹Componentã®ç™»éŒ²
		registry.registerLeftSidebarHeaderComponent(BottomTeamSidebar)
		...
	}
}
```

```js:components/bottom_team_sidebar.jsx
import React from 'react';

const BottomTeamSidebarComponent = () => (
    <>
        <a href="https://github.com/">
            <i
                className='icon fa fa-github'
                style={{color: 'white'}}
            />
        </a>
    </>
);

export default BottomTeamSidebarComponent;
```

### [registerLinkTooltipComponent](https://developers.mattermost.com/extend/plugins/webapp/reference/#registerLinkTooltipComponent)

`registerLinkTooltipComponent`ã¯ã€ãƒªãƒ³ã‚¯ã‚’ hover ã—ãŸæ™‚ã«è¡¨ç¤ºã•ã‚Œã‚‹ tooltip ã® Component ã‚’ç™»éŒ²ã—ã¾ã™ã€‚

ç™»éŒ²ã—ãŸ Component ã¯ä»¥ä¸‹ã® props ã‚’å—ã‘å–ã‚Œã¾ã™ã€‚[link_tooltip.tsx](https://github.com/mattermost/mattermost-webapp/blob/cc4ba4576ad978d2a29e6c51c3f12966d121f0d6/components/link_tooltip/link_tooltip.tsx#L113)

- `href`: hover ã—ã¦ã„ã‚‹ãƒªãƒ³ã‚¯ã® URL
- `show`: tooltip ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°

ä»¥ä¸‹ã®ä¾‹ã§ã¯å˜ã« hover ã—ã¦ã„ã‚‹ãƒªãƒ³ã‚¯ã® URL ã‚’è¡¨ç¤ºã—ã¦ã„ã‚‹ã ã‘ã§ã™ãŒã€ãƒªãƒ³ã‚¯å…ˆã‹ã‚‰æƒ…å ±ã‚’å–å¾—ã—ã¦è¡¨ç¤ºã™ã‚‹ã‚ˆã†ãªã“ã¨ã‚‚ã§ãã¾ã™ã€‚

![](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day20/link-tooltip.png)

```js:index.js
...
import LinkTooltip from './components/link_tooltip';
...
export default class Plugin {
    // eslint-disable-next-line no-unused-vars
    initialize(registry, store) {
		...
        // User Popoverã«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã™ã‚‹Componentã®ç™»éŒ²
		registry.registerLinkTooltipComponent(LinkTooltip)
		...
	}
}
```

```js:components/link_tooltip.jsx
import React from 'react';
import PropTypes from 'prop-types';

const LinkTooltipComponent = ({href}) => {
    return (
        <>
            <p style={{
                backgroundColor: 'white',
                color: 'black',
                padding: '25px',
                border: '1px solid red',
            }}>
                {href}
            </p>
        </>
    )
}

LinkTooltipComponent.propTypes = {
    href: PropTypes.string.isRequired,
};

export default LinkTooltipComponent;
```

### [registerChannelHeaderButtonAction](https://developers.mattermost.com/extend/plugins/webapp/reference/#registerChannelHeaderButtonAction)

`registerChannelHeaderButtonAction`ã¯ã€`registerRootComponent`ã®ã¨ã“ã‚ã§ã‚‚ä½¿ç”¨ã—ã¾ã—ãŸãŒã€ãƒãƒ£ãƒ³ãƒãƒ«ã®ãƒ˜ãƒƒãƒ€éƒ¨åˆ†ã«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä»˜ãã®ãƒœã‚¿ãƒ³ã‚’ç™»éŒ²ã—ã¾ã™ã€‚

`registerChannelHeaderButtonAction`ã¯ã€`(icon, action, dropdownText, tooltipText)`ã®ï¼”ã¤ã®å¼•æ•°ã‚’å–ã‚Šã¾ã™ã€‚

- `icon`: ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ã™ React Element
- `action`: ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
  - ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸãƒãƒ£ãƒ³ãƒãƒ«ã®æƒ…å ±ã‚’æŒã¤[`channel`](https://github.com/mattermost/mattermost-server/blob/master/model/channel.go#L36)ã¨ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®[`channelMember`](https://github.com/mattermost/mattermost-server/blob/master/model/channel_member.go#L44)ã‚’å¼•æ•°ã«å–ã‚‹ã“ã¨ãŒã§ãã¾ã™
- `dropdown_text`: ãƒœã‚¿ãƒ³ãŒè¤‡æ•°ç™»éŒ²ã•ã‚Œã‚‹ã¨ä¸€ã¤ã®ã‚¢ã‚¤ã‚³ãƒ³ã«ã¾ã¨ã‚ã‚‰ã‚Œã€ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰é¸ã¶å½¢å¼ã«ãªã‚Šã¾ã™ãŒã€ãã®æ™‚ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«è¡¨ç¤ºã•ã‚Œã‚‹æ–‡å­—åˆ—
- `tooltip_text`: ãƒœã‚¿ãƒ³ã‚’ hover ã—ãŸæ™‚ã« tooltip ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã‚‹æ–‡å­—åˆ—

**ãƒœã‚¿ãƒ³å½¢å¼**

![](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day20/channel-header-button-button.png)

**ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³å½¢å¼**

![](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day20/channel-header-button-dropdown.png)

ã“ã“ã§ã¯ã€å…ˆã»ã©ã® Root Comopnent ã‚’é–‹ã Button ã¨ã€ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨æŠ•ç¨¿ã‚’ä½œæˆã™ã‚‹ Button ã® 2 ã¤ã® Button ã‚’è¡¨ç¤ºã™ã‚‹ä¾‹ã‚’ç¤ºã—ã¾ã™ã€‚æŠ•ç¨¿ã®ä½œæˆã¯[mattermost-redux](https://github.com/mattermost/mattermost-redux)ã‚’ä½¿ã£ã¦æŠ•ç¨¿ã‚’ä½œæˆã™ã‚‹ actions ã‚’ä½œæˆã—ã€Channel Header Button ã® action ã‹ã‚‰å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã€‚

![movie](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day20/channel-header-button.gif)

```js:index.js
import {openRootModal, createPluginPost} from './actions';
import reducer from './reducer';
import Root from './components/root';

...

export default class Plugin {
    // eslint-disable-next-line no-unused-vars
    initialize(registry, store) {
        // Root Componentã®ç™»éŒ²
        const rootComponentId = registry.registerRootComponent(Root)

        // Root Componentã‚’å‘¼ã³å‡ºã™ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ç™»éŒ²
        registry.registerChannelHeaderButtonAction(
            () => (<i className='icon fa fa-commenting-o' style={{fontSize: '15px', position: 'relative', top: '-1px'}}/>),
            () => store.dispatch(openRootModal()),
            "Open Root modal","Open Root modal"
		);

		...

        // æŠ•ç¨¿ã‚’ä½œæˆã™ã‚‹ãƒãƒ£ãƒ³ãƒãƒ«ãƒ˜ãƒƒãƒ€ãƒœã‚¿ãƒ³ã‚’ç™»éŒ²
        registry.registerChannelHeaderButtonAction(
            () => (<i className='icon fa fa-commenting-o' style={{fontSize: '15px', position: 'relative', top: '-1px'}}/>),
            (channel, channelMembers) => store.dispatch(createPluginPost(channel.id)),
            "Create Sample Post", "Create Sample Post"
        );

        registry.registerReducer(reducer);
    }
}
```

```js:actions.js
import {createPost} from 'mattermost-redux/actions/posts';
import {getCurrentUserId} from 'mattermost-redux/selectors/entities/users';

...

export function createPluginPost(channelId) {
    return async (dispatch, getState) => {
        const state = getState();
        const userId = getCurrentUserId(state)
        const post = {
            channel_id: channelId,
            user_id: userId,
            message: "Post from webapp plugin",
        }
        return await dispatch(createPost(post));
    }
}
```

### [registerPostTypeComponent](https://developers.mattermost.com/extend/plugins/webapp/reference/#registerPostTypeComponent)

`registerPostTypeComponent`ã¯ã€ç‰¹å®šã® type ã‚’æŒã¤æŠ•ç¨¿ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹æ™‚ã«ä½¿ç”¨ã•ã‚Œã‚‹ Component ã‚’ç™»éŒ²ã—ã¾ã™ã€‚æŠ•ç¨¿ï¼ˆ`Post`ï¼‰ã«ç‹¬è‡ªã® type ã‚’æŒ‡å®šã™ã‚‹å ´åˆã€ãã® type ã¯`custom_`ã§å§‹ã¾ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ç™»éŒ²ã—ãŸ Component ã¯ä»¥ä¸‹ã® props ã‚’å—ã‘å–ã‚Œã¾ã™ã€‚

- `post`: æŠ•ç¨¿ã®å†…å®¹ [post.go](https://github.com/mattermost/mattermost-server/blob/master/model/post.go#L72)
- `theme`: Mattermost ç”»é¢ã®é…è‰²ãƒ†ãƒ¼ãƒ [constants.jsx](https://github.com/mattermost/mattermost-webapp/blob/0b47780407e1f36e703df45e7fe694c7cf750244/utils/constants.jsx#L1047)

type ã«`custom_sample_post`ã‚’æŒã¤æŠ•ç¨¿ãŒä½œæˆã•ã‚ŒãŸå ´åˆã€èƒŒæ™¯è‰²ãŒèµ¤ã®æŠ•ç¨¿ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹ä¾‹ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚ä»Šå›ã¯ã€Incoming Webhook ã§æŠ•ç¨¿ã‚’ä½œæˆã™ã‚‹éš›ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦`custom_sample_post`ã®ç‹¬è‡ª type ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚

```bash
curl \
  -H "Content-Type: application/json" \
  -d '{"type": "custom_sample_post", "text": "Sample Message", "props": {"card": "## Sample\n* foo\n* bar"}}'  \
  http://localhost:8065/hooks/ucw5qjw86jgeum77o1uw8197jr
```

![](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day20/post-type.png)

```js:index.js
...
import CustomPost from './components/custom_post';

export default class Plugin {
    // eslint-disable-next-line no-unused-vars
    initialize(registry, store) {
		...
        // type: custom_sample_post ã‚’æŒã¤æŠ•ç¨¿ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹Componentã®ç™»éŒ²
		registry.registerPostTypeComponent('custom_sample_post', CustomPost);
	}
}
...
```

```js:components/custom_post.jsx
import React from 'react';
import PropTypes from 'prop-types';

const {formatText, messageHtmlToComponent} = window.PostUtils;

const CustomPostComponent = ({post, theme}) => {
    const formattedText = messageHtmlToComponent(formatText(post.message));

    console.log('theme', theme);
    return (
        <div style={{backgroundColor: '#ffcccc'}}>
            {formattedText}
            <pre>
                {JSON.stringify(post.props, null, 4)}
            </pre>
        </div>
    )
}

CustomPostComponent.propTypes = {
    post: PropTypes.object.isRequired,
    theme: PropTypes.object.isRequired,
};

export default CustomPostComponent;
```

ç‹¬è‡ªã® type ã‚’æŒ‡å®šã—ãŸæŠ•ç¨¿ã‚’ä½œæˆã—ãŸå¾Œã« Plugin ã‚’ç„¡åŠ¹ã«ã™ã‚‹ãªã©ã€type ã«å¯¾å¿œã—ãŸ Component ãŒç™»éŒ²ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€é€šå¸¸ã®æŠ•ç¨¿ã¨åŒã˜ã‚ˆã†ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã¾ã™ã€‚

### [registerPostCardTypeComponent](https://developers.mattermost.com/extend/plugins/webapp/reference/#registerPostCardTypeComponent)

`registerPostCardTypeComponent`ã¯ã€ç‰¹å®šã® type ã‚’æŒã¤æŠ•ç¨¿ã®`card`è¦ç´ ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹æ™‚ã«ä½¿ç”¨ã•ã‚Œã‚‹ Component ã‚’ç™»éŒ²ã—ã¾ã™ã€‚æŠ•ç¨¿ï¼ˆ`Post`ï¼‰ã«ç‹¬è‡ªã® type ã‚’æŒ‡å®šã™ã‚‹å ´åˆã€ãã® type ã¯`custom_`ã§å§‹ã¾ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ç™»éŒ²ã—ãŸ Component ã¯ä»¥ä¸‹ã® props ã‚’å—ã‘å–ã‚Œã¾ã™ã€‚

- `post`: æŠ•ç¨¿ã®å†…å®¹ [post.go](https://github.com/mattermost/mattermost-server/blob/master/model/post.go#L72)
- `theme`: Mattermost ç”»é¢ã®é…è‰²ãƒ†ãƒ¼ãƒ [constants.jsx](https://github.com/mattermost/mattermost-webapp/blob/0b47780407e1f36e703df45e7fe694c7cf750244/utils/constants.jsx#L1047)

type ã«`custom_sample_card`ã‚’æŒã¤æŠ•ç¨¿ãŒä½œæˆã•ã‚ŒãŸå ´åˆã€èƒŒæ™¯è‰²ãŒé’ã®ã‚«ãƒ¼ãƒ‰è¦ç´ ã‚’æŒã¤æŠ•ç¨¿ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹ä¾‹ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚`custom_sample_card`ã¨ã„ã†ç‹¬è‡ª type ã¯ Incoming Webhook ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚

```bash
curl \
  -H "Content-Type: application/json" \
  -d '{"type": "custom_sample_card", "text": "Sample Message", "props": {"card": "## Sample\n* foo\n* bar"}}'  \
  http://localhost:8065/hooks/ucw5qjw86jgeum77o1uw8197jr
```

![](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day20/post-card-type.png)

ä½œæˆã™ã‚‹æŠ•ç¨¿ã«`props.card`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒãªã„å ´åˆã€`card`è¦ç´ ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã®`i`ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œãªã„ãŸã‚ã‚«ãƒ¼ãƒ‰è¦ç´ ã‚’è¡¨ç¤ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚å¿…ãš`props.card`è¦ç´ ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```js:index.js
...
import CustomCard from './components/custom_card';

export default class Plugin {
    // eslint-disable-next-line no-unused-vars
    initialize(registry, store) {
		...
        // type: custom_sample_card ã‚’æŒã¤æŠ•ç¨¿ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹Componentã®ç™»éŒ²
        registry.registerPostCardTypeComponent('custom_sample_card', CustomCard);
	}
}
...
```

```js:components/custom_card.jsx
import React from 'react';
import PropTypes from 'prop-types';

const {formatText, messageHtmlToComponent} = window.PostUtils;

const CustomCardComponent = ({post, theme}) => {
    const formattedText = messageHtmlToComponent(formatText(post.message));

    console.log('theme', theme);
    return (
        <div style={{backgroundColor: '#ccccff'}}>
            {formattedText}
            <pre>
                {JSON.stringify(post.props, null, 4)}
            </pre>
        </div>
    )
}

CustomCardComponent.propTypes = {
    post: PropTypes.object.isRequired,
    theme: PropTypes.object.isRequired,
};

export default CustomCardComponent;
```

ç‹¬è‡ªã® type ã‚’æŒ‡å®šã—ãŸæŠ•ç¨¿ã‚’ä½œæˆã—ãŸå¾Œã« Plugin ã‚’ç„¡åŠ¹ã«ã™ã‚‹ãªã©ã€type ã«å¯¾å¿œã—ãŸ Component ãŒç™»éŒ²ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€é€šå¸¸ã®æŠ•ç¨¿ã¨åŒã˜ã‚ˆã†ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã¾ã™ã€‚

### [registerPostWillRenderEmbedComponent ](https://developers.mattermost.com/extend/plugins/webapp/reference/#registerPostWillRenderEmbedComponent)

`registerPostWillRenderEmbedComponent`ã¯ã€æŠ•ç¨¿å†…ã§æœ€åˆã«å‡ºç¾ã™ã‚‹ URL ã®å†…å®¹ã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã™ã‚‹éƒ¨åˆ†ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ç™»éŒ²ã—ã¾ã™ã€‚OpenGraph ã®æƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹ã‚¢ãƒ¬ã§ã™ã€‚

![](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day20/post-will-render-embed-sample.png)

`registerPostWillRenderEmbedComponent`ã¯ 3 ã¤ã®å¼•æ•°ã‚’å–ã‚Šã¾ã™ã€‚

- `match`: ã“ã“ã§æŒ‡å®šã—ãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦ç´ ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹ã‹ã©ã†ã‹ã‚’æ±ºå®šã™ã‚‹ãŸã‚ã®é–¢æ•°ã€‚ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºå¯¾è±¡ã® URL ã‚„ç¨®åˆ¥ã‚’ä½¿ã„ã€`true`ã‚’è¿”ã™ã¨ã“ã“ã§æŒ‡å®šã—ãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã€‚
- `component`: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦ç´ ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
- `toggleable`: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦ç´ ã‚’æŠ˜ã‚Šç•³ã¿å¯èƒ½ã«ã™ã‚‹ã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°

ã¾ãŸã€ç™»éŒ²ã—ãŸ`Component`ã¯ä»¥ä¸‹ã® props ã‚’å—ã‘å–ã‚Œã¾ã™ã€‚

- `embed`: æŠ•ç¨¿ã®å†…å®¹ [post.go](https://github.com/mattermost/mattermost-server/blob/master/model/post.go#L72)
  - `type`: `url`ã‹ã‚‰å–å¾—ã§ãã‚‹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ç¨®åˆ¥ã€‚`opengraph`ã‚„`image`ãªã©ã®å€¤ãŒå…¥ã‚‹
  - `url`: æŠ•ç¨¿ãªã„ã§æœ€åˆã«å‡ºç¾ã™ã‚‹ URL
  - `data`: `url`ã‹ã‚‰å–å¾—ã§ãã‚‹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†…å®¹ã«é–¢ã™ã‚‹æƒ…å ±ãŒæ ¼ç´ã•ã‚Œã‚‹ã‚‰ã—ã„ãŒã€è©¦ã—ã¦ã„ã‚‹ä¸­ã§ã¯å€¤ãŒå–å¾—ã§ããªã‹ã£ãŸ

`https://github.com/mattermost`ã§å§‹ã¾ã‚‹ URL ãŒæŒ‡å®šã•ã‚ŒãŸå ´åˆã«ã€é’ã„èƒŒæ™¯è‰²ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹ä¾‹ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚

![](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day20/post-will-render-embed.png)

```js:index.js
...
import CustomEmbed from './components/custom_embed';

export default class Plugin {
    // eslint-disable-next-line no-unused-vars
    initialize(registry, store) {
		...
        // æŠ•ç¨¿ã«å«ã¾ã‚Œã‚‹URLã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹Componentã®ç™»éŒ²
        registry.registerPostWillRenderEmbedComponent(
            (embed) => embed.url && embed.url.startsWith(`https://github.com/mattermost/`),
            CustomEmbed,
            true
        );
    }
}
...
```

```js:components/custom_embed.jsx
import React from 'react';
import PropTypes from 'prop-types';

const CustomEmbedComponent = ({embed}) => {
    const {type, url, data} = embed;
    return (
        <div style={{backgroundColor: '#ccffcc'}}>
            <p>{type}</p>
            <p>{url}</p>
            <pre>
                {JSON.stringify(data, null, 4)}
            </pre>
        </div>
    )
}

CustomEmbedComponent.propTypes = {
    embed: PropTypes.shape ({
        type: PropTypes.string.isRequired,
        url: PropTypes.string.isRequired,
        data: PropTypes.object.isRequired,
    })
};

export default CustomEmbedComponent;
```

ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã®`oEmbed-plugin`ãƒ–ãƒ©ãƒ³ãƒã«ã€Mattermost å…¬å¼ãƒãƒ¼ãƒ ã«ã‚ˆã‚‹`registerPostWillRenderEmbedComponent`ã‚’ä½¿ç”¨ã—ãŸãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®å®Ÿè£…ãŒæ®‹ã£ã¦ã„ã¾ã™ã€‚ï¼ˆä½œã‚Šã‹ã‘ã§æ­¢ã¾ã£ã¦ã„ã‚‹ã‚ˆã†ã§ã™ãŒï¼‰
https://github.com/mattermost/mattermost-plugin-oembed/tree/oEmbed-plugin

### [registerMainMenuAction](https://developers.mattermost.com/extend/plugins/webapp/reference/#registerMainMenuAction)

`registerMainMenuAction`ã¯ã€Mattermost ã®ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼éƒ¨åˆ†ã«ç‹¬è‡ªã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ ã—ã¾ã™ã€‚

`registerPostWillRenderEmbedComponent`ã¯ 3 ã¤ã®å¼•æ•°ã‚’å–ã‚Šã¾ã™ã€‚

- `text`: ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«è¡¨ç¤ºã•ã‚Œã‚‹æ–‡å­—åˆ—ã‹ React Element ã‚’æŒ‡å®šã—ã¾ã™
- `action`: ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒé¸æŠã•ã‚ŒãŸéš›ã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç™»éŒ²ã—ã¾ã™
- `mobileIcon`: ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªã§è¡¨ç¤ºã•ã‚Œã‚‹ã‚¢ã‚¤ã‚³ãƒ³ã‚’ç™»éŒ²ã—ã¾ã™ï¼ˆãŒã€ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªã ã¨ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºã•ã‚Œãªã„...?ï¼‰

ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒç™»éŒ²ã•ã‚ŒãŸãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ ã™ã‚‹ä¾‹ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚

![](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day20/main-menu.gif)

```js:index.js
...
export default class Plugin {
    // eslint-disable-next-line no-unused-vars
    initialize(registry, store) {
		...
        // ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ ã™ã‚‹
        registry.registerMainMenuAction(
            'Sample Main Menu',
            () => store.dispatch(openRootModal()),
            () => (<i className='icon fa fa-plug' style={{fontSize: '15px', position: 'relative', top: '-1px'}}/>)
        );
    }
}
...
```

### [registerChannelHeaderMenuAction](https://developers.mattermost.com/extend/plugins/webapp/reference/#registerChannelHeaderMenuAction)

`registerChannelHeaderMenuAction`ã¯ã€ãƒãƒ£ãƒ³ãƒãƒ«åã®éƒ¨åˆ†ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚ã«è¡¨ç¤ºã•ã‚Œã‚‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ç‹¬è‡ªã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ ã—ã¾ã™ã€‚

`registerPostWillRenderEmbedComponent`ã¯ 2 ã¤ã®å¼•æ•°ã‚’å–ã‚Šã¾ã™ã€‚

- `text`: ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«è¡¨ç¤ºã•ã‚Œã‚‹æ–‡å­—åˆ—ã‹ React Element
- `action`: ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒé¸æŠã•ã‚ŒãŸéš›ã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€‚å®Ÿè¡Œã•ã‚ŒãŸãƒãƒ£ãƒ³ãƒãƒ«ã®ãƒãƒ£ãƒ³ãƒãƒ« ID ãŒæ¸¡ã•ã‚Œã¾ã™ã€‚

ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒç™»éŒ²ã•ã‚ŒãŸãƒãƒ£ãƒ³ãƒãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ ã™ã‚‹ä¾‹ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚

![](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day20/channel-header-menu-action.gif)

```js:index.js
...
export default class Plugin {
    // eslint-disable-next-line no-unused-vars
    initialize(registry, store) {
		...
        // ãƒãƒ£ãƒ³ãƒãƒ«åã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸéš›ã«è¡¨ç¤ºã•ã‚Œã‚‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ç‹¬è‡ªãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ ã™ã‚‹
        registry.registerChannelHeaderMenuAction(
            <i className='icon fa fa-plug' style={{fontSize: '15px', position: 'relative', top: '-1px'}}>{'Sample Menu'}</i>,
            (chnnelId) => store.dispatch(openRootModal())
        );
    }
}
...
```

### [registerPostDropdownMenuAction](https://developers.mattermost.com/extend/plugins/webapp/reference/#registerPostDropdownMenuAction)

`registerPostDropdownMenuAction`ã¯ã€æŠ•ç¨¿ã«å¯¾ã™ã‚‹ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ç‹¬è‡ªã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ ã—ã¾ã™ã€‚

`registerPostDropdownMenuAction`ã¯ 3 ã¤ã®å¼•æ•°ã‚’å–ã‚Šã¾ã™ã€‚

- `text`: ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«è¡¨ç¤ºã•ã‚Œã‚‹æ–‡å­—åˆ—ã‹ React Element
- `action`: ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒé¸æŠã•ã‚ŒãŸéš›ã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€‚ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒå®Ÿè¡Œã•ã‚ŒãŸæŠ•ç¨¿ã® PostID ãŒæ¸¡ã•ã‚Œã¾ã™ã€‚
- `filter`: ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹ã‹ã©ã†ã‹ã‚’æ±ºå®šã™ã‚‹é–¢æ•°ã€‚å®Ÿè¡Œã•ã‚ŒãŸæŠ•ç¨¿ã® PostID ãŒæ¸¡ã•ã‚Œã¾ã™ã€‚

ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒç™»éŒ²ã•ã‚ŒãŸãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ ã™ã‚‹ä¾‹ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚

![](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day20/post-dropdown-menu-action.gif)

```js:index.js
...
export default class Plugin {
    // eslint-disable-next-line no-unused-vars
    initialize(registry, store) {
		...
        // æŠ•ç¨¿ã«å¯¾ã™ã‚‹ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ç‹¬è‡ªãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ ã™ã‚‹
        registry.registerPostDropdownMenuAction(
            <i className='icon fa fa-plug' style={{fontSize: '15px'}}>{'Sample Post Menu'}</i>,
            (postId) => store.dispatch(openRootModal()),
            (postId) => { return true; }
        );
    }
}
...
```

### [registerPostDropdownSubMenuAction](https://developers.mattermost.com/extend/plugins/webapp/reference/#registerPostDropdownSubMenuAction)

`registerPostDropdownSubMenuAction`ã¯ã€æŠ•ç¨¿ã«å¯¾ã™ã‚‹ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä»˜ãã®ç‹¬è‡ªã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ ã—ã¾ã™ã€‚

ã¾ãšã€`registerPostDropdownSubMenuAction`ã¯ 3 ã¤ã®å¼•æ•°ã‚’å–ã‚Šã¾ã™ã€‚

- `text`: ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«è¡¨ç¤ºã•ã‚Œã‚‹æ–‡å­—åˆ—ã‹ React Element
- `action`: ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒé¸æŠã•ã‚ŒãŸéš›ã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€‚å®Ÿè¡Œã•ã‚ŒãŸæŠ•ç¨¿ã® PostID ãŒæ¸¡ã•ã‚Œã¾ã™ã€‚(ã—ã‹ã—ã€ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚‚ä½•ã‚‚å®Ÿè¡Œã•ã‚Œãªã„ã‚ˆã†ã§ã™)
- `filter`: ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹ã‹ã©ã†ã‹ã‚’æ±ºå®šã™ã‚‹é–¢æ•°ã€‚ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒå®Ÿè¡Œã•ã‚ŒãŸæŠ•ç¨¿ã® PostID ãŒæ¸¡ã•ã‚Œã¾ã™ã€‚

`registerPostDropdownSubMenuAction`ã¯ã€è¿”ã‚Šå€¤ã¨ã—ã¦ç™»éŒ²ã—ãŸã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã® ID ã¨ã€ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ç™»éŒ²ã™ã‚‹ãŸã‚ã®é–¢æ•°ã‚’è¿”ã—ã¾ã™ã€‚ã“ã“ã§è¿”ã•ã‚Œã‚‹é–¢æ•°ã‚’ä½¿ã£ã¦ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ç™»éŒ²ã—ã¦ã„ãã¾ã™ãŒã€ã“ã®é–¢æ•°ã¯ 2 ã¤ã®å¼•æ•°ã‚’å–ã‚Šã¾ã™ã€‚

- `text`: ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«è¡¨ç¤ºã•ã‚Œã‚‹æ–‡å­—åˆ—ã‹ React Element
- `action`: ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒé¸æŠã•ã‚ŒãŸéš›ã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€‚ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒå®Ÿè¡Œã•ã‚ŒãŸæŠ•ç¨¿ã® PostID ãŒæ¸¡ã•ã‚Œã¾ã™ã€‚

ï¼ˆã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ç™»éŒ²ã™ã‚‹é–¢æ•°ã®ç¬¬ 3 å¼•æ•°ã¨ã—ã¦`filter`ã¨ãªã‚‹é–¢æ•°ã‚’æ¸¡ã—ã¦ã‚‚ã€ç‰¹ã«åŠ¹æœã¯ãªã„ã‚ˆã†ã§ã™ï¼‰

ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒç™»éŒ²ã•ã‚ŒãŸãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ ã™ã‚‹ä¾‹ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚

![](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day20/post-dropdown-submenu.gif)

```js:index.js
...
export default class Plugin {
    // eslint-disable-next-line no-unused-vars
    initialize(registry, store) {
		...
        // æŠ•ç¨¿ã«å¯¾ã™ã‚‹ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä»˜ãã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ ã™ã‚‹
        const {id, rootRegisterMenuItem} = registry.registerPostDropdownSubMenuAction(
            <i className='icon fa fa-plug' style={{fontSize: '15px'}}>{'Sample SubMenu'}</i>,
            (postId) => store.dispatch(openRootModal()),  // å®Ÿè¡Œã•ã‚Œãªã„
            (postId) => { return true; }
        );
        rootRegisterMenuItem(
            <i className='icon fa fa-plug' style={{fontSize: '15px'}}>{'SubMenu 1'}</i>,
            (postId) => store.dispatch(openRootModal()),
        );
        rootRegisterMenuItem(
            <i className='icon fa fa-plug' style={{fontSize: '15px'}}>{'SubMenu 2'}</i>,
            (postId) => store.dispatch(openRootModal())
        );
    }
}
...
```

### [registerPostDropdownMenuComponent](https://developers.mattermost.com/extend/plugins/webapp/reference/#registerPostDropdownMenuComponent)

`registerPostDropdownMenuComponent`ã¯ã€æŠ•ç¨¿ã«å¯¾ã™ã‚‹ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ç‹¬è‡ªã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’è¿½åŠ ã—ã¾ã™ã€‚

ç™»éŒ²ã—ãŸ Component ã¯ä»¥ä¸‹ã® props ã‚’å—ã‘å–ã‚Œã¾ã™ã€‚

- `postId`: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒå®Ÿè¡Œã•ã‚ŒãŸæŠ•ç¨¿ã® PostID
- `theme`: Mattermost ç”»é¢ã®é…è‰²ãƒ†ãƒ¼ãƒ [constants.jsx](https://github.com/mattermost/mattermost-webapp/blob/0b47780407e1f36e703df45e7fe694c7cf750244/utils/constants.jsx#L1047)
- `dispatch`: action ã‚’ dispatch ã™ã‚‹ãŸã‚ã®é–¢æ•°

ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒç™»éŒ²ã•ã‚ŒãŸãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ ã™ã‚‹ä¾‹ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚

![](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day20/post-dropdown-component.gif)

```js:index.js
...
import CustomPostDropdown from './components/custom_post_dropdown';
...
export default class Plugin {
    // eslint-disable-next-line no-unused-vars
    initialize(registry, store) {
		...
        // æŠ•ç¨¿ã«å¯¾ã™ã‚‹ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ç™»éŒ²ã™ã‚‹
        registry.registerPostDropdownMenuComponent(CustomPostDropdown);
		...
	}
}
```

```js:components/custom_post_dropdown.jsx
import React from 'react';
import PropTypes from 'prop-types';

import {openRootModal} from 'actions';

const CustomPostDropdownComponent = ({postId, theme, dispatch}) => {
    return (
        <div
            style={{backgroundColor: '#ffcccc'}}
            onClick={() => dispatch(openRootModal())}
        >
            {postId}
        </div>
    )
}

CustomPostDropdownComponent.propTypes = {
    postId: PropTypes.string.isRequired,
    theme: PropTypes.object.isRequired,
    dispatch: PropTypes.func.isRequired,
};

export default CustomPostDropdownComponent;
```

### [registerFileUploadMethod](https://developers.mattermost.com/extend/plugins/webapp/reference/#registerFileUploadMethod)

`registerFileUploadMethod`ã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ç‹¬è‡ªã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ ã—ã¾ã™ã€‚

`registerFileUploadMethod`ã¯ 3 ã¤ã®å¼•æ•°ã‚’å–ã‚Šã¾ã™ã€‚(å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯å¼•æ•°ã®é †åºãŒé•ã£ã¦ã„ã‚‹ã®ã§æ³¨æ„)

- `icon`: JSX å½¢å¼ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚¢ã‚¤ã‚³ãƒ³
- `action`: ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒé¸æŠã•ã‚ŒãŸéš›ã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãŸã‚ã®é–¢æ•°ãŒæ¸¡ã•ã‚Œã¾ã™ã€‚
- `text`: ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«è¡¨ç¤ºã•ã‚Œã‚‹ãƒ†ã‚­ã‚¹ãƒˆ

ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒé¸æŠã•ã‚Œã‚‹ã¨ã€ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒ 2 ã¤ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ä¾‹ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚

![](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day20/file-upload-method.gif)

```js:index.js
...
export default class Plugin {
    // eslint-disable-next-line no-unused-vars
    initialize(registry, store) {
		...
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ ã™ã‚‹
        registry.registerFileUploadMethod(
            <i className='icon fa fa-pencil-square-o' style={{fontSize: '15px'}}/>,
            (upload) => upload([
                new File(["test1"], "sample1.txt"),
                new File(["test2"], 'sample2.txt')
            ]),
            'Sample File Upload'
        );
    }
}
...
```

### [registerFilesWillUploadHook](https://developers.mattermost.com/extend/plugins/webapp/reference/#registerFilesWillUploadHook)

`registerFilesWillUploadHook`ã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚ã«å®Ÿè¡Œã•ã‚Œã‚‹é–¢æ•°ã‚’ç™»éŒ²ã§ãã¾ã™ã€‚

`registerFilesWillUploadHook`ã¯ 2 ã¤ã®å¼•æ•°ã‚’å–ã‚‹é–¢æ•°ã‚’å¼•æ•°ã«å–ã‚Šã¾ã™ã€‚

- `files`: ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã®é…åˆ—
- `upload`: ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãŸã‚ã®é–¢æ•°
  - ã“ã®é–¢æ•°ã‚’ä½¿ã‚ãªãã¨ã‚‚ã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿”å´å€¤ã¨ã—ã¦æŒ‡å®šã™ã‚‹ã“ã¨ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™

è¿”ã‚Šå€¤ã¨ã—ã¦ä»¥ä¸‹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŒã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”å´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

- `message`: å‡¦ç†çµæœã¨ã—ã¦ç”»é¢ã«è¡¨ç¤ºã•ã‚Œã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŒ‡å®šã—ã¾ã™
- `files`: å‡¦ç†çµæœã¨ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…åˆ—ã¨ã—ã¦æŒ‡å®šã—ã¾ã™ã€‚`null`ã‚’æŒ‡å®šã™ã‚‹ã¨ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’ reject ã—ã¾ã™ã€‚

2 ã¤ä»¥ä¸Šã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åŒæ™‚ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’ reject ã™ã‚‹ä¾‹ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚

![](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day20/files-will-upload-hook.gif)

```js:index.js
...
export default class Plugin {
    // eslint-disable-next-line no-unused-vars
    initialize(registry, store) {
		...

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚ã®å‡¦ç†ã‚’ç™»éŒ²ã™ã‚‹
        registry.registerFilesWillUploadHook((files, upload) => {
            let msg = '';
            if (files.length >= 2 ) {
                files = null;
                msg = 'Must upload one by one.';
            }
            return {
                message: msg,
                files: files,
            };
        });
    }
}
...
```

### [unregisterComponent](https://developers.mattermost.com/extend/plugins/webapp/reference/#unregisterComponent)

`unregisterComponent`ã¯ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¨ã—ã¦ç™»éŒ²ã—ãŸ Component ã‚„ Hook ã‚’ç™»éŒ²ã‹ã‚‰é™¤å¤–ã—ã¾ã™ã€‚

`registerLeftSidebarHeaderComponent`ã«ã‚ˆã£ã¦ç™»éŒ²ã—ãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ç™»éŒ²ã‹ã‚‰é™¤å¤–ã™ã‚‹ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ä¾‹ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚

![](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day20/unregister-component.gif)

```js:index.js
...
export default class Plugin {
    // eslint-disable-next-line no-unused-vars
    initialize(registry, store) {
		...
        // å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ä¸Šéƒ¨ã«è¡¨ç¤ºã•ã‚Œã‚‹Componentã®ç™»éŒ²
        const leftSidebarHeaderComponentId = registry.registerLeftSidebarHeaderComponent(LeftSidebarHeader);
        ...
        // ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã«ã‚ˆã£ã¦ç™»éŒ²ã•ã‚ŒãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ç™»éŒ²ã‹ã‚‰é™¤å¤–ã™ã‚‹
        registry.registerMainMenuAction(
            'Unregister LeftSideberHeader',
            () => registry.unregisterComponent(leftSidebarHeaderComponentId),
            () => (<i className='icon fa fa-plug' style={{fontSize: '15px', position: 'relative', top: '-1px'}}/>)
        );
    }
}
...
```

### [unregisterPostTypeComponent](https://developers.mattermost.com/extend/plugins/webapp/reference/#unregisterPostTypeComponent)

`unregisterPostTypeComponent`ã¯ã€`unregisterComponent`ã¨åŒæ§˜ã€ç‹¬è‡ªã®`PostType`ã«å¯¾ã—ã¦è¨­å®šã—ãŸ Component ã‚’ç™»éŒ²ã‹ã‚‰é™¤å¤–ã—ã¾ã™ã€‚

ä¾‹ã¯çœç•¥ã—ã¾ã™ã€‚

### [registerReducer](https://developers.mattermost.com/extend/plugins/webapp/reference/#registerReducer)

`registerReducer`ã¯ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å†…ã§ä½¿ç”¨ã™ã‚‹ Reducer ã‚’ç™»éŒ²ã—ã¾ã™ã€‚

ã“ã“ã¾ã§ã«ç´¹ä»‹ã—ã¦ããŸä¾‹ã§ã¯ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒå®Ÿè¡Œã•ã‚ŒãŸå ´åˆãªã©ã«`registerReducer`ã«ã‚ˆã£ã¦ç™»éŒ²ã•ã‚ŒãŸ reducer ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚

```js:index.js
...
import reducer from './reducer';
...
export default class Plugin {
    // eslint-disable-next-line no-unused-vars
    initialize(registry, store) {
		...
        // Reducerã‚’ç™»éŒ²ã™ã‚‹
        registry.registerReducer(reducer);
    }
}
```

```js:reducer.js
import {combineReducers} from 'redux';

import {OPEN_ROOT_MODAL, CLOSE_ROOT_MODAL} from './action_types';

const rootModalVisible = (state = false, action) => {
    switch (action.type) {
    case OPEN_ROOT_MODAL:
        return true;
    case CLOSE_ROOT_MODAL:
        return false;
    default:
        return state;
    }
};

export default combineReducers({
    rootModalVisible,
});
```

```js:action_types.js
import {id as pluginId} from './manifest';

export const OPEN_ROOT_MODAL = pluginId + '_open_root_modal';
export const CLOSE_ROOT_MODAL = pluginId + '_close_root_modal';
```


## Webapp Plugin API

### [registerWebSocketEventHandler](https://developers.mattermost.com/extend/plugins/webapp/reference/#registerWebSocketEventHandler)

`registerWebSocketEventHandler`ã¯ã€Mattermost Server ã‹ã‚‰é€ä¿¡ã•ã‚Œã‚‹ WebSocket ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†ã™ã‚‹ Handler ã‚’ç™»éŒ²ã—ã¾ã™ã€‚

`registerWebSocketEventHandler`ã¯ 2 ã¤ã®å¼•æ•°ã‚’å–ã‚Šã¾ã™ã€‚

- `event`: å‡¦ç†ã™ã‚‹ WebSocket ã‚¤ãƒ™ãƒ³ãƒˆã®ç¨®åˆ¥
- `handler`: WebSocket ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’å¼•æ•°ã«å–ã‚‹é–¢æ•°ã€‚å¼•æ•°ã®ãƒ‡ãƒ¼ã‚¿ã¯ã‚¤ãƒ™ãƒ³ãƒˆã«ã‚ˆã£ã¦ç•°ãªã‚Šã¾ã™ã€‚

Server ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®[PublishWebSocketEvent](https://developers.mattermost.com/extend/plugins/server/reference/#API.PublishWebSocketEvent)ã¨çµ„ã¿åˆã‚ã›ã¦ä½¿ç”¨ã™ã‚‹ã¨å¼·åŠ›ã§ã™ãŒã€ãã®è¾ºã‚Šã®ä¾‹ã«ã¤ã„ã¦ã¯ 22 æ—¥ç›®ä»¥é™ã®è¨˜äº‹ã§ç´¹ä»‹ã—ã¾ã™ã€‚

ã“ã“ã§ã¯ã€Mattermost ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® WebSocket ã‚¤ãƒ™ãƒ³ãƒˆã§ã‚ã‚‹æŠ•ç¨¿ãŒä½œæˆã•ã‚ŒãŸéš›ã«é€ä¿¡ã•ã‚Œã‚‹`posted`ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ä¿¡ã—ãŸéš›ã«ã€æŠ•ç¨¿å†…å®¹ã«`open modal`ã¨ã„ã†æ–‡è¨€ãŒå…¥ã£ã¦ã„ãŸå ´åˆã«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãä¾‹ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚

![](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day21/websocket-event-handler.gif)

```js:index.js
...
import {openRootModal, createPluginPost} from './actions';
...
export default class Plugin {
    // eslint-disable-next-line no-unused-vars
    initialize(registry, store) {
		...
        // 'open modal'ã‚’å«ã‚€æŠ•ç¨¿ã‚’å—ä¿¡ã™ã‚‹ã¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        registry.registerWebSocketEventHandler(
            'posted',
            (event) => {
                const post = JSON.parse(event.data.post);
                if (post && post.message && post.message.includes('open modal')) {
                    store.dispatch(openRootModal());
                }
            }
        );
    }
}
```

### [unregisterWebSocketEventHandler](https://developers.mattermost.com/extend/plugins/webapp/reference/#unregisterWebSocketEventHandler)

`unregisterWebSocketEventHandler`ã¯ã€`registerWebSocketEventHandler`ã«ã‚ˆã£ã¦ WebSocket ã‚¤ãƒ™ãƒ³ãƒˆã«å¯¾ã—ã¦è¨­å®šã•ã‚ŒãŸ Handler ã‚’ç™»éŒ²ã‹ã‚‰é™¤å¤–ã—ã¾ã™ã€‚

ä¾‹ã¯çœç•¥ã—ã¾ã™ã€‚

### [registerReconnectHandler](https://developers.mattermost.com/extend/plugins/webapp/reference/#registerReconnectHandler)

`registerReconnectHandler`ã¯ã€ä¸€åº¦ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šãŒå¤±ã‚ã‚ŒãŸå¾Œã«å†ã³ Mattermost ã¸æ¥ç¶šã—ãŸéš›ã«å®Ÿè¡Œã•ã‚Œã‚‹ Handler ã§ã™ã€‚

`registerReconnectHandler`ã¯å¼•æ•°ã®ãªã„é–¢æ•°ã‚’å¼•æ•°ã«å–ã‚Šã¾ã™ã€‚

- `handler`: Mattermost ã¸å†æ¥ç¶šã—ãŸéš›ã«å®Ÿè¡Œã•ã‚Œã‚‹é–¢æ•°

ä¾‹ã¯çœç•¥ã—ã¾ã™ã€‚

### [unregisterReconnectHandler](https://developers.mattermost.com/extend/plugins/webapp/reference/#unregisterReconnectHandler)

`unregisterReconnectHandler`ã¯ã€`registerReconnectHandler`ã§ç™»éŒ²ã—ãŸ Handler ã‚’ç™»éŒ²ã‹ã‚‰é™¤å¤–ã—ã¾ã™ã€‚å¼•æ•°ã¯å–ã‚Šã¾ã›ã‚“ã€‚

ã“ã¡ã‚‰ã‚‚ä¾‹ã¯çœç•¥ã—ã¾ã™ã€‚

### [registerMessageWillBePostedHook](https://developers.mattermost.com/extend/plugins/webapp/reference/#registerMessageWillBePostedHook)

`registerMessageWillBePostedHook`ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŠ•ç¨¿ã‚’é€ä¿¡ã—ãŸéš›ã€ãã®æŠ•ç¨¿ãŒã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã•ã‚Œã‚‹å‰ã«å®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†ã‚’ç™»éŒ²ã—ã¾ã™ã€‚

`registerMessageWillBePostedHook`ã¯ã€å¼•æ•°ã‚’ 1 ã¤å–ã‚Šã¾ã™ã€‚

- `hook`: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã£ã¦æŠ•ç¨¿å‡¦ç†ãŒå®Ÿè¡Œã•ã‚ŒãŸéš›ã€ãã®æŠ•ç¨¿ãŒã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã•ã‚Œã‚‹ç›´å‰ã«å®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†

`hooks`ã¯ã€å¼•æ•°ã‚’ä¸€ã¤å–ã‚Šã¾ã™ã€‚

- `post`: æŠ•ç¨¿ã®æƒ…å ±

`hook`ã®è¿”ã‚Šå€¤ã¨ã—ã¦ã€æŠ•ç¨¿æƒ…å ±ã‚’æŒã¤`error`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å«ã‚€å€¤ã‚’è¿”å´ã—ãŸå ´åˆã€æŠ•ç¨¿ã¯ reject ã•ã‚Œã¾ã™ã€‚æŠ•ç¨¿æƒ…å ±ã‚’æŒã¤`post`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚’å«ã‚€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”å´ã—ãŸå ´åˆã¯ã€`post`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å€¤ã§æŠ•ç¨¿ãŒä½œæˆã•ã‚Œã¾ã™ã€‚

`å¿™ã—ã„`ã¨ã„ã†æ–‡è¨€ã‚’å«ã‚€æŠ•ç¨¿ã‚’ä½œæˆã™ã‚‹ã¨ reject ã•ã‚Œã€`å¸°ã‚ŠãŸã„`ã¨ã„ã†æ–‡è¨€ã‚’å«ã‚€æŠ•ç¨¿ã‚’ä½œæˆã™ã‚‹ã¨`ä»•äº‹ã—ãŸã„`ã«å¤‰æ›ã•ã‚Œã‚‹ä¾‹ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚

![](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day21/message-will-be-posted-hook.gif)

```js:index.js
...
export default class Plugin {
    // eslint-disable-next-line no-unused-vars
    initialize(registry, store) {
		...
        // æŠ•ç¨¿ãŒã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã•ã‚Œã‚‹å‰ã«rejectã—ãŸã‚Šå†…å®¹ã‚’å¤‰æ›ã—ãŸã‚Šã™ã‚‹
        registry.registerMessageWillBePostedHook(
            (post) => {
                if (post.message && post.message.includes('å¿™ã—ã„')) {
                    return {error: {message: 'å¿™ã—ãã¯ãªã„ã¯ãšã§ã™'}};
                }
                post.message = post.message.replace(/å¸°ã‚ŠãŸã„/gi, 'ä»•äº‹ã—ãŸã„');
                return {post: post};
            }
        );
    }
}
```

### [registerSlashCommandWillBePostedHook](https://developers.mattermost.com/extend/plugins/webapp/reference/#registerSlashCommandWillBePostedHook)

`registerSlashCommandWillBePostedHook`ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ Slash Command ã‚’å®Ÿè¡Œã—ãŸéš›ã€ãã®æŠ•ç¨¿ãŒã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã•ã‚Œã‚‹å‰ã«å®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†ã‚’ç™»éŒ²ã—ã¾ã™ã€‚

`registerSlashCommandWillBePostedHook`ã¯ã€å¼•æ•°ã‚’ 1 ã¤å–ã‚Šã¾ã™ã€‚

- `hook`: Slash Command ãŒå®Ÿè¡Œã•ã‚ŒãŸéš›ã«ã€ãã®å†…å®¹ãŒã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã•ã‚Œã‚‹ç›´å‰ã«å®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†

`hook`ã¯ã€å¼•æ•°ã‚’ 2 ã¤å–ã‚Šã¾ã™ã€‚

- `message`: æŠ•ç¨¿ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- `args`: Slash Command å®Ÿè¡Œæƒ…å ±(`channel_id`, `team_id`, `root_id`, `parent_id`)

`/away`ã‚’ rejectã€`/help`ã‚’`/shrug`ã«æ›¸ãæ›ãˆã€`/leave`ã‚’ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—ã§ reject ã™ã‚‹ã‚ˆã†ãªå‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ä¾‹ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚

![](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day21/slash-command-will-be-posted-hook.gif)

```js:index.js
...
export default class Plugin {
    // eslint-disable-next-line no-unused-vars
    initialize(registry, store) {
		...
        // Slash CommandãŒã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã•ã‚Œã‚‹å‰ã«å®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†ã‚’è¿½åŠ ã™ã‚‹
        registry.registerSlashCommandWillBePostedHook(
            (message, args) => {
                console.log(message);
                if (message.startsWith('/away')) {
                    return {error: {message: 'rejected'}};
                }
                if (message.startsWith('/help')) {
                    console.log('help');
                    return {message: '/shrug converted from help command', args};
                }
                if (message.startsWith('/leave')) {
                    console.log('leave');
                    return {};
                }
            }
        );
    }
}
```

### [registerMessageWillFormatHook](https://developers.mattermost.com/extend/plugins/webapp/reference/#registerMessageWillFormatHook)

`registerMessageWillFormatHook`ã¯ã€æŠ•ç¨¿ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒ Markdown ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦å¤‰æ›ã•ã‚Œã‚‹ç›´å‰ã«å®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†ã‚’ç™»éŒ²ã—ã¾ã™ã€‚

`registerMessageWillFormatHook`ã¯ã€å¼•æ•°ã‚’ 1 ã¤å–ã‚Šã¾ã™ã€‚

- `hook`: æŠ•ç¨¿ãŒ Markdown ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦å¤‰æ›ã•ã‚Œã‚‹ç›´å‰ã«å®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†

`hook`ã¯ã€å¼•æ•°ã‚’ 2 ã¤å–ã‚Šã¾ã™ã€‚

- `post`: å¤‰æ›ã•ã‚Œã¦ã„ãªã„æŠ•ç¨¿æƒ…å ±
- `message`: æŠ•ç¨¿ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã«ã‚ˆã£ã¦å¤‰æ›ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ã‚ã‚Šï¼‰

`hook`ã®è¿”å´å€¤ã¨ã—ã¦è¿”ã•ã‚ŒãŸæ–‡å­—åˆ—ãŒæŠ•ç¨¿ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

`registerMessageWillBePostedHook`ã¯ã€æŠ•ç¨¿ãŒã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã•ã‚Œã‚‹å‰ã«æŠ•ç¨¿å†…å®¹ã‚’ç·¨é›†ã™ã‚‹ã‚‚ã®ã§ã—ãŸãŒã€ã“ã®`registerMessageWillFormatHook`ã¯ã€æŠ•ç¨¿ãŒã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ãƒ»ä¿å­˜ã•ã‚ŒãŸå¾Œã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹éš›ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç·¨é›†ã™ã‚‹ã‚‚ã®ã ã¨æ€ã‚ã‚Œã¾ã™ã€‚

è‰¯ã„åˆ©ç”¨æ–¹æ³•ãŒæ€ã„ã¤ã‹ãªã„ã®ã§ä¾‹ã¯çœç•¥ã—ã¾ã™ã€‚

### [registerFilePreviewComponent](https://developers.mattermost.com/extend/plugins/webapp/reference/#registerFilePreviewComponent)

`registerFilePreviewComponent`ã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã®ç‹¬è‡ªã® Component ã‚’ç™»éŒ²ã—ã¾ã™ã€‚

`registerFilePreviewComponent`ã¯ã€2 ã¤ã®é–¢æ•°ã‚’å¼•æ•°ã«å–ã‚Šã¾ã™ã€‚

- `override`: ç‹¬è‡ªã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ Component ã‚’ä½¿ç”¨ã™ã‚‹ã‹ã©ã†ã‹ã‚’æ±ºå®šã™ã‚‹ãŸã‚ã®é–¢æ•°ã€‚ä»¥ä¸‹ã® 2 ã¤ã‚’å¼•æ•°ã«å–ã‚Šã¾ã™ã€‚
- `component`: ãƒ•ã‚¡ã‚¤ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã® Component

`override`ã¯ã€å¼•æ•°ã‚’ 2 ã¤å–ã‚Šã¾ã™ã€‚

- `fileInfo`: ãƒ•ã‚¡ã‚¤ãƒ«ã®æƒ…å ±
- `post`: æŠ•ç¨¿ã®æƒ…å ±

`debug`ã§å§‹ã¾ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŒã¤æŠ•ç¨¿ã®æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹éš›ã«ã€ç‹¬è‡ªã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ä¾‹ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚

![](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day21/file-preview-component.gif)

```js:index.js
...
import CustomFilePreview from './components/custom_file_preview';
...
export default class Plugin {
    // eslint-disable-next-line no-unused-vars
    initialize(registry, store) {
		...
        // `debug`ã§å§‹ã¾ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŒã¤æŠ•ç¨¿ã®æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç‹¬è‡ªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹
        registry.registerFilePreviewComponent(
            (fileInfo, post) => { return post.message && post.message.startsWith('debug'); },
            CustomFilePreview
        );
    }
}
```

```js:components/custom_file_preview.jsx
import React from 'react';
import PropTypes from 'prop-types';

const {formatText, messageHtmlToComponent} = window.PostUtils;

const CustomFilePreviewComponent = ({fileInfo, post}) => {
    const formattedText = messageHtmlToComponent(formatText(post.message));

    return (
        <div style={{backgroundColor: '#ffcccc'}}>
            {formattedText}
            <pre>
                {JSON.stringify(fileInfo, null, 4)}
            </pre>
        </div>
    )
}

CustomFilePreviewComponent.propTypes = {
    fileInfo: PropTypes.object.isRequired,
    post: PropTypes.object.isRequired,
};

export default CustomFilePreviewComponent;
```

### [registerTranslations](https://developers.mattermost.com/extend/plugins/webapp/reference/#registerTranslations)

`registerTranslations`ã¯ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å†…ã§ä½¿ç”¨ã—ã¦ã„ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç¿»è¨³ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã—ã¾ã™ã€‚

`registerTranslations`ã¯ã€`locale`ã‚’å¼•æ•°ã«ã¨ã‚Šã€ãã®`locale`ã«å¯¾ã™ã‚‹ç¿»è¨³ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™é–¢æ•°ã‚’å¼•æ•°ã«å–ã‚Šã¾ã™ã€‚

RootModal å†…ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ—¥æœ¬èªã«ç¿»è¨³ã™ã‚‹ä¾‹ã‚’ä½œã£ã¦ã¿ã¾ã—ãŸãŒã€ã©ã†ã‚„ã‚‰ç¿»è¨³ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ãªã„æ¨¡æ§˜ï¼Ÿ

```js:index.js
...
import ja from 'i18n/';
...
export default class Plugin {
    // eslint-disable-next-line no-unused-vars
    initialize(registry, store) {
		...
        // ç¿»è¨³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç™»éŒ²ã™ã‚‹
        registry.registerTranslations((locale) => {
            switch (locale) {
            case 'en':
                return en;
            case 'ja':
                return ja;
            }
            return {};
        });
    }
}
```

```json:i18n/ja.json
{
    "rootModal.message": "ãƒ«ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«"
}
```

```js:components/root/root.jsx

import React from 'react';

import {FormattedMessage} from 'react-intl';

const Root = ({visible, close}) => {
    if (!visible) {
        return null;
    }

    const style = getStyle();

    return (
        <div
            style={style.backdrop}
            onClick={close}
        >
            <div style={style.modal}>
                <FormattedMessage
                    id='rootModal.message'
                    defaultMessage='Root Modal2'
                />
            </div>
        </div>
    );
};

Root.propTypes = {
    visible: PropTypes.bool.isRequired,
    close: PropTypes.func.isRequired,
};

const getStyle = () => ({
    backdrop: {
        position: 'absolute',
        display: 'flex',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        backgroundColor: 'rgba(0, 0, 0, 0.50)',
        zIndex: 2000,
        alignItems: 'center',
        justifyContent: 'center',
    },
    modal: {
        height: '300px',
        width: '500px',
        padding: '1em',
        color: 'black',
        backgroundColor: 'white',
    },
});

export default Root;
```

### [registerAdminConsolePlugin](https://developers.mattermost.com/extend/plugins/webapp/reference/#registerAdminConsolePlugin)

`registerAdminConsolePlugin`ã¯ã€AdminConsole(ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ³ã‚½ãƒ¼ãƒ«?)ã®å†…å®¹ã‚’ä¸Šæ›¸ãã™ã‚‹ãŸã‚ã®é–¢æ•°ã‚’ç™»éŒ²ã—ã¾ã™ã€‚

Mattermost å†…éƒ¨ã§ã®åˆ©ç”¨ãŒä¸»ç›®çš„ã§ã‚ã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã«ã‚ˆã‚‹ä½¿ç”¨ã¯æ¨å¥¨ã•ã‚Œã¦ã„ãªã„ã‚ˆã†ãªã®ã§ä¾‹ã¯çœç•¥ã—ã¾ã™ã€‚ï¼ˆä½¿ã„æ–¹ãŒã‚ˆãåˆ†ã‹ã‚‰ãªã„ï¼‰

### [unregisterAdminConsolePlugin](https://developers.mattermost.com/extend/plugins/webapp/reference/#unregisterAdminConsolePlugin)

`unregisterAdminConsolePlugin`ã¯ã€`registerAdminConsolePlugin`ã§ç™»éŒ²ã—ãŸã€€ AdminConsole ä¸Šæ›¸ãç”¨é–¢æ•°ã‚’ç™»éŒ²ã‹ã‚‰é™¤å¤–ã—ã¾ã™ã€‚
`registerAdminConsolePlugin`ãŒ Mattermost å†…éƒ¨ã§ã®åˆ©ç”¨ãŒä¸»ç›®çš„ã®ãŸã‚ã€ã“ã¡ã‚‰ã‚‚èª¬æ˜ã€ä¾‹ã¯çœç•¥ã—ã¾ã™ã€‚

### [registerAdminConsoleCustomSetting](https://developers.mattermost.com/extend/plugins/webapp/reference/#registerAdminConsoleCustomSetting)

`registerAdminConsoleCustomSetting`ã¯ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç”¨ã®è¨­å®šç”»é¢ã«ç‹¬è‡ªã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’è¿½åŠ ã—ã¾ã™ã€‚
ã“ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ API ã«ã¤ã„ã¦ã¯ã€å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®[Best Practices](https://developers.mattermost.com/extend/plugins/best-practices/#how-can-a-plugin-define-its-own-setting-type)ã®ãƒšãƒ¼ã‚¸ã«è©³ç´°ã«ã¾ã¨ã‚ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚

Mattermost Plugin ã§ã¯ã€ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®`settings_schema`ã¨ã„ã†é …ç›®ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å°‚ç”¨ã®è¨­å®šé …ç›®ã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

https://developers.mattermost.com/extend/plugins/manifest-reference/

![](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day21/admin-console-custom-settings-default.png)

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€ä¸‹è¨˜ã®`type`ã‚’æŒã¤è¨­å®šé …ç›®ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

- "bool": ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ (2 å€¤)
- "dropdown": ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼
- "generated": è‡ªå‹•ç”Ÿæˆãƒ†ã‚­ã‚¹ãƒˆ
- "radio": ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ (ä»»æ„)
- "text": ã‚¤ãƒ³ãƒ—ãƒƒãƒˆãƒœãƒƒã‚¯ã‚¹
- "longtext": è¤‡æ•°è¡Œãƒ†ã‚­ã‚¹ãƒˆ
- "number": æ•°å€¤å…¥åŠ›æ¬„
- "username":ãƒ¦ãƒ¼ã‚¶ãƒ¼åå…¥åŠ›æ¬„

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®`type`ä»¥å¤–ã®è¨­å®šé …ç›®ã‚’æŒ‡å®šã—ãŸã„å ´åˆã«`registerAdminConsoleCustomSetting`ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

`registerAdminConsoleCustomSetting`ã¯ã€3 ã¤ã®å¼•æ•°ã‚’å–ã‚Šã¾ã™ã€‚

- `key`: ä¸Šæ›¸ãã™ã‚‹è¨­å®šé …ç›®ã®`key`ã€‚`key`ã¯ã€ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã«è¨­å®šé …ç›®ã”ã¨ã«ä»»æ„ã§æŒ‡å®šã™ã‚‹å€¤ã§ã™ã€‚
- `component`: è¨­å®šç”»é¢ã«è¡¨ç¤ºã•ã‚Œã‚‹ Componentã€‚
- `options`: è¨­å®šé …ç›®ã®è¡¨ç¤ºæ–¹æ³•ã«ã¤ã„ã¦ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³
  - `showTitle`: `true`ã‚’æŒ‡å®šã—ãŸå ´åˆã€ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®`display_name`ãŒè¨­å®šé …ç›®ã®å·¦å´ã«è¡¨ç¤ºã•ã‚Œã¾ã™

ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã©ã‚’å…¥åŠ›ã™ã‚‹éš›ã«ã€å…¥åŠ›é …ç›®ã‚’ UI ä¸Šã«è¡¨ç¤ºã—ãªã„ã‚ˆã†ãªè¨­å®šé …ç›®ã‚’è¿½åŠ ã™ã‚‹ä¾‹ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚

![](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day21/admin-console-custom-settings.png)

```json:plugin.json
{
    ...
    "settings_schema": {
        "settings": [
            {
                "key": "SampleSetting",
                "display_name": "Sample Setings Value",
                "type": "text",
                "help_text": "Sample",
                "default": "sample"
            }
        ]
    }
}
```

```js:index.js
...
import CustomSettings from './components/custom_settings';
...
export default class Plugin {
    // eslint-disable-next-line no-unused-vars
    initialize(registry, store) {
		...
        // ç‹¬è‡ªã®è¨­å®šç”»é¢é …ç›®ã‚’è¿½åŠ ã™ã‚‹
        registry.registerAdminConsoleCustomSetting(
            'SampleSetting',
            CustomSettings,
            {showTitle: true}
        );
    }
}
```

```js:components/custom_settings.jsx
import React from 'react';
import PropTypes from 'prop-types';

const CustomSettingsComponent = ({helpText, id, onChange, value}) => {
    const handleChange = (e) => {
        onChange(id, e.target.value);
    }
    return (
        <div style={{backgroundColor: '#ffcccc'}}>
            <input
              type={'password'}
              value={value}
              onChange={handleChange}
            />
            <pre>
                {JSON.stringify(helpText.props, null, 4)}
            </pre>
        </div>
    )
}

CustomSettingsComponent.propTypes = {
    helpText: PropTypes.shape ({
        props: PropTypes.object,
    }),
    id: PropTypes.string,
    onChange: PropTypes.func,
    value: PropTypes.any,
};

export default CustomSettingsComponent;
```

### [registerRightHandSidebarComponent](https://developers.mattermost.com/extend/plugins/webapp/reference/#registerRightHandSidebarComponent)

`registerRightHandSidebarComponent`ã¯ã€Mattermost ã®å³ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«è¡¨ç¤ºã™ã‚‹ç‹¬è‡ªã® Component ã‚’ç™»éŒ²ã—ã¾ã™ã€‚

`registerRightHandSidebarComponent`ã¯ã€2 ã¤ã®å¼•æ•°ã‚’å–ã‚Šã¾ã™ã€‚

- `component`: å³ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«è¡¨ç¤ºã•ã‚Œã‚‹ Component
- `title`: å³ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ã‚¿ã‚¤ãƒˆãƒ«éƒ¨åˆ†ã«è¡¨ç¤ºã•ã‚Œã‚‹ãƒ†ã‚­ã‚¹ãƒˆ

ã¾ãŸã€`registerRightHandSidebarComponent`ã¯ 4 ã¤ã®å¼•æ•°ã‚’è¿”å´ã—ã¾ã™ã€‚

- `id`: ç™»éŒ²ã•ã‚ŒãŸ Component ã® ID
- `showRHSPlugin`: ç™»éŒ²ã—ãŸ Component ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
- `hideRHSPlugin`: ç™»éŒ²ã—ãŸ Component ã‚’éè¡¨ç¤ºã«ã™ã‚‹ãŸã‚ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
- `toggleRHSPlugin`: ç™»éŒ²ã—ãŸ Component ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

ç™»éŒ²ã—ãŸ Component ã¯ã€ä»–ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ API ã‹ã‚‰`shorRHSPlugin`ã€`hideRHSPlugin`ã€`toggleRHSPlugin`ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚`RHS`ã¯`RightHandSideber`ã®ç•¥ã§ã™ã€‚

å³ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«ç‹¬è‡ªã® Component ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«è¿½åŠ ã™ã‚‹ä¾‹ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚

![](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day21/right-hand-sidebar.gif)

```js:index.js
...
import CustomRightHandSideber from './components/custom_rhs';
...
export default class Plugin {
    // eslint-disable-next-line no-unused-vars
    initialize(registry, store) {
		...
        // å³ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«è¡¨ç¤ºã•ã‚Œã‚‹ç‹¬è‡ªComponentã‚’ç™»éŒ²ã™ã‚‹
        const {toggleRHSPlugin} = registry.registerRightHandSidebarComponent(CustomRightHandSideber, "Sample RHS")
        // å³ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ ã™ã‚‹
        registry.registerMainMenuAction(
            'Open RHS',
            () => store.dispatch(toggleRHSPlugin),
            () => (<i/>)
        );
    }
}
```

```js:components/custom_rhs.jsx
import React from 'react';
import PropTypes from 'prop-types';

const ComponentRightHandSidebar = ({theme}) => {
    return (
        <div style={{backgroundColor: '#ffcccc'}}>
            <pre>
                {JSON.stringify(theme, null, 4)}
            </pre>
        </div>
    )
}

ComponentRightHandSidebar.propTypes = {
    PluggableId: PropTypes.string.isRequired,
    theme: PropTypes.object.isRequired,
};

export default ComponentRightHandSidebar;
```

### [registerNeedsTeamRoute](https://developers.mattermost.com/extend/plugins/webapp/reference/#registerNeedsTeamRoute)

`registerNeedsTeamRoute`ã¯ã€ãƒãƒ¼ãƒ ã”ã¨ã«ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å°‚ç”¨ã® Route ã‚’è¿½åŠ ã—ã¾ã™ã€‚ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å°‚ç”¨ã®ã‚¨ãƒ©ãƒ¼ç”»é¢ã‚’ä½œæˆã—ãŸã„å ´åˆãªã©ã«ä½¿ç”¨ã™ã‚‹ã‚‚ã®ã ã¨æ€ã„ã¾ã™ã€‚

`registerNeedsTeamRoute`ã¯ã€2 ã¤ã®å¼•æ•°ã‚’å–ã‚Šã¾ã™ã€‚

- `route`: ãƒ«ãƒ¼ãƒˆæ–‡å­—åˆ—
- `comopnent`: `route`ã«ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚ŒãŸéš›ã«å‘¼ã³å‡ºã•ã‚Œã‚‹ Component

`http://localhost:8065`ã§ Mattermost ãŒèµ·å‹•ã—ã¦ã„ã¦ã€`test`ã¨ã„ã†ãƒãƒ¼ãƒ åã®ãƒãƒ¼ãƒ ãŒã‚ã‚Šã€`sample.plugin`ã¨ã„ã†ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ ID ã‚’æŒã¤ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ãŠã‚Šã€ãã®ä¸­ã§`registerNeedsTeamRoute`ã®å¼•æ•°ã¨ã—ã¦`route="/subpath"`ãŒæŒ‡å®šã•ã‚Œã¦ã„ãŸå ´åˆã€`http://localhost:8065/test/sample.plugin/subpath`ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€`component`ã«æŒ‡å®šã—ãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒå‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚

ä»¥ä¸‹ã«ä¾‹ã‚’ç¤ºã—ã¾ã™ã€‚

![](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day21/needs-team-route.gif)

```js:index.js
...
import CustomTeamRoute from './components/custom_team_route';
...
export default class Plugin {
    // eslint-disable-next-line no-unused-vars
    initialize(registry, store) {
		...
        // ç‹¬è‡ªã®Routeã‚’è¿½åŠ ã™ã‚‹
        registry.registerNeedsTeamRoute('/', CustomTeamRoute)
    }
}
```

```js:components/custom_team_route.jsx
import React from 'react';
import PropTypes from 'prop-types';

import {Switch, Route} from 'react-router-dom';
import {getCurrentTeam} from 'mattermost-redux/selectors/entities/teams';
import {useSelector} from 'react-redux';

import {id} from 'src/manifest';

const CustomTeamRouteComponent = () => {
    const currentTeam = useSelector(getCurrentTeam);
    return (
        <Switch>
            <Route path={`/${currentTeam.name}/${id}/error`}>
                <h3>{'This is error page!'}</h3>
                <p>
                    <a href={`/${currentTeam.name}`}>Back to Top</a>
                </p>
            </Route>
            <Route>
                <h3>{'404 Not Found'}</h3>
                <p>
                    <a href={`/${currentTeam.name}`}>Back to Top</a>
                </p>
            </Route>
        </Switch>
    )
}

CustomTeamRouteComponent.propTypes = {
    pluggableId: PropTypes.object.isRequired,
    theme: PropTypes.object.isRequired,
};

export default CustomTeamRouteComponent;
```

### [registerCustomRoute](https://developers.mattermost.com/extend/plugins/webapp/reference/#registerCustomRoute)

`registerCustomRoute`ã¯ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å°‚ç”¨ã® Route ã‚’è¿½åŠ ã—ã¾ã™ã€‚

`registerNeedsTeamRoute`ã¯ã€`/${team_name}/${plugin_id}/${route}`ã®ã‚ˆã†ã«ãƒãƒ¼ãƒ ã”ã¨ã« Route ã‚’è¿½åŠ ã™ã‚‹ API ã§ã—ãŸãŒã€`registerCustomRoute`ã¯`/plug/${plugin_id}/${route}`ã®ã‚ˆã†ã«ã€Mattermost å…¨ä½“ã¨ã—ã¦ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã”ã¨ã«ä¸€ã¤ã® Route ã‚’è¿½åŠ ã™ã‚‹ API ã§ã™ã€‚

ä½¿ã„æ–¹ã¯`registerNeedsTeamRoute`ã¨ã»ã¼åŒã˜ã®ãŸã‚ã€ä¾‹ã¯çœç•¥ã—ã¾ã™ã€‚

## ãã®ä»–

Mattermost Plugin Webapp é–‹ç™ºä¸­ã«ä½¿ãˆã‚‹ Plugin é–‹ç™ºç”¨ã®ä¾¿åˆ©æ©Ÿèƒ½ãŒã„ãã¤ã‹ã‚ã‚Šã¾ã™ã€‚ãã®æ¦‚è¦ã ã‘ç´¹ä»‹ã—ã¾ã™ã€‚

### [Theme](https://developers.mattermost.com/extend/plugins/webapp/reference/#theme)

Mattermost Plugin API ã®ä¸­ã§ã‚‚ä½•åº¦ã‹å‡ºã¦ãã¾ã—ãŸãŒã€Webapp Plugin ã§ã¯ Mattermost ã®ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã‚’å‚ç…§ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚Mattermost ã§ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ãŸã‚ã€Webapp Plugin ã§ UI ã®è‰²ã‚’æŒ‡å®šã™ã‚‹å ´åˆã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«è¦‹ãˆæ–¹ãŒç•°ãªã‚‹ã“ã¨ã‚’è€ƒæ…®ã«å…¥ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

å‚è€ƒ: [Mattermost ã®ãƒ†ãƒ¼ãƒé›† \- Qiita](https://qiita.com/kaakaa_hoe/items/45c8857589ccd822ab1a)

Mattermost ã§æ‰±ã‚ã‚Œã‚‹ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ä¸€è¦§ã¯ä»¥ä¸‹ã§ç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã™ã€‚

https://developers.mattermost.com/extend/plugins/webapp/reference/#theme

### [Exported Libraries and Functions](https://developers.mattermost.com/extend/plugins/webapp/reference/#exported-libraries-and-functions)

Mattermost Webapp Plugin ã¯ React.js ã‚’ä½¿ç”¨ã—ã¦é–‹ç™ºã—ã¾ã™ãŒã€React é–‹ç™ºã«ã‚ˆãä½¿ã‚ã‚Œã‚‹ã„ãã¤ã‹ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ Mattermost æœ¬ä½“ã‹ã‚‰`window`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä»‹ã—ã¦å–å¾—ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚
å–å¾—ã§ãã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ä»¥ä¸‹ã§ç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã™ã€‚

https://developers.mattermost.com/extend/plugins/webapp/reference/#exported-libraries-and-functions

ã¾ãŸã€`window`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰å‚ç…§ã§ãã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã—ã¦`window.PostUtils`ã¨ã„ã†ã®ãŒã‚ã‚Šã¾ã™ãŒã€ã“ã‚Œã¯ Mattermost ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ‰±ã†ãŸã‚ã®ä¾¿åˆ©é–¢æ•°ã‚’æŒã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚

ä»¥ä¸‹ã®ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã€@ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãªã©ã‚’å«ã‚€ Markdown ãƒ†ã‚­ã‚¹ãƒˆ(`text`)ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã—ã¦æ‰±ã†ã“ã¨ãŒã§ãã¾ã™ã€‚

```js
const { formatText, messageHtmlToComponent } = window.PostUtils;

const text = "...";
const formattedText = messageHtmlToComponent(formatText(text));
```

https://developers.mattermost.com/extend/plugins/webapp/reference/#post-utils

### [Redux Action](https://developers.mattermost.com/extend/plugins/webapp/actions/))

Webapp ä¸Šã§æŠ•ç¨¿ã‚„ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ãªã©ã® Mattermost ã«å¯¾ã™ã‚‹ä½•ã‹ã—ã‚‰ã®å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹å ´åˆã€[mattermost-redux](https://github.com/mattermost/mattermost-redux)ã¨ã„ã† Redux ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ Mattermost æœ¬ä½“ã® Webapp ã§ã‚‚åˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹å…¬å¼ã® Javascript API ã®ã‚ˆã†ãªä½ç½®ä»˜ã‘ã®ã‚‚ã®ã§ã™ã€‚

mattermost-redux ã¯ã‚‚ã¡ã‚ã‚“ Mattermost Plugin é–‹ç™ºã§ã‚‚ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã€ä¸‹è¨˜ã®ãƒšãƒ¼ã‚¸ã§ä½¿ã„æ–¹ã«ã¤ã„ã¦ç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã™ã€‚

https://developers.mattermost.com/extend/plugins/webapp/actions/


## Mattermost Plugin ã®ãƒ†ã‚¹ãƒˆ

### Server å´ã®ãƒ†ã‚¹ãƒˆ

Mattermost Plugin ã® Server å´ã®æ©Ÿèƒ½ã‚’ Mattermost ã‚’å®Ÿéš›ã«èµ·å‹•ã™ã‚‹ã“ã¨ãªããƒ†ã‚¹ãƒˆã™ã‚‹ã«ã¯ã€[`plugintest`](https://github.com/mattermost/mattermost-server/tree/master/plugin/plugintest)ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

[`plugintest`](https://github.com/mattermost/mattermost-server/tree/master/plugin/plugintest)ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¦ãƒ†ã‚¹ãƒˆã‚’è¨˜è¿°ã—ã¦ã„ãæ–¹æ³•ã«ã¤ã„ã¦ã€Mattermost æœ¬ä½“ã«ã‚ã‚‹[ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰](https://github.com/mattermost/mattermost-server/blob/5122b9e2929dbf84e22f496ee97d007fa18f2d2e/plugin/plugintest/example_hello_user_test.go)ã‚’å…ƒã«ç´¹ä»‹ã—ã¾ã™ã€‚Matterpoll ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚‚å¤§éƒ¨åˆ†ã¯ã“ã‚Œã¨åŒã˜æ–¹å¼ã§ãƒ†ã‚¹ãƒˆãŒè¨˜è¿°ã•ã‚Œã¦ã„ã¾ã™ã€‚

```go:plugin/plugintest/example_hello_user_test.go
...
type HelloUserPlugin struct {
	plugin.MattermostPlugin
}

func (p *HelloUserPlugin) ServeHTTP(context *plugin.Context, w http.ResponseWriter, r *http.Request) {
	userID := r.Header.Get("Mattermost-User-Id")
	user, err := p.API.GetUser(userID)
	if err != nil {
		w.WriteHeader(http.StatusBadRequest)
		p.API.LogError(err.Error())
		return
	}

	fmt.Fprintf(w, "Welcome back, %s!", user.Username)
}
...
```

[https://github.com/mattermost/mattermost-server/blob/5122b9e2929dbf84e22f496ee97d007fa18f2d2e/plugin/plugintest/example_hello_user_test.go#L21](https://github.com/mattermost/mattermost-server/blob/5122b9e2929dbf84e22f496ee97d007fa18f2d2e/plugin/plugintest/example_hello_user_test.go#L21)

Mattermost ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®æœ¬ä½“ã¯ã€`plugin.MattermostPlugin`ãŒ embedded ã•ã‚ŒãŸæ§‹é€ ä½“ã§ã™ã€‚ã“ã“ã§ã¯ã€`HelloUserPlugin` æ§‹é€ ä½“ãŒãã‚Œã«ã‚ãŸã‚Šã¾ã™ã€‚ã“ã®æ§‹é€ ä½“ã‚’é€šã˜ã¦ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç”¨ã® API ã‚’å®Ÿè¡Œã—ãŸã‚Šã€Hook ã¨ãªã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…ã—ãŸã‚Šã™ã‚‹ã“ã¨ã§ã€ã‚µãƒ¼ãƒãƒ¼å´ã®å‹•ä½œã‚’å®šç¾©ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚`HelloUserPlugin` ã§ã¯ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç‹¬è‡ªã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ ã™ã‚‹ [`ServeHTTP`](<[https://developers.mattermost.com/extend/plugins/server/reference/#Hooks.ServeHTTP](https://developers.mattermost.com/extend/plugins/server/reference/#Hooks.ServeHTTP)>) Hooks ãŒå®Ÿè£…ã•ã‚Œã€ãã®å‡¦ç†ã®ä¸­ã§ `GetUser` API ã‚’å®Ÿè¡Œã—ã¦ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ã‚’å–å¾—ã—ã€ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ã—ã¦è¿”ã—ã¦ã„ã¾ã™ã€‚

ã“ã®`ServeHTTP` Hooks ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹å ´åˆã€å˜ã«`HelloUserPlugin`æ§‹é€ ä½“ã‚’ç”Ÿæˆã—ã¦`ServeHTTP`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè¡Œã—ãŸã ã‘ã ã¨ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ API (`GetUser`) ã®å®Ÿè¡Œéƒ¨åˆ†ã§å®Ÿéš›ã® Mattermost ã‚µãƒ¼ãƒãƒ¼ã®æ©Ÿèƒ½ã‚’å‘¼ã³å‡ºãã†ã¨ã—ã¦ã—ã¾ã„ã‚¨ãƒ©ãƒ¼ã¨ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚

```go
	user, err := p.API.GetUser(userID)
```

`HelloUserPlugin` ã® `API` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ã€`plugin.MattermostPlugin` æ§‹é€ ä½“ãŒæŒã£ã¦ã„ãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ã‚ã‚Šã€ã“ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’é€šã—ã¦å‘¼ã³å‡ºã•ã‚Œã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã¯ Mattermost ã‚µãƒ¼ãƒãƒ¼ã®å‡¦ç†ã«ä¾å­˜ã—ã¦ã„ã‚‹ã‹ã‚‰ã§ã™ã€‚Mattermost ã‚µãƒ¼ãƒãƒ¼ãŒãªã„çŠ¶æ…‹ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹å ´åˆã€ã“ã®`API`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å…¥ã‚Œæ›¿ãˆã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã“ã§ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç”¨ã®ãƒ†ã‚¹ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ã¨ã—ã¦å®šç¾©ã•ã‚Œã¦ã„ã‚‹ [`Example`](https://github.com/mattermost/mattermost-server/blob/5122b9e2929dbf84e22f496ee97d007fa18f2d2e/plugin/plugintest/example_hello_user_test.go#L37) ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ã¿ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```go
...
func Example() {
	t := &testing.T{}
	user :&model.User{                           ... (1)
		Id:       model.NewId(),
		Username: "billybob",
	}

	api := &plugintest.API{}                       ... (2)
	api.On("GetUser", user.Id).Return(user, nil)   ... (3)
	defer api.AssertExpectations(t)                ... (4)

	helpers := &plugintest.Helpers{}
	defer helpers.AssertExpectations(t)

	p := &HelloUserPlugin{}
	p.SetAPI(api)                                  ... (5)
	p.SetHelpers(helpers)

	w := httptest.NewRecorder()
	r := httptest.NewRequest("GET", "/", nil)
	r.Header.Add("Mattermost-User-Id", user.Id)
	p.ServeHTTP(&plugin.Context{}, w, r)           ... (6)
	body, err := ioutil.ReadAll(w.Result().Body)
	require.NoError(t, err)
	assert.Equal(t, "Welcome back, billybob!", string(body))
}
```

[https://github.com/mattermost/mattermost-server/blob/5122b9e2929dbf84e22f496ee97d007fa18f2d2e/plugin/plugintest/example_hello_user_test.go#L37](https://github.com/mattermost/mattermost-server/blob/5122b9e2929dbf84e22f496ee97d007fa18f2d2e/plugin/plugintest/example_hello_user_test.go#L37)

**(2)**ã§ `plugintest.API` ã¨ã„ã†æ§‹é€ ä½“ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆã—ã€ç”Ÿæˆã•ã‚ŒãŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³æ§‹é€ ä½“ `HelloUserPlugin` ã¸ `SetAPI` é–¢æ•°ã‚’é€šã˜ã¦ã‚»ãƒƒãƒˆ **(5)** ã—ã¦ã„ã¾ã™ã€‚ `plugintest.API`è‡ªä½“ã¯ã€ãã®ã¾ã¾ã§ã¯ä½•ã‚‚å‡¦ç†ã‚’è¡Œã‚ãªã„ãŸã‚ã€`api.On` ã§ç‰¹å®šã®å¼•æ•°ãŒä¸ãˆã‚‰ã‚ŒãŸæ™‚ã®å‡¦ç†ã‚’ãƒ†ã‚¹ãƒˆå´ã§å®Ÿè£…ã—ã¦ã„ã¾ã™ **(3)**ã€‚

```go
    ...
	user :&model.User{                           ... (1)
		Id:       model.NewId(),
		Username: "billybob",
	}
	...
    api.On("GetUser", user.Id).Return(user, nil)   ... (3)
	defer api.AssertExpectations(t)                ... (4)
	...
```

ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã®å ´åˆã€`user.Id` ã‚’å¼•æ•°ã¨ã—ã¦ `GetUser` ãƒ¡ã‚½ãƒƒãƒ‰ãŒå‘¼ã³å‡ºã•ã‚ŒãŸå ´åˆã« **(1)** ã§å®šç¾©ã•ã‚ŒãŸ `user` ã‚’è¿”å´ã™ã‚‹ã‚ˆã†ãƒ¢ãƒƒã‚¯ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚ã¾ãŸã€`defer api.AssertExpectations(t)` **(4)** ã‚’æ›¸ã„ã¦ãŠãã“ã¨ã§ã€ãƒ†ã‚¹ãƒˆå®Ÿè¡ŒãŒçµ‚äº†ã—ãŸæ™‚ã« `api.On` ã§å®šç¾©ã—ãŸãƒ¢ãƒƒã‚¯ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ãªã‹ã£ãŸå ´åˆã«ãƒ†ã‚¹ãƒˆã‚’å¤±æ•—ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

`HelloUserPlugin` ã§ã¯ [`Helpers`](<[https://developers.mattermost.com/extend/plugins/server/reference/#Helpers](https://developers.mattermost.com/extend/plugins/server/reference/#Helpers)>)é–¢æ•°ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã›ã‚“ã§ã—ãŸãŒã€`Helpers`ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹å ´åˆã‚‚ `API` ã¨åŒæ§˜ã«é–¢æ•°ã‚’ãƒ¢ãƒƒã‚¯ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

æœ€å¾Œã« `httptest` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ã£ã¦ `ServeHTTP` Hook ã‚’å‘¼ã³å‡ºã—ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒæƒ³å®šé€šã‚Šã§ã‚ã‚‹ã“ã¨ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ã¾ã™ã€‚

```go
	w := httptest.NewRecorder()
	r := httptest.NewRequest("GET", "/", nil)
	r.Header.Add("Mattermost-User-Id", user.Id)
	p.ServeHTTP(&plugin.Context{}, w, r)           ... (6)
```

ã“ã®ã‚ˆã†ã« `plugintest` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ã†ã“ã¨ã§ ã€Mattermost ã‚µãƒ¼ãƒãƒ¼ãŒãªã„çŠ¶æ³ã§ã‚‚ Mattermost ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®å‡¦ç†ã‚’ãƒ†ã‚¹ãƒˆã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ã‚ã¨ã¯ã€ã¨ã«ã‹ããƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç¶²ç¾…ã™ã‚‹ã‚±ãƒ¼ã‚¹ã‚’æ›¸ãå‡ºã™ã ã‘ã§ã™ã€‚ç­‹åŠ›ã§ã™ã€‚

### Server å´ã®ãƒ†ã‚¹ãƒˆ(Store)

Matterpoll ã§ã¯ Mattermost Plugin ã® Key Value ã‚¹ãƒˆã‚¢ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’æŠ½è±¡åŒ–ã—ãŸ `store` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ç”¨æ„ã—ã¦ã„ã¾ã™ã€‚ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§ Key Value ã‚¹ãƒˆã‚¢ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦ãªå‡¦ç†ãŒã‚ã£ãŸå ´åˆã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ API ã® `KVSet`ã€`KVGet` ãªã©ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ `plugintest` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ãƒ¢ãƒƒã‚¯ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ãŒã€ãƒ†ã‚¹ãƒˆè¨˜è¿°ãŒç…©é›‘ã«ãªã‚‹ãŸã‚ã€Matterpoll ã§ã¯ [vektra/mockery](<[https://github.com/vektra/mockery](https://github.com/vektra/mockery)>) ã‚’ä½¿ã£ã¦ `store.Store` ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã‹ã‚‰ãƒ¢ãƒƒã‚¯ã‚’ç”Ÿæˆã—ã¦ãƒ†ã‚¹ãƒˆã‚’è¨˜è¿°ã—ã¦ã„ã¾ã™ã€‚ã“ã® [vektra/mockery](<[https://github.com/vektra/mockery](https://github.com/vektra/mockery)>) ã¯ã€Mattermost æœ¬ä½“ã® `plugintest` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ç”Ÿæˆã™ã‚‹ã®ã«ã‚‚ä½¿ã‚ã‚Œã¦ã„ã‚‹ã‚‚ã®ã§ã™ã€‚

### Webapp å´ã®ãƒ†ã‚¹ãƒˆ

ã“ã“ã«ã¤ã„ã¦ã¯ã€Mattermost Plugin ç‰¹æœ‰ã®ãƒˆãƒ”ãƒƒã‚¯ã¨ã„ã†ã‚‚ã®ã¯ãªãã€é–‹ç™ºã—ãŸ React Component ã«å¯¾ã—ã¦[`Jest`](<[https://jestjs.io/](https://jestjs.io/ja/)>) ã‚’ä½¿ã£ãŸ snapshot ãƒ†ã‚¹ãƒˆã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

### CI

CI ã¯ CircleCI ã‚’ä½¿ã£ã¦ãŠã‚Šã€Mattermost ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç”¨ã® CircleCI Orb ã‚’ä½¿ã£ã¦ lint / build/ coverage / deploy ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

[https://github.com/matterpoll/matterpoll/blob/master/.circleci/config.yml](https://github.com/matterpoll/matterpoll/blob/master/.circleci/config.yml)

ã‚«ãƒãƒ¬ãƒƒã‚¸ã¯ [Codecov](https://codecov.io/gh/matterpoll/matterpoll) ã«ã‚ˆã‚‹ PR ã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å®Ÿæ–½ã—ã¦ã„ã¾ã™ã€‚

![](https://blog.kaakaa.dev/images/posts/advent-calendar-2020/day24/codecov/png)

## Checks

é™çš„è§£æç³»ã®ãƒ„ãƒ¼ãƒ«ã¯ Mattermost ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒª [mattermost/mattermost\-plugin\-starter\-template: Build scripts and templates for writing Mattermost plugins\.](https://github.com/mattermost/mattermost-plugin-starter-template) ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã¨ãƒ™ãƒ¼ã‚¹ã¯åŒã˜ã§ã€æ¡ç”¨ã—ã¦ã„ã‚‹ linter ã‚„ãƒ«ãƒ¼ãƒ«ãŒå°‘ã—ç•°ãªã‚‹ã¨ã„ã†æ„Ÿã˜ã§ã™ã€‚

ã‚µãƒ¼ãƒãƒ¼å´ã¯ [golangci-lint](https://github.com/golangci/golangci-lint) ã‚’ä½¿ã£ã¦ãŠã‚Šè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¸‹è¨˜ã®é€šã‚Šã§ã™ã€‚

```yml:.golangci.yml
run:
  timeout: 5m
  modules-download-mode: readonly

linters-settings:
  goconst:
    min-len: 2
    min-occurrences: 2
  gofmt:
    simplify: true
  goimports:
    local-prefixes: github.com/matterpoll/matterpoll
  golint:
    min-confidence: 0.0
  govet:
    check-shadowing: true
    enable-all: true
  misspell:
    locale: US
  maligned:
    suggest-new: true

linters:
  disable-all: true
  enable:
    - bodyclose
    - deadcode
    - dogsled
    - errcheck
    - goconst
    - gocritic
    - gofmt
    - goimports
    - golint
    - gosec
    - gosimple
    - govet
    - ineffassign
    - interfacer
    - maligned
    - misspell
    - nakedret
    - scopelint
    - staticcheck
    - structcheck
    - stylecheck
    - typecheck
    - unconvert
    - unparam
    - unused
    - varcheck
    - whitespace

issues:
  exclude-rules:
    # Exclude some linters from running on tests files.
    - path: _test\.go
      linters:
        - dupl
        - goconst
        - scopelint # https://github.com/kyoh86/scopelint/issues/4
```

[https://github.com/matterpoll/matterpoll/blob/d4ffdbfd6dcdea359b7419e0baa3ab8aaa32e420/.golangci.yml](https://github.com/matterpoll/matterpoll/blob/d4ffdbfd6dcdea359b7419e0baa3ab8aaa32e420/.golangci.yml)

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã¯ [ESLint](https://eslint.org/) ã‚’ä½¿ã£ã¦ãŠã‚Šã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¸‹è¨˜ã®é€šã‚Šã§ã™ã€‚ï¼ˆé•·ã„ãŸã‚ãƒªãƒ³ã‚¯å…ˆå‚ç…§ï¼‰

[https://github.com/matterpoll/matterpoll/blob/0b797025cfbf319c43464fcf457d4cdfe5086188/webapp/.eslintrc.json](https://github.com/matterpoll/matterpoll/blob/0b797025cfbf319c43464fcf457d4cdfe5086188/webapp/.eslintrc.json)

## ç¿»è¨³

Matterpoll ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ç¿»è¨³å¯èƒ½ãªå½¢å¼ã§ç®¡ç†ã•ã‚Œã¦ãŠã‚Šã€ç¾åœ¨ã€ä¸‹è¨˜ã®è¨€èªãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚

- English
- France
- German
- Japanese
- Korean
- Polish
- Simplified Chinese
- Spanish
- Traditional Chinese

è¨€èªã®åˆ‡ã‚Šæ›¿ãˆã¯ã€Mattermost æœ¬ä½“ã®è¨­å®šã«å¿œã˜ã¦å®Ÿæ–½ã•ã‚Œã¾ã™ã€‚

Mattermost Plugin ã«ãŠã‘ã‚‹ç¿»è¨³å‡¦ç†ã®è©³ç´°ã«ã¤ã„ã¦ã¯ã€Matterpoll ã®å…±åŒé–‹ç™ºè€…ã§ã‚ã‚‹ Hanzei ã«ã‚ˆã‚‹ä¸‹è¨˜ã®è¨˜äº‹ã§ç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã™ã€‚

[https://developers.mattermost.com/blog/localizing-matterpoll/](https://developers.mattermost.com/blog/localizing-matterpoll/)

### Server å´ã®ç¿»è¨³

Server å´ã®ç¿»è¨³æ©Ÿèƒ½ã¯[go-i18n](https://github.com/nicksnyder/go-i18n)ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚

ç¿»è¨³å¯¾è±¡ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã€ã‚³ãƒ¼ãƒ‰ä¸Šã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«`go-i18n`ã®`i18n`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®æ§‹é€ ä½“ã¨ã—ã¦æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚

```go:server/plugin/command.go
...
HelpText: p.LocalizeWithConfig(l, &i18n.LocalizeConfig{
	DefaultMessage: &i18n.Message{
		ID:    "dialog.createPoll.setting.multi",
		Other: "The number of options that an user can vote on.",
	}}),
...
```

[https://github.com/matterpoll/matterpoll/blob/45f095875a98fb1d4f3f166851c86f41b987493e/server/plugin/command.go#L265](https://github.com/matterpoll/matterpoll/blob/45f095875a98fb1d4f3f166851c86f41b987493e/server/plugin/command.go#L265)

å®Ÿéš›ã®ç¿»è¨³ã‚’è¡Œã†å ´åˆã¯ã€`go-i18n`ã®ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã£ã¦ã€ä¸Šè¨˜ã®ã‚ˆã†ãª`i18n`ã®æ§‹é€ ä½“ã¨ã—ã¦å®£è¨€ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ json ãƒ•ã‚¡ã‚¤ãƒ«ã«é›†ç´„ã—ã¾ã™ã€‚ãã®è¾ºã‚Šã®æ‰‹é †ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¾ã¨ã‚ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚

https://github.com/matterpoll/matterpoll/blob/master/CONTRIBUTING.md#translating-strings

`go-i18n`ã«ã‚ˆã£ã¦é›†ç´„ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å„å›½ã®ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚¿ã«ãƒ­ãƒ¼ã‚«ãƒ©ã‚¤ã‚ºã—ã¦ã‚‚ã‚‰ã†ã“ã¨ã§ã€ç¿»è¨³ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚
https://github.com/matterpoll/matterpoll/tree/45f095875a98fb1d4f3f166851c86f41b987493e/assets/i18n

### Webapp å´ã®ç¿»è¨³

Matterpoll Plugin ã§ã¯ã€ã¾ã  Webapp å´ã®ç¿»è¨³æ©Ÿèƒ½ã¯å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã›ã‚“ãŒã€Mattermost Plugin ã®æ©Ÿèƒ½ã¨ã—ã¦ã¯å®Ÿè£…ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

Webapp å´ã®ç¿»è¨³ã¯ã€[`react-intl`](https://www.npmjs.com/package/react-intl)ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚

```jsx
...
import {FormattedMessage} from 'react-intl';
...
        <FormattedMessage
            id='rootModal.message'
            defaultMessage='Root Modal2'
		/>
...
```

ä¸Šè¨˜ã®ã‚ˆã†ã«ã‚³ãƒ¼ãƒ‰å†…ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ç¿»è¨³å¯¾è±¡ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã€`make i18n-extract`ã§é›†ç´„ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```Makefile
...
## Extract strings for translation from the source code.
.PHONY: i18n-extract
i18n-extract:
ifneq ($(HAS_WEBAPP),)
ifeq ($(HAS_MM_UTILITIES),)
	@echo "You must clone github.com/mattermost/mattermost-utilities repo in .. to use this command"
else
	cd $(MM_UTILITIES_DIR) && npm install && npm run babel && node mmjstool/build/index.js i18n extract-webapp --webapp-dir $(PWD)/webapp
endif
endif
...
```

[https://github.com/matterpoll/matterpoll/blob/master/Makefile#L205](https://github.com/matterpoll/matterpoll/blob/master/Makefile#L205)

é›†ç´„ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ Mattermost Webapp Plugin API ã®[`registerTranslations`](https://developers.mattermost.com/extend/plugins/webapp/reference/#registerTranslations)ã§ç™»éŒ²ã™ã‚‹ã“ã¨ã§ã€Webapp å´ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç¿»è¨³ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
